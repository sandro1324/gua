<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>八字分析结果</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- 加载lunar.js库 -->
    <script src="../lunar-javascript/lunar.js" onerror="handleLunarLoadError()"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --wood: #27ae60;
            --fire: #e74c3c;
            --earth: #f1c40f;
            --metal: #95a5a6;
            --water: #2980b9;
            --background: #f8f9fa;
            --text: #2c3e50;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', '微软雅黑', sans-serif;
            background: var(--background);
            color: var(--text);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        /* 语言切换按钮样式 */
        .language-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .language-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .language-btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
        }
        
        .language-btn i {
            margin-right: 5px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .section h2 {
            margin-top: 0;
            color: var(--primary);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        /* 基本信息样式 */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .info-label {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--secondary);
        }

        .info-value {
            font-size: 18px;
        }

        /* 八字命盘样式 */
        .bazi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .bazi-pillar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
        }

        .bazi-pillar:hover {
            background: #eaeaea;
        }

        .pillar-label {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--secondary);
        }

        .pillar-value {
            font-size: 24px;
            font-weight: bold;
        }

        /* 五行分布样式 */
        .wuxing-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .wuxing-item {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
        }

        .wuxing-label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .wuxing-value {
            font-size: 20px;
            font-weight: bold;
        }

        .wuxing-bar {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }

        .wuxing-progress {
            height: 100%;
            width: 0%;
            transition: width 1s;
        }

        /* 各种五行颜色 */
        .mu {
            background: rgba(39, 174, 96, 0.2);
            color: var(--wood);
        }
        .mu .wuxing-progress {
            background: var(--wood);
        }

        .huo {
            background: rgba(231, 76, 60, 0.2);
            color: var(--fire);
        }
        .huo .wuxing-progress {
            background: var(--fire);
        }

        .tu {
            background: rgba(241, 196, 15, 0.2);
            color: var(--earth);
        }
        .tu .wuxing-progress {
            background: var(--earth);
        }

        .jin {
            background: rgba(149, 165, 166, 0.2);
            color: var(--metal);
        }
        .jin .wuxing-progress {
            background: var(--metal);
        }

        .shui {
            background: rgba(41, 128, 185, 0.2);
            color: var(--water);
        }
        .shui .wuxing-progress {
            background: var(--water);
        }

        /* 按钮样式 */
        .buttons {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }

        button {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
        }

        button:hover {
            background: var(--primary);
        }

        /* 错误消息样式 */
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            margin: -20px -20px 20px -20px;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            color: white;
        }

        .modal-title {
            font-weight: bold;
            font-size: 20px;
            color: white;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }
        
        .modal-close:hover {
            color: white;
            transform: scale(1.2);
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .detail-item label {
            font-weight: bold;
            color: var(--secondary);
        }
        
        .pillar-analysis {
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        /* 响应式布局 */
        @media (max-width: 600px) {
            .bazi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .wuxing-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* 神煞信息样式 */
        .shensha-good {
            color: #2ecc71;
            font-weight: bold;
        }
        
        .shensha-bad {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .detail-item span a {
            margin-left: 5px;
        }
        
        /* 分隔线样式 */
        .section-divider {
            height: 1px;
            background: linear-gradient(to right, transparent, var(--secondary), transparent);
            margin: 20px 0;
        }
        
        /* 生辰八字表格样式 */
        .bazi-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 16px;
        }
        
        .bazi-table th, .bazi-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid #eee;
        }
        
        .bazi-table th {
            background-color: var(--secondary);
            color: white;
            font-weight: normal;
        }
        
        .bazi-table .gan-row {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .bazi-table .zhi-row {
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .bazi-table .highlight {
            font-weight: bold;
            color: var(--primary);
        }
        
        /* 天干地支相关样式 */
        .gan-wood {
            color: var(--wood);
        }
        
        .gan-fire {
            color: var(--fire);
        }
        
        .gan-earth {
            color: var(--earth);
        }
        
        .gan-metal {
            color: var(--metal);
        }
        
        .gan-water {
            color: var(--water);
        }

        /* 文本居中 */
        .text-center {
            text-align: center;
        }
        
        /* 大运时间线样式 */
        .dayun-container {
            position: relative;
            margin: 30px 0;
            padding-bottom: 20px;
        }
        
        .dayun-timeline {
            position: relative;
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        
        .dayun-timeline::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
        }
        
        .dayun-item {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
            z-index: 1;
        }
        
        .dayun-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--secondary);
            margin-bottom: 10px;
            border: 3px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        
        .dayun-content {
            text-align: center;
        }
        
        .dayun-age {
            font-weight: bold;
            color: var(--primary);
        }
        
        .dayun-year {
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .dayun-ganzhi {
            font-weight: bold;
        }
        
        .dayun-current {
            background: var(--primary);
            transform: scale(1.3);
        }
        
        @media (max-width: 768px) {
            .dayun-timeline {
                overflow-x: auto;
                padding-bottom: 10px;
            }
            
            .dayun-item {
                min-width: 80px;
                margin-right: 10px;
            }
        }
        
        /* 五行详解样式 */
        .wuxing-analysis h3 {
            margin-top: 25px;
            margin-bottom: 15px;
            color: var(--primary);
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        
        .element-detail {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .element-detail p {
            margin-bottom: 10px;
        }
        
        .element-detail strong {
            color: var(--primary);
        }
        
        .element-detail ul {
            padding-left: 20px;
        }
        
        .element-detail li {
            margin-bottom: 8px;
        }
        
        .mt-4 {
            margin-top: 20px;
        }
        
        #personalized-advice {
            border-left: 4px solid var(--secondary);
            background: #f0f8ff;
        }
        
        /* 大运流年表样式 */
        .dayun-container {
            padding: 15px 0;
        }
        
        .dayun-flow-direction {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .flow-label {
            font-weight: bold;
            margin-right: 10px;
        }
        
        .flow-arrow {
            font-size: 1.5em;
            color: var(--secondary);
        }
        
        .dayun-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .dayun-table th, .dayun-table td {
            padding: 8px 12px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        .dayun-table th {
            background-color: var(--secondary);
            color: white;
        }
        
        .dayun-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .dayun-table tr:hover {
            background-color: #f0f8ff;
        }
        
        .current-dayun {
            background-color: rgba(52, 152, 219, 0.15) !important;
            font-weight: bold;
        }
        
        .current-dayun-highlight {
            color: var(--secondary);
            font-weight: bold;
        }
        
        .element-cell {
            font-weight: bold;
        }
        
        .element-wood {
            color: var(--wood);
        }
        
        .element-fire {
            color: var(--fire);
        }
        
        .element-earth {
            color: var(--earth);
        }
        
        .element-metal {
            color: var(--metal);
        }
        
        .element-water {
            color: var(--water);
        }
        
        .ganzhi-cell {
            font-weight: bold;
            font-size: 16px;
        }
        
        .dayun-help {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .dayun-explanation {
            margin-top: 15px;
        }
        
        .dayun-explanation h3 {
            margin-bottom: 10px;
            color: var(--primary);
            font-size: 16px;
        }
        
        .flow-year-section {
            margin-top: 30px;
        }
        
        .flow-year-section h3 {
            margin-bottom: 15px;
            color: var(--primary);
            font-size: 16px;
        }
        
        .flow-year-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .flow-year-item {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            background: #f9f9f9;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .flow-year-header {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .flow-year-ganzhi {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .flow-year-details {
            font-size: 0.9em;
            color: #666;
        }
        
        /* 大运详情模态框样式 */
        #dayun-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .dayun-modal-content {
            background-color: white;
            border-radius: 8px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .dayun-detail-header {
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .dayun-detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .detail-item {
            padding: 8px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        
        .detail-item label {
            font-weight: bold;
            margin-right: 8px;
            color: #555;
        }
        
        .section-divider {
            height: 1px;
            background-color: #eee;
            margin: 20px 0;
        }
        
        .dayun-analysis, .dayun-advice {
            margin-bottom: 20px;
        }
        
        .flow-years-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .flow-years-table th, .flow-years-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        
        .flow-years-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        .flow-years-table tr:hover {
            background-color: #f5f5f5;
        }
        
        /* 流年详情模态框样式 */
        #flowyear-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 20px;
        }

        .flowyear-modal-inner {
            background: white;
            border-radius: 10px;
            width: 100%;
            max-width: 800px;
            margin: auto;
            padding: 30px;
            position: relative;
        }

        .flowyear-content {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            padding-right: 15px;
        }

        .flowyear-basic-info {
            margin-bottom: 30px;
        }

        .info-section {
            margin-bottom: 20px;
        }

        .info-section h3 {
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .flowyear-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .analysis-text {
            line-height: 1.6;
            color: #333;
            margin-bottom: 20px;
        }

        .events-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .events-list {
            list-style-type: none;
            padding-left: 0;
        }

        .events-list li {
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .flowyear-lucky-events h4 {
            color: var(--wood);
        }

        .flowyear-challenges h4 {
            color: var(--fire);
        }
    </style>
</head>
<body>
    <!-- 语言切换按钮 -->
    <div class="language-toggle">
        <button id="languageToggle" class="language-btn">
            <i class="fas fa-language"></i> <span id="languageText">English</span>
        </button>
    </div>

    <div class="container" id="resultContainer">
        <h1>
            <span data-lang="zh">八字分析结果</span>
            <span data-lang="en" style="display: none;">BaZi Analysis Results</span>
        </h1>
        
        <div id="error-message" class="error" style="display: none;"></div>
        
        <div id="content">
            <div class="section">
                <h2><i class="fas fa-user"></i> <span data-lang="zh">基本信息</span><span data-lang="en" style="display: none;">Basic Information</span></h2>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">
                            <span data-lang="zh">姓名</span>
                            <span data-lang="en" style="display: none;">Name</span>
                        </div>
                        <div class="info-value" id="user-name">加载中...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">
                            <span data-lang="zh">性别</span>
                            <span data-lang="en" style="display: none;">Gender</span>
                        </div>
                        <div class="info-value" id="user-gender">加载中...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">
                            <span data-lang="zh">出生地</span>
                            <span data-lang="en" style="display: none;">Birth Place</span>
                        </div>
                        <div class="info-value" id="birth-place">加载中...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">
                            <span data-lang="zh">阳历</span>
                            <span data-lang="en" style="display: none;">Solar Calendar</span>
                        </div>
                        <div class="info-value" id="solar-date">加载中...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">
                            <span data-lang="zh">农历</span>
                            <span data-lang="en" style="display: none;">Lunar Calendar</span>
                        </div>
                        <div class="info-value" id="lunar-date">加载中...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">
                            <span data-lang="zh">生肖</span>
                            <span data-lang="en" style="display: none;">Zodiac</span>
                        </div>
                        <div class="info-value" id="shengxiao">加载中...</div>
                    </div>
                    <div class="info-item time-note" id="unknown-time-note" style="display: none; grid-column: 1 / -1; background-color: #fff3cd; color: #856404; border-left: 4px solid #ffc107;">
                        <div class="info-value">
                            <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                            <span data-lang="zh">时辰不确定，使用午时（11:00-13:00）推算，结果仅供参考</span>
                            <span data-lang="en" style="display: none;">Birth time is uncertain, using 11:00-13:00 for calculation, results are for reference only</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2><i class="fas fa-calendar"></i> <span data-lang="zh">八字命盘</span><span data-lang="en" style="display: none;">BaZi Chart</span></h2>
                <div class="bazi-grid">
                    <div class="bazi-pillar" onclick="showPillarDetail('year')">
                        <div class="pillar-label"><span data-lang="zh">年柱</span><span data-lang="en" style="display: none;">Year</span></div>
                        <div class="pillar-value" id="year-pillar">--</div>
                    </div>
                    <div class="bazi-pillar" onclick="showPillarDetail('month')">
                        <div class="pillar-label"><span data-lang="zh">月柱</span><span data-lang="en" style="display: none;">Month</span></div>
                        <div class="pillar-value" id="month-pillar">--</div>
                    </div>
                    <div class="bazi-pillar" onclick="showPillarDetail('day')">
                        <div class="pillar-label"><span data-lang="zh">日柱</span><span data-lang="en" style="display: none;">Day</span></div>
                        <div class="pillar-value" id="day-pillar">--</div>
                    </div>
                    <div class="bazi-pillar" onclick="showPillarDetail('hour')">
                        <div class="pillar-label"><span data-lang="zh">时柱</span><span data-lang="en" style="display: none;">Hour</span></div>
                        <div class="pillar-value" id="hour-pillar">--</div>
                    </div>
                </div>
                
                <!-- 生辰八字表格 -->
                <table class="bazi-table">
                    <thead>
                        <tr>
                            <th><span data-lang="zh">四柱</span><span data-lang="en" style="display: none;">Pillars</span></th>
                            <th><span data-lang="zh">年柱</span><span data-lang="en" style="display: none;">Year</span></th>
                            <th><span data-lang="zh">月柱</span><span data-lang="en" style="display: none;">Month</span></th>
                            <th><span data-lang="zh">日柱</span><span data-lang="en" style="display: none;">Day</span></th>
                            <th><span data-lang="zh">时柱</span><span data-lang="en" style="display: none;">Hour</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="gan-row">
                            <td><span data-lang="zh">天干</span><span data-lang="en" style="display: none;">Heavenly Stem</span></td>
                            <td id="table-year-gan">-</td>
                            <td id="table-month-gan">-</td>
                            <td id="table-day-gan">-</td>
                            <td id="table-hour-gan">-</td>
                        </tr>
                        <tr class="zhi-row">
                            <td><span data-lang="zh">地支</span><span data-lang="en" style="display: none;">Earthly Branch</span></td>
                            <td id="table-year-zhi">-</td>
                            <td id="table-month-zhi">-</td>
                            <td id="table-day-zhi">-</td>
                            <td id="table-hour-zhi">-</td>
                        </tr>
                        <tr>
                            <td>
                                <span data-lang="zh">藏干</span>
                                <span data-lang="en" style="display: none;">Hidden Stems</span>
                            </td>
                            <td id="table-year-canggan">-</td>
                            <td id="table-month-canggan">-</td>
                            <td id="table-day-canggan">-</td>
                            <td id="table-hour-canggan">-</td>
                        </tr>
                        <tr>
                            <td>
                                <span data-lang="zh">十神</span>
                                <span data-lang="en" style="display: none;">Ten Gods</span>
                            </td>
                            <td id="table-year-shishen">-</td>
                            <td id="table-month-shishen">-</td>
                            <td id="table-day-shishen">-</td>
                            <td id="table-hour-shishen">-</td>
                        </tr>
                        <tr>
                            <td>
                                <span data-lang="zh">纳音</span>
                                <span data-lang="en" style="display: none;">Hidden Element</span>
                            </td>
                            <td id="table-year-nayin">-</td>
                            <td id="table-month-nayin">-</td>
                            <td id="table-day-nayin">-</td>
                            <td id="table-hour-nayin">-</td>
                        </tr>
                    </tbody>
                </table>
                
                <p class="text-center">
    <small data-lang="zh">点击柱子查看详细解析</small>
    <small data-lang="en" style="display: none">Click on the pillar for detailed analysis</small>
</p>
            </div>
            
            <div class="section">
                <h2><i class="fas fa-balance-scale"></i> 
                    <span data-lang="zh">五行分布</span>
                    <span data-lang="en" style="display: none;">Five Elements Distribution</span>
                </h2>
                <div class="wuxing-grid">
                    <div class="wuxing-item mu">
                        <div class="wuxing-label">
                            <span data-lang="zh">木</span>
                            <span data-lang="en" style="display: none;">Wood</span>
                        </div>
                        <div class="wuxing-value" id="wuxing-mu">0%</div>
                        <div class="wuxing-bar">
                            <div class="wuxing-progress" id="mu-progress"></div>
                        </div>
                    </div>
                    <div class="wuxing-item huo">
                        <div class="wuxing-label">
                            <span data-lang="zh">火</span>
                            <span data-lang="en" style="display: none;">Fire</span>
                        </div>
                        <div class="wuxing-value" id="wuxing-huo">0%</div>
                        <div class="wuxing-bar">
                            <div class="wuxing-progress" id="huo-progress"></div>
                        </div>
                    </div>
                    <div class="wuxing-item tu">
                        <div class="wuxing-label">
                            <span data-lang="zh">土</span>
                            <span data-lang="en" style="display: none;">Earth</span>
                        </div>
                        <div class="wuxing-value" id="wuxing-tu">0%</div>
                        <div class="wuxing-bar">
                            <div class="wuxing-progress" id="tu-progress"></div>
                        </div>
                    </div>
                    <div class="wuxing-item jin">
                        <div class="wuxing-label">
                            <span data-lang="zh">金</span>
                            <span data-lang="en" style="display: none;">Metal</span>
                        </div>
                        <div class="wuxing-value" id="wuxing-jin">0%</div>
                        <div class="wuxing-bar">
                            <div class="wuxing-progress" id="jin-progress"></div>
                        </div>
                    </div>
                    <div class="wuxing-item shui">
                        <div class="wuxing-label">
                            <span data-lang="zh">水</span>
                            <span data-lang="en" style="display: none;">Water</span>
                        </div>
                        <div class="wuxing-value" id="wuxing-shui">0%</div>
                        <div class="wuxing-bar">
                            <div class="wuxing-progress" id="shui-progress"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2><i class="fas fa-lightbulb"></i> 
                    <span data-lang="zh">五行详解</span>
                    <span data-lang="en" style="display: none;">Five Elements Analysis</span>
                </h2>
                <div id="analysis-content">
                    <p>
                        <span data-lang="zh">根据您的八字命盘，以下是详细的五行分析和个性化建议：</span>
                        <span data-lang="en" style="display: none;">Based on your BaZi chart, here is the detailed Five Elements analysis and personalized advice:</span>
                    </p>
                    
                    <div class="wuxing-analysis">
                        <h3>
                            <span data-lang="zh">五行基础分析</span>
                            <span data-lang="en" style="display: none;">Basic Five Elements Analysis</span>
                        </h3>
                        <ul>
                            <li>
                                <span data-lang="zh">您的日主天干为</span><span data-lang="en" style="display: none;">Your Day Master is </span>
                                <span id="day-master">？</span>
                                <span data-lang="zh">，出生于</span><span data-lang="en" style="display: none;">, born in </span>
                                <span id="birth-season">？</span>
                                <span data-lang="zh">季。</span><span data-lang="en" style="display: none;"> season.</span>
                            </li>
                            <li>
                                <span data-lang="zh">五行中</span><span data-lang="en" style="display: none;">In the Five Elements, </span>
                                <span id="strong-element">？</span>
                                <span data-lang="zh">最为旺盛，</span><span data-lang="en" style="display: none;"> is the strongest, </span>
                                <span id="weak-element">？</span>
                                <span data-lang="zh">相对偏弱。</span><span data-lang="en" style="display: none;"> is relatively weak.</span>
                            </li>
                        </ul>
                        
                        <h3 class="mt-4" data-lang="zh">木属性详解 <span class="gan-wood">(木)</span></h3>
<h3 class="mt-4" data-lang="en" style="display: none;">Wood Element Analysis <span class="gan-wood">(Wood)</span></h3>
                        <div class="element-detail" data-lang="zh">
                            <p><strong>特性：</strong>生长、发展、创新、向上、仁爱</p>
                            <p><strong>优势：</strong>创造力强、有规划能力、善于沟通、重感情、有同情心</p>
                            <p><strong>建议：</strong>保持积极向上的心态，培养创新思维，注重人际关系的经营</p>
                            <p><strong>注意事项：</strong>避免过度固执己见，学会控制情绪，不要过于理想化</p>
                            <p><strong>健康关注：</strong>肝胆系统，避免情绪激动，保持适当运动和充足睡眠</p>
                        </div>
                        <div class="element-detail" data-lang="en" style="display: none;">
                            <p><strong>Characteristics:</strong> Growth, Development, Innovation, Upward, Benevolence</p>
                            <p><strong>Advantages:</strong> Strong Creativity, Planning Ability, Good Communication, Emotional, Empathetic</p>
                            <p><strong>Suggestions:</strong> Maintain a positive attitude, cultivate innovative thinking, focus on maintaining interpersonal relationships</p>
                            <p><strong>Precautions:</strong> Avoid being overly stubborn, learn to control emotions, don't be too idealistic</p>
                            <p><strong>Health Focus:</strong> Liver and gallbladder system, avoid emotional agitation, maintain proper exercise and adequate sleep</p>
                        </div>
                        
                        <h3 class="mt-4" data-lang="zh">火属性详解 <span class="gan-fire">(火)</span></h3>
<h3 class="mt-4" data-lang="en" style="display: none;">Fire Element Analysis <span class="gan-fire">(Fire)</span></h3>
                        <div class="element-detail" data-lang="zh">
                            <p><strong>特性：</strong>热情、活力、光明、向外、礼节</p>
                            <p><strong>优势：</strong>热情开朗、领导能力强、表达力佳、有感染力、善于社交</p>
                            <p><strong>建议：</strong>发挥热情和活力，参与社交活动，培养领导能力</p>
                            <p><strong>注意事项：</strong>避免情绪化决策，控制冲动，学会耐心倾听</p>
                            <p><strong>健康关注：</strong>心脏和血液循环，避免过度兴奋和劳累，保持情绪平和</p>
                        </div>
                        <div class="element-detail" data-lang="en" style="display: none;">
                            <p><strong>Characteristics:</strong> Enthusiasm, Vitality, Brightness, Outward, Etiquette</p>
                            <p><strong>Advantages:</strong> Enthusiastic and Cheerful, Strong Leadership, Good Expression, Influential, Sociable</p>
                            <p><strong>Suggestions:</strong> Express enthusiasm and vitality, participate in social activities, develop leadership skills</p>
                            <p><strong>Precautions:</strong> Avoid emotional decisions, control impulses, learn to listen patiently</p>
                            <p><strong>Health Focus:</strong> Heart and blood circulation, avoid over-excitement and fatigue, maintain emotional balance</p>
                        </div>
                        
                        <h3 class="mt-4" data-lang="zh">土属性详解 <span class="gan-earth">(土)</span></h3>
<h3 class="mt-4" data-lang="en" style="display: none;">Earth Element Analysis <span class="gan-earth">(Earth)</span></h3>
                        <div class="element-detail" data-lang="zh">
                            <p><strong>特性：</strong>稳定、包容、中正、诚信、踏实</p>
                            <p><strong>优势：</strong>责任感强、可靠踏实、为人诚信、做事有耐心、善于管理</p>
                            <p><strong>建议：</strong>保持稳定踏实的工作态度，培养管理能力，建立诚信形象</p>
                            <p><strong>注意事项：</strong>避免思虑过度，克服保守倾向，增强决断力</p>
                            <p><strong>健康关注：</strong>消化系统，保持饮食规律，避免过度思虑忧愁</p>
                        </div>
                        <div class="element-detail" data-lang="en" style="display: none;">
                            <p><strong>Characteristics:</strong> Stability, Inclusiveness, Balance, Integrity, Reliability</p>
                            <p><strong>Advantages:</strong> Strong Sense of Responsibility, Reliable, Trustworthy, Patient, Good at Management</p>
                            <p><strong>Suggestions:</strong> Maintain a stable and steady work attitude, develop management skills, build a trustworthy image</p>
                            <p><strong>Precautions:</strong> Avoid overthinking, overcome conservative tendencies, enhance decisiveness</p>
                            <p><strong>Health Focus:</strong> Digestive system, maintain regular eating habits, avoid excessive worry and anxiety</p>
                        </div>
                        
                        <h3 class="mt-4" data-lang="zh">金属性详解 <span class="gan-metal">(金)</span></h3>
<h3 class="mt-4" data-lang="en" style="display: none;">Metal Element Analysis <span class="gan-metal">(Metal)</span></h3>
                        <div class="element-detail" data-lang="zh">
                            <p><strong>特性：</strong>坚硬、刚毅、收敛、断决、公正</p>
                            <p><strong>优势：</strong>做事果断、有执行力、注重细节、讲求公平、组织能力强</p>
                            <p><strong>建议：</strong>发挥条理性和执行力，培养精确的工作方式，保持公正态度</p>
                            <p><strong>注意事项：</strong>避免过于苛刻，学会灵活变通，培养情感表达</p>
                            <p><strong>健康关注：</strong>呼吸系统和肺部健康，保持居所通风，避免接触过敏原</p>
                        </div>
                        <div class="element-detail" data-lang="en" style="display: none;">
                            <p><strong>Characteristics:</strong> Hardness, Determination, Restraint, Decisiveness, Justice</p>
                            <p><strong>Advantages:</strong> Decisive, Strong Execution, Detail-oriented, Fair-minded, Strong Organizational Skills</p>
                            <p><strong>Suggestions:</strong> Utilize systematic thinking and execution ability, cultivate precise work methods, maintain a fair attitude</p>
                            <p><strong>Precautions:</strong> Avoid being too harsh, learn to be flexible, develop emotional expression</p>
                            <p><strong>Health Focus:</strong> Respiratory system and lung health, maintain ventilation in living spaces, avoid allergens</p>
                        </div>
                        
                        <h3 class="mt-4" data-lang="zh">水属性详解 <span class="gan-water">(水)</span></h3>
<h3 class="mt-4" data-lang="en" style="display: none;">Water Element Analysis <span class="gan-water">(Water)</span></h3>
                        <div class="element-detail" data-lang="zh">
                            <p><strong>特性：</strong>智慧、灵活、流动、向下、通达</p>
                            <p><strong>优势：</strong>思维灵活、适应力强、善于沟通、学习能力强、有智慧</p>
                            <p><strong>建议：</strong>发挥智慧和适应力，培养学习能力，建立广泛人脉</p>
                            <p><strong>注意事项：</strong>避免优柔寡断，增强自信心，保持专注</p>
                            <p><strong>健康关注：</strong>肾脏和泌尿系统，避免过度劳累，保持温暖</p>
                        </div>
                        <div class="element-detail" data-lang="en" style="display: none;">
                            <p><strong>Characteristics:</strong> Wisdom, Flexibility, Fluidity, Downward, Penetrating</p>
                            <p><strong>Advantages:</strong> Flexible Thinking, Strong Adaptability, Good Communication, Strong Learning Ability, Wise</p>
                            <p><strong>Suggestions:</strong> Utilize wisdom and adaptability, cultivate learning ability, build extensive networks</p>
                            <p><strong>Precautions:</strong> Avoid indecisiveness, enhance self-confidence, maintain focus</p>
                            <p><strong>Health Focus:</strong> Kidneys and urinary system, avoid overwork, stay warm</p>
                        </div>
                        
                        <h3 class="mt-4" data-lang="zh">个性化五行平衡建议</h3>
                        <h3 class="mt-4" data-lang="en" style="display: none;">Personalized Five Elements Balance Advice</h3>
                        <div id="personalized-advice" class="element-detail">
                            <!-- 这里将通过JavaScript动态生成个性化建议 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 大运流年表展示 -->
            <div class="section">
                <h2><i class="fas fa-chart-line"></i>
                    <span data-lang="zh">大运流年</span>
                    <span data-lang="en" style="display: none;">Destiny and Annual Cycles</span>
                </h2>
                <div id="dayun-timeline">
                    <p class="text-center" data-lang="zh">大运信息加载中...</p>
                    <p class="text-center" data-lang="en" style="display: none;">Loading destiny cycle information...</p>
                </div>
            </div>
            
            <!-- 添加健康分析部分 -->
            <div class="section">
                <h2 data-lang="zh"><i class="fas fa-heartbeat"></i> 健康与五行调节</h2>
                <h2 data-lang="en" style="display: none"><i class="fas fa-heartbeat"></i> Health and Five Elements Adjustment</h2>
                <div id="health-analysis-container">
                    <p class="text-center">加载中...</p>
                </div>
            </div>
            
            <div class="buttons">
                <button onclick="window.location.href='./用户信息表单.html'" data-lang="zh">返回重新分析</button>
                <button onclick="window.location.href='./用户信息表单.html'" data-lang="en" style="display: none;">Return to Analysis</button>
            </div>
        </div>
        
        <div class="buttons">
            <button onclick="window.location.href='用户信息表单.html'" data-lang="zh">返回修改信息</button>
            <button onclick="window.location.href='用户信息表单.html'" data-lang="en" style="display: none;">Return to Edit Info</button>
            <button onclick="window.print()" data-lang="zh">打印分析结果</button>
            <button onclick="window.print()" data-lang="en" style="display: none;">Print Analysis</button>
        </div>
    </div>
    
    <!-- 柱子详情模态框 -->
    <div id="pillar-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">柱子详情</div>
                <button class="modal-close" onclick="closePillarModal()"><i class="fas fa-times-circle"></i></button>
            </div>
            <div id="pillar-details">
                <!-- 详情内容将通过JavaScript动态添加 -->
            </div>
        </div>
    </div>
    
    <!-- 解释模态框 -->
    <div id="explanation-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" data-lang="zh">命理术语解释</div>
                <div class="modal-title" data-lang="en" style="display: none;">Chinese Astrology Terms</div>
                <button class="modal-close" onclick="closeExplanationModal()"><i class="fas fa-times-circle"></i></button>
            </div>
            <div id="explanation-content">
                <div class="term-section">
                    <h3 data-lang="zh">八字</h3>
                    <h3 data-lang="en" style="display: none;">BaZi (Eight Characters)</h3>
                    <p data-lang="zh">八字是由年、月、日、时四柱组成，每柱包含天干和地支，用于预测人生命运。</p>
                    <p data-lang="en" style="display: none;">BaZi consists of four pillars (year, month, day, and hour), each containing a Heavenly Stem and an Earthly Branch, used for destiny analysis.</p>
            </div>
                <div class="term-section">
                    <h3 data-lang="zh">天干</h3>
                    <h3 data-lang="en" style="display: none;">Heavenly Stems</h3>
                    <p data-lang="zh">天干是甲、乙、丙、丁、戊、己、庚、辛、壬、癸十个字，代表不同的五行属性。</p>
                    <p data-lang="en" style="display: none;">The ten Heavenly Stems (Jia, Yi, Bing, Ding, Wu, Ji, Geng, Xin, Ren, Gui) represent different Five Elements attributes.</p>
                </div>
                <div class="term-section">
                    <h3 data-lang="zh">地支</h3>
                    <h3 data-lang="en" style="display: none;">Earthly Branches</h3>
                    <p data-lang="zh">地支是子、丑、寅、卯、辰、巳、午、未、申、酉、戌、亥十二个字，对应十二生肖。</p>
                    <p data-lang="en" style="display: none;">The twelve Earthly Branches (Zi, Chou, Yin, Mao, Chen, Si, Wu, Wei, Shen, You, Xu, Hai) correspond to the twelve zodiac animals.</p>
                </div>
                <div class="term-section">
                    <h3 data-lang="zh">五行</h3>
                    <h3 data-lang="en" style="display: none;">Five Elements</h3>
                    <p data-lang="zh">五行包括金、木、水、火、土，是万物运行变化的基本规律。</p>
                    <p data-lang="en" style="display: none;">The Five Elements (Metal, Wood, Water, Fire, Earth) represent the fundamental principles of all natural phenomena.</p>
                </div>
                <div class="term-section">
                    <h3 data-lang="zh">纳音</h3>
                    <h3 data-lang="en" style="display: none;">Hidden Stem</h3>
                    <p data-lang="zh">纳音是天干地支组合所蕴含的五行属性，用于深入分析命理。</p>
                    <p data-lang="en" style="display: none;">Hidden Stem refers to the Five Elements attribute contained in the combination of Heavenly Stems and Earthly Branches, used for in-depth analysis.</p>
                </div>
                <div class="term-section">
                    <h3 data-lang="zh">十神</h3>
                    <h3 data-lang="en" style="display: none;">Ten Gods</h3>
                    <p data-lang="zh">十神是比肩、劫财、食神、伤官、偏财、正财、七杀、正官、偏印、正印，用于分析日主与其他天干的关系。</p>
                    <p data-lang="en" style="display: none;">The Ten Gods (Peer, Rob Wealth, Eating God, Hurting Officer, Indirect Wealth, Direct Wealth, Seven Killings, Direct Officer, Indirect Print, Direct Print) analyze the relationship between the Day Master and other Heavenly Stems.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 大运详情模态框 -->
    <div id="dayun-modal">
        <div class="dayun-modal-content">
            <span class="close-button" onclick="closeDayunModal()">&times;</span>
            <div id="dayun-details"></div>
        </div>
    </div>
    
    <!-- 流年详情模态框 -->
    <div id="flowyear-modal">
        <div class="flowyear-modal-content">
            <span class="close-button" onclick="closeFlowYearModal()">&times;</span>
            <div id="flowyear-details"></div>
        </div>
    </div>
    
    <!-- 大运详情模态框 -->
    <div id="dayun-modal">
        <div class="dayun-modal-content">
            <span class="close-button" onclick="closeDayunModal()">&times;</span>
            <div class="dayun-detail-header">
                <h2 data-lang="zh">大运详情: <span id="modal-dayun-ganzhi"></span></h2>
                <h2 data-lang="en" style="display: none">Destiny Period Details: <span id="modal-dayun-ganzhi"></span></h2>
            </div>
            <!-- 添加时辰不确定提示 -->
            <div id="modal-time-note" class="time-note" style="display: none; background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>时辰不确定，结果仅供参考
            </div>
            <div class="dayun-detail-grid">
                <div class="detail-item">
                    <label data-lang="zh">年龄段:</label>
                    <label data-lang="en" style="display: none">Age Range:</label>
                    <span id="modal-dayun-age"></span>
                </div>
                <div class="detail-item">
                    <label data-lang="zh">年份:</label>
                    <label data-lang="en" style="display: none">Years:</label>
                    <span id="modal-dayun-year"></span>
                </div>
                <div class="detail-item">
                    <label data-lang="zh">纳音:</label>
                    <label data-lang="en" style="display: none">Hidden Stem:</label>
                    <span id="modal-dayun-nayin"></span>
                </div>
                <div class="detail-item">
                    <label data-lang="zh">天干五行:</label>
                    <label data-lang="en" style="display: none">Heavenly Stem Element:</label>
                    <span id="modal-dayun-gan-element"></span>
                </div>
                <div class="detail-item">
                    <label data-lang="zh">地支五行:</label>
                    <label data-lang="en" style="display: none">Earthly Branch Element:</label>
                    <span id="modal-dayun-zhi-element"></span>
                </div>
                <div class="detail-item">
                    <label data-lang="zh">十神:</label>
                    <label data-lang="en" style="display: none">Ten Gods:</label>
                    <span id="modal-dayun-shishen"></span>
                </div>
            </div>
            <div class="section-divider"></div>
            <div class="dayun-analysis">
                <h3 data-lang="zh">大运分析</h3>
                <h3 data-lang="en" style="display: none">Period Analysis</h3>
                <p id="modal-dayun-analysis"></p>
            </div>
            <div class="dayun-advice">
                <h3 data-lang="zh">建议</h3>
                <h3 data-lang="en" style="display: none">Suggestions</h3>
                <p id="modal-dayun-advice"></p>
            </div>
            <div class="section-divider"></div>
            <div class="flow-years">
                <h3 data-lang="zh">该大运下的流年</h3>
                <h3 data-lang="en" style="display: none">Annual Cycles in This Period</h3>
                <div id="modal-flow-years"></div>
            </div>
        </div>
    </div>

    <script>
        // 处理lunar库加载错误
        function handleLunarLoadError() {
            console.error('Lunar.js库加载失败');
            showError('命理计算库加载失败，可能会影响分析结果的准确性。请确保lunar.js文件存在并可访问。');
            
            // 尝试动态加载
            tryLoadLunarDynamically();
        }
        
        // 全局变量定义
        // 神煞定义（更完整版）
        const shenshaMap = {
            '甲': ['天乙贵人', '文昌', '驿马', '青龙', '太极贵人', '岁建'], 
            '乙': ['天乙贵人', '文曲', '金舆', '明堂', '凤阁', '恩光'], 
            '丙': ['天德', '驿马', '红鸾', '天魁', '天厄', '大败'], 
            '丁': ['月德', '天后', '天喜', '天姚', '玉堂', '截路空亡'],
            '戊': ['天医', '司命', '将星', '天官', '唐符', '福星'], 
            '己': ['福星', '天喜', '天厨', '天巫', '天印', '黄幡'], 
            '庚': ['国印', '天厨', '孤辰', '勾陈', '天财', '太阴'], 
            '辛': ['天巫', '天官', '寡宿', '丧门', '贯索', '大耗'],
            '壬': ['天福', '天德合', '咸池', '铃星', '策神', '岁破'], 
            '癸': ['天赦', '福德', '解神', '灾煞', '劫煞', '灾杀']
        };
        
        // 地支神煞（更完整版）
        const zhiShenshaMap = {
            '子': ['天后', '天德', '岁破', '劫煞', '六害', '咸池', '桃花', '劫杀'], 
            '丑': ['白虎', '天医', '天德合', '灾煞', '勾绞', '地狱', '血支', '孤鸞'], 
            '寅': ['天刑', '太岁', '六合', '华盖', '将星', '披麻', '马神', '丧车'], 
            '卯': ['天权', '桃花', '劫煞', '咸池', '天马', '亡神', '解神', '天贵'],
            '辰': ['六害', '地囚', '天牢', '朱雀', '灾杀', '大败', '伏兵', '吊客'], 
            '巳': ['天罗', '勾陈', '天德', '火星', '六合', '小耗', '病符', '铃星'], 
            '午': ['天贵', '天德', '咸池', '孤辰', '阴差', '上台', '天财', '血支'], 
            '未': ['地杀', '天喜', '贯索', '寡宿', '死符', '地哭', '白虎', '博士'],
            '申': ['太极', '驿马', '华盖', '天空', '奸神', '孤独', '力士', '飞廉'], 
            '酉': ['截路', '华盖', '咸池', '旬空', '官符', '灾煞', '月厌', '陀罗'], 
            '戌': ['地解', '天煞', '伏位', '卷舌', '魁罡', '死神', '黄幡', '绞煞'], 
            '亥': ['灾煞', '月德', '八专', '大耗', '天医', '破碎', '风刀', '词馆']
        };
        
        // 四柱五行强弱定义
        const ganWuxingStrength = {
            '甲': {'春': '旺', '夏': '相', '秋': '休', '冬': '囚'},
            '乙': {'春': '旺', '夏': '相', '秋': '休', '冬': '囚'},
            '丙': {'春': '相', '夏': '旺', '秋': '囚', '冬': '休'},
            '丁': {'春': '相', '夏': '旺', '秋': '囚', '冬': '休'},
            '戊': {'春': '囚', '夏': '相', '秋': '旺', '冬': '休'},
            '己': {'春': '囚', '夏': '相', '秋': '旺', '冬': '休'},
            '庚': {'春': '休', '夏': '囚', '秋': '旺', '冬': '相'},
            '辛': {'春': '休', '夏': '囚', '秋': '旺', '冬': '相'},
            '壬': {'春': '相', '夏': '休', '秋': '囚', '冬': '旺'},
            '癸': {'春': '相', '夏': '休', '秋': '囚', '冬': '旺'}
        };
        
        // 日干对应的富贵贫贱吉凶
        const dayGanFate = {
            '甲': {'吉': ['丙', '丁', '戊', '己', '辛'], '凶': ['庚', '壬', '癸'], '中': ['乙']},
            '乙': {'吉': ['戊', '己', '庚', '辛'], '凶': ['甲', '丙', '壬'], '中': ['丁', '癸']},
            '丙': {'吉': ['己', '庚', '壬', '癸'], '凶': ['乙', '丁', '戊'], '中': ['甲', '辛']},
            '丁': {'吉': ['甲', '庚', '辛', '壬'], '凶': ['乙', '丙', '己'], '中': ['戊', '癸']},
            '戊': {'吉': ['乙', '丙', '壬', '癸'], '凶': ['丁', '己', '辛'], '中': ['甲', '庚']},
            '己': {'吉': ['甲', '乙', '丙'], '凶': ['戊', '庚', '壬'], '中': ['丁', '辛', '癸']},
            '庚': {'吉': ['甲', '丙', '丁', '癸'], '凶': ['乙', '己', '辛'], '中': ['戊', '壬']},
            '辛': {'吉': ['甲', '乙', '丁'], '凶': ['庚', '壬', '癸'], '中': ['丙', '戊', '己']},
            '壬': {'吉': ['丙', '丁', '己', '辛'], '凶': ['甲', '乙', '癸'], '中': ['戊', '庚']},
            '癸': {'吉': ['乙', '戊', '庚'], '凶': ['丙', '丁', '壬'], '中': ['甲', '己', '辛']}
        };
        
        // 尝试动态加载lunar.js库
        function tryLoadLunarDynamically() {
            console.log('尝试动态加载lunar.js库...');
            
            // 尝试多个可能的路径
            const possiblePaths = [
                '../lunar-javascript/lunar.js',
                './lunar-javascript/lunar.js',
                '/lunar-javascript/lunar.js',
                'lunar-javascript/lunar.js'
            ];
            
            let loaded = false;
            
            // 尝试逐个加载
            for (const path of possiblePaths) {
                if (loaded) break;
                
                const script = document.createElement('script');
                script.src = path;
                script.async = false;
                
                script.onload = function() {
                    if (typeof Lunar !== 'undefined' && typeof Solar !== 'undefined') {
                        console.log(`Lunar库从 ${path} 加载成功`);
                        // 页面已加载的情况下，重新加载内容
                        location.reload();
                        loaded = true;
                    }
                };
                
                script.onerror = function() {
                    console.error(`Lunar库从 ${path} 加载失败`);
                };
                
                document.head.appendChild(script);
            }
        }
        
        // 当文档加载完成后初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 检查lunar.js库是否正确加载
            setTimeout(function() {
                const lunarLoaded = typeof Lunar !== 'undefined' && typeof Solar !== 'undefined';
                console.log('Lunar库加载状态:', lunarLoaded ? '成功' : '失败');
                
                if (!lunarLoaded) {
                    showError('命理计算库加载失败，可能会影响分析结果的准确性。请刷新页面或检查网络连接。');
                }
            }, 500);
            
            // 从localStorage获取数据并展示
            try {
                // 获取URL参数
                const urlParams = new URLSearchParams(window.location.search);
                const analysisId = urlParams.get('id');
                
                let analysisData, userData;
                
                if (analysisId) {
                    // 如果有ID参数，从localStorage获取特定分析结果
                    const analysisKey = `bazi_analysis_${analysisId}`;
                    const userDataKey = `user_data_${analysisId}`;
                    
                    const savedAnalysis = localStorage.getItem(analysisKey);
                    const savedUserData = localStorage.getItem(userDataKey);
                    
                    if (!savedAnalysis || !savedUserData) {
                        showError('未找到相关分析数据，请重新分析');
                    return;
                }
                
                    analysisData = JSON.parse(savedAnalysis);
                    userData = JSON.parse(savedUserData);
                } else {
                    // 如果没有ID参数，尝试从localStorage获取最近的分析数据
                    const savedAnalysis = localStorage.getItem('baziAnalysisData');
                    const savedUserData = localStorage.getItem('baziUserData');
                    
                    if (!savedAnalysis || !savedUserData) {
                        showError('未找到分析数据，请先进行八字分析');
                    return;
                }
                
                    analysisData = JSON.parse(savedAnalysis);
                    userData = JSON.parse(savedUserData);
                }
                
                // 验证数据完整性
                if (!analysisData.ganzhi || !analysisData.wuxing) {
                    showError('分析数据不完整，请重新进行分析');
                    console.error('分析数据不完整:', analysisData);
                    return;
                }
                
                // 填充基本信息
                document.getElementById('user-name').textContent = userData.name || '未知';
                document.getElementById('user-gender').textContent = userData.gender || '未知';
                
                // 添加出生地点信息
                let birthPlace = '';
                let birthPlaceEn = '';  // 添加英文地点变量
                
                if (userData.country && userData.province) {
                    // 检查国家名是否已经是英文
                    const isEnglishCountry = /^[A-Za-z\s]+$/.test(userData.country);
                    
                    // 中文到英文的国家映射
                    const countryMap = {
                        '中国': 'China',
                        '美国': 'USA',
                        '加拿大': 'Canada',
                        '英国': 'UK',
                        '澳大利亚': 'Australia',
                        '新西兰': 'New Zealand',
                        '意大利': 'Italy',
                        '法国': 'France',
                        '德国': 'Germany',
                        '西班牙': 'Spain',
                        '葡萄牙': 'Portugal',
                        '瑞士': 'Switzerland',
                        '奥地利': 'Austria',
                        '比利时': 'Belgium',
                        '荷兰': 'Netherlands',
                        '瑞典': 'Sweden',
                        '挪威': 'Norway',
                        '丹麦': 'Denmark',
                        '芬兰': 'Finland',
                        '爱尔兰': 'Ireland',
                        '希腊': 'Greece'
                    };
                    
                    // 英文到中文的国家映射
                    const countryMapReverse = Object.fromEntries(
                        Object.entries(countryMap).map(([k, v]) => [v, k])
                    );
                    
                    // 设置中英文国家名
                    let countryZh = isEnglishCountry ? (countryMapReverse[userData.country] || userData.country) : userData.country;
                    let countryEn = isEnglishCountry ? userData.country : (countryMap[userData.country] || userData.country);
                    let provinceEn = userData.province;  // 默认使用原始省份名
                    
                    // 中国省份中英文映射
                    if (userData.country === '中国') {
                        const provinceMap = {
                            '北京': 'Beijing',
                            '上海': 'Shanghai',
                            '广东': 'Guangdong',
                            '江苏': 'Jiangsu',
                            '浙江': 'Zhejiang',
                            '山东': 'Shandong',
                            '河南': 'Henan',
                            '四川': 'Sichuan',
                            '河北': 'Hebei',
                            '湖南': 'Hunan',
                            '湖北': 'Hubei',
                            '福建': 'Fujian',
                            '安徽': 'Anhui',
                            '江西': 'Jiangxi',
                            '黑龙江': 'Heilongjiang',
                            '辽宁': 'Liaoning',
                            '吉林': 'Jilin',
                            '陕西': 'Shaanxi',
                            '云南': 'Yunnan',
                            '贵州': 'Guizhou',
                            '甘肃': 'Gansu',
                            '广西': 'Guangxi',
                            '山西': 'Shanxi',
                            '内蒙古': 'Inner Mongolia',
                            '新疆': 'Xinjiang',
                            '宁夏': 'Ningxia',
                            '青海': 'Qinghai',
                            '西藏': 'Tibet',
                            '海南': 'Hainan',
                            '香港': 'Hong Kong',
                            '澳门': 'Macau',
                            '台湾': 'Taiwan'
                        };
                        provinceEn = provinceMap[userData.province] || userData.province;
                    }
                    
                    birthPlaceEn = countryEn + ' ' + provinceEn;
                } else if (userData.country) {
                    // 检查国家名是否已经是英文
                    const isEnglishCountry = /^[A-Za-z\s]+$/.test(userData.country);
                    
                    // 中文到英文的国家映射
                    const countryMap = {
                        '中国': 'China',
                        '美国': 'USA',
                        '加拿大': 'Canada',
                        '英国': 'UK',
                        '澳大利亚': 'Australia',
                        '新西兰': 'New Zealand',
                        '意大利': 'Italy',
                        '法国': 'France',
                        '德国': 'Germany',
                        '西班牙': 'Spain',
                        '葡萄牙': 'Portugal',
                        '瑞士': 'Switzerland',
                        '奥地利': 'Austria',
                        '比利时': 'Belgium',
                        '荷兰': 'Netherlands',
                        '瑞典': 'Sweden',
                        '挪威': 'Norway',
                        '丹麦': 'Denmark',
                        '芬兰': 'Finland',
                        '爱尔兰': 'Ireland',
                        '希腊': 'Greece'
                    };
                    
                    // 英文到中文的国家映射
                    const countryMapReverse = Object.fromEntries(
                        Object.entries(countryMap).map(([k, v]) => [v, k])
                    );
                    
                    // 设置中英文国家名
                    let countryZh = isEnglishCountry ? (countryMapReverse[userData.country] || userData.country) : userData.country;
                    let countryEn = isEnglishCountry ? userData.country : (countryMap[userData.country] || userData.country);
                    
                    birthPlace = countryZh;
                    birthPlaceEn = countryEn;
                } else if (userData.province) {
                    birthPlace = userData.province;
                    birthPlaceEn = userData.province;  // 默认使用原始省份名
                } else {
                    birthPlace = '未知';
                    birthPlaceEn = 'Unknown';
                }
                
                // 保存中英文地点信息，以便语言切换时使用
                const birthPlaceElement = document.getElementById('birth-place');
                birthPlaceElement.setAttribute('data-zh', birthPlace);
                birthPlaceElement.setAttribute('data-en', birthPlaceEn);
                birthPlaceElement.textContent = birthPlace;
                
                document.getElementById('solar-date').textContent = userData.birthDate || analysisData.solarDate || '未知';
                document.getElementById('lunar-date').textContent = analysisData.lunarDate || '未知';
                document.getElementById('shengxiao').textContent = analysisData.shengxiao || '未知';
                
                // 检查是否选择了"不清楚具体时间"
                if (userData.unknownTime) {
                    document.getElementById('unknown-time-note').style.display = 'block';
                }
                
                // 填充八字命盘
                pillars = ['year', 'month', 'day', 'hour'];
                pillars.forEach(pillar => {
                    const element = document.getElementById(`${pillar}-pillar`);
                    if (element && analysisData.ganzhi && analysisData.ganzhi[pillar]) {
                        element.textContent = analysisData.ganzhi[pillar];
                        
                        // 为日柱添加特殊样式
                        if (pillar === 'day') {
                            element.classList.add('day-pillar');
                        }
                    }
                });
                
                // 填充八字表格详细信息
                fillBaziTable(analysisData);
                
                // 显示五行分析
                showWuxingAnalysis(analysisData);
                
                // 渲染大运时间线
                    renderDayunTimeline(userData, analysisData);
                
                // 渲染八字内容，包括健康分析
                renderBaziContent(userData, analysisData);
                
                console.log('页面数据加载完成');
                
                // 初始化语言切换功能
                setupLanguageToggle();
                
            } catch (error) {
                console.error('初始化页面出错:', error);
                showError('数据解析错误: ' + error.message);
            }
        });
        
        // 渲染八字内容，包括健康分析
        function renderBaziContent(userData, analysisData) {
            try {
                // 渲染健康分析内容
                const healthAnalysisContainer = document.getElementById('health-analysis-container');
                if (healthAnalysisContainer) {
                    // 生成健康分析内容
                    const healthAnalysisHtml = generateHealthSummary(analysisData);
                    healthAnalysisContainer.innerHTML = healthAnalysisHtml;
                    console.log('健康分析渲染完成');
                } else {
                    console.warn('未找到健康分析容器');
                }
                
                // 在这里可以添加其他八字内容的渲染
                
            } catch (error) {
                console.error('渲染八字内容出错:', error);
                if (document.getElementById('health-analysis-container')) {
                    document.getElementById('health-analysis-container').innerHTML = '<p class="text-center">健康分析生成错误: ' + error.message + '</p>';
                }
            }
        }
        
        // 显示错误信息
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
        
        // 确定季节
        function determineSeason(monthGanzhi) {
            if (!monthGanzhi) return '未知';
            
            const zhi = monthGanzhi.charAt(1);
            
            if (zhi === '寅' || zhi === '卯' || zhi === '辰') {
                return '春';
            } else if (zhi === '巳' || zhi === '午' || zhi === '未') {
                return '夏';
            } else if (zhi === '申' || zhi === '酉' || zhi === '戌') {
                return '秋';
            } else if (zhi === '亥' || zhi === '子' || zhi === '丑') {
                return '冬';
            } else {
                return '未知';
            }
        }
        
        // 生成个性化五行建议
        function generateWuxingAdvice(dayGan, wuxingScores, birthSeason) {
            try {
                if (!dayGan || !wuxingScores) {
                    return '数据不足，无法生成个性化建议。';
                }
                
                // 天干对应五行
                const ganWuxing = {
                    '甲': '木', '乙': '木',
                    '丙': '火', '丁': '火',
                    '戊': '土', '己': '土',
                    '庚': '金', '辛': '金',
                    '壬': '水', '癸': '水'
                };
                
                // 天干旺衰
                const ganSeasonStrength = {
                    '甲': {'春': '旺', '夏': '相', '秋': '休', '冬': '囚'},
                    '乙': {'春': '旺', '夏': '相', '秋': '休', '冬': '囚'},
                    '丙': {'春': '相', '夏': '旺', '秋': '囚', '冬': '休'},
                    '丁': {'春': '相', '夏': '旺', '秋': '囚', '冬': '休'},
                    '戊': {'春': '囚', '夏': '相', '秋': '旺', '冬': '休'},
                    '己': {'春': '囚', '夏': '相', '秋': '旺', '冬': '休'},
                    '庚': {'春': '休', '夏': '囚', '秋': '旺', '冬': '相'},
                    '辛': {'春': '休', '夏': '囚', '秋': '旺', '冬': '相'},
                    '壬': {'春': '相', '夏': '休', '秋': '囚', '冬': '旺'},
                    '癸': {'春': '相', '夏': '休', '秋': '囚', '冬': '旺'}
                };
                
                // 获取日主五行
                const dayWuxing = ganWuxing[dayGan];
                // 获取日主旺衰
                const dayGanStrength = ganSeasonStrength[dayGan] ? ganSeasonStrength[dayGan][birthSeason] || '中' : '中';
                
                // 计算日主五行得分
                const dayWuxingScore = wuxingScores[dayWuxing] || 0;
                
                // 转换五行得分为数组并排序
                const wuxingArray = Object.entries(wuxingScores).map(([name, value]) => ({name, value}));
                wuxingArray.sort((a, b) => b.value - a.value);
                
                // 最强和最弱的五行
                const strongestWuxing = wuxingArray[0].name;
                const weakestWuxing = wuxingArray[wuxingArray.length - 1].name;
                
                // 五行关系
                const relationships = {
                    '木': { '生': '火', '克': '土', '被生': '水', '被克': '金' },
                    '火': { '生': '土', '克': '金', '被生': '木', '被克': '水' },
                    '土': { '生': '金', '克': '水', '被生': '火', '被克': '木' },
                    '金': { '生': '水', '克': '木', '被生': '土', '被克': '火' },
                    '水': { '生': '木', '克': '火', '被生': '金', '被克': '土' }
                };
                
                // 五行英文名称
                const wuxingEnglishNames = {
                    '木': 'Wood',
                    '火': 'Fire',
                    '土': 'Earth',
                    '金': 'Metal',
                    '水': 'Water'
                };
                
                // 根据日主强弱生成建议
                let adviceHtml = '';
                if (dayGanStrength === '旺' || dayWuxingScore > 30) {
                    // 日主过旺建议
                    adviceHtml += `<p data-lang="zh"><strong>日主状态：</strong><span class="shensha-good">偏强</span>，您的日主五行(${dayWuxing})在八字中力量较强。</p>`;
                    adviceHtml += `<p data-lang="en" style="display:none"><strong>Day Master Status: </strong><span class="shensha-good">Strong</span>, your Day Master element (${wuxingEnglishNames[dayWuxing]}) is relatively strong in your BaZi chart.</p>`;
                    
                    adviceHtml += `<p data-lang="zh"><strong>平衡建议：</strong>需要抑制日主过旺的状态，以下是具体建议：</p>`;
                    adviceHtml += `<p data-lang="en" style="display:none"><strong>Balance Suggestion: </strong>Need to suppress the overly strong state of the Day Master, here are specific suggestions:</p>`;
                    
                    adviceHtml += `<ul data-lang="zh">`;
                    adviceHtml += `<li>可以适当补充克制日主(${dayWuxing})的五行：<span class="shensha-good">${relationships[dayWuxing].被克}</span>，有助于平衡能量。</li>`;
                    adviceHtml += `<li>避免过多使用与日主相同(${dayWuxing})的五行或生日主的五行(${relationships[dayWuxing].被生})。</li>`;
                    adviceHtml += `<li>在学习和工作中，建议发挥${relationships[dayWuxing].被克}的特质，增强自我约束和控制力。</li>`;
                    adviceHtml += `</ul>`;
                    
                    adviceHtml += `<ul data-lang="en" style="display:none">`;
                    adviceHtml += `<li>You can appropriately supplement with elements that control your Day Master (${wuxingEnglishNames[dayWuxing]}): <span class="shensha-good">${wuxingEnglishNames[relationships[dayWuxing].被克]}</span>, which helps balance energy.</li>`;
                    adviceHtml += `<li>Avoid excessive use of elements that are the same as your Day Master (${wuxingEnglishNames[dayWuxing]}) or elements that generate your Day Master (${wuxingEnglishNames[relationships[dayWuxing].被生]}).</li>`;
                    adviceHtml += `<li>In learning and work, it is recommended to develop the characteristics of ${wuxingEnglishNames[relationships[dayWuxing].被克]}, enhancing self-discipline and control.</li>`;
                    adviceHtml += `</ul>`;
                    
                    // 职业建议
                    adviceHtml += `<p data-lang="zh"><strong>职业方向：</strong>适合从事与${relationships[dayWuxing].被克}、${relationships[dayWuxing].克}相关的行业，如：</p>`;
                    adviceHtml += `<p data-lang="en" style="display:none"><strong>Career Direction: </strong>Suitable for industries related to ${wuxingEnglishNames[relationships[dayWuxing].被克]} and ${wuxingEnglishNames[relationships[dayWuxing].克]}, such as:</p>`;
                    
                    if (dayWuxing === '木') {
                        adviceHtml += `<span data-lang="zh">金融、精密工作、军警、决策管理、规划设计相关工作。</span>`;
                        adviceHtml += `<span data-lang="en" style="display:none">Finance, precision work, military/police, decision management, planning and design related work.</span>`;
                    } else if (dayWuxing === '火') {
                        adviceHtml += `<span data-lang="zh">水利、经济、科研、咨询、行政管理相关工作。</span>`;
                        adviceHtml += `<span data-lang="en" style="display:none">Water conservancy, economics, scientific research, consulting, administrative management related work.</span>`;
                    } else if (dayWuxing === '土') {
                        adviceHtml += `<span data-lang="zh">创意设计、教育培训、法律、文艺表演相关工作。</span>`;
                        adviceHtml += `<span data-lang="en" style="display:none">Creative design, education and training, legal, arts and performance related work.</span>`;
                    } else if (dayWuxing === '金') {
                        adviceHtml += `<span data-lang="zh">热能、电子、媒体、市场营销相关工作。</span>`;
                        adviceHtml += `<span data-lang="en" style="display:none">Thermal energy, electronics, media, marketing related work.</span>`;
                    } else if (dayWuxing === '水') {
                        adviceHtml += `<span data-lang="zh">农业、建筑、不动产、管理、咨询相关工作。</span>`;
                        adviceHtml += `<span data-lang="en" style="display:none">Agriculture, construction, real estate, management, consulting related work.</span>`;
                    }
                    
                } else if (dayGanStrength === '休' || dayGanStrength === '囚' || dayWuxingScore < 15) {
                    // 日主偏弱建议
                    adviceHtml += `<p data-lang="zh"><strong>日主状态：</strong><span class="shensha-bad">偏弱</span>，您的日主五行(${dayWuxing})在八字中力量较弱。</p>`;
                    adviceHtml += `<p data-lang="en" style="display:none"><strong>Day Master Status: </strong><span class="shensha-bad">Weak</span>, your Day Master element (${wuxingEnglishNames[dayWuxing]}) is relatively weak in your BaZi chart.</p>`;
                    
                    adviceHtml += `<p data-lang="zh"><strong>平衡建议：</strong>需要扶助日主的力量，以下是具体建议：</p>`;
                    adviceHtml += `<p data-lang="en" style="display:none"><strong>Balance Suggestion: </strong>Need to support the strength of the Day Master, here are specific suggestions:</p>`;
                    
                    adviceHtml += `<ul data-lang="zh">`;
                    adviceHtml += `<li>可以适当补充与日主相同(${dayWuxing})的五行或生日主的五行：<span class="shensha-good">${relationships[dayWuxing].被生}</span>，有助于增强能量。</li>`;
                    adviceHtml += `<li>避免过多使用克制日主的五行(${relationships[dayWuxing].被克})。</li>`;
                    adviceHtml += `<li>在学习和工作中，建议发挥${dayWuxing}和${relationships[dayWuxing].被生}的特质，增强自信和创造力。</li>`;
                    adviceHtml += `</ul>`;
                    
                    adviceHtml += `<ul data-lang="en" style="display:none">`;
                    adviceHtml += `<li>You can appropriately supplement with elements that are the same as your Day Master (${wuxingEnglishNames[dayWuxing]}) or elements that generate your Day Master: <span class="shensha-good">${wuxingEnglishNames[relationships[dayWuxing].被生]}</span>, which helps strengthen energy.</li>`;
                    adviceHtml += `<li>Avoid excessive use of elements that control your Day Master (${wuxingEnglishNames[relationships[dayWuxing].被克]}).</li>`;
                    adviceHtml += `<li>In learning and work, it is recommended to develop the characteristics of ${wuxingEnglishNames[dayWuxing]} and ${wuxingEnglishNames[relationships[dayWuxing].被生]}, enhancing confidence and creativity.</li>`;
                    adviceHtml += `</ul>`;
                    
                    // 职业建议
                    adviceHtml += `<p data-lang="zh"><strong>职业方向：</strong>适合从事与${dayWuxing}或${relationships[dayWuxing].被生}相关的行业，如：</p>`;
                    adviceHtml += `<p data-lang="en" style="display:none"><strong>Career Direction: </strong>Suitable for industries related to ${wuxingEnglishNames[dayWuxing]} or ${wuxingEnglishNames[relationships[dayWuxing].被生]}, such as:</p>`;
                    
                    if (dayWuxing === '木') {
                        adviceHtml += `<span data-lang="zh">教育、法律、创意设计、园艺、环保相关工作。</span>`;
                        adviceHtml += `<span data-lang="en" style="display:none">Education, law, creative design, gardening, environmental protection related work.</span>`;
                    } else if (dayWuxing === '火') {
                        adviceHtml += `<span data-lang="zh">媒体、演艺、市场营销、餐饮、心理咨询相关工作。</span>`;
                        adviceHtml += `<span data-lang="en" style="display:none">Media, performing arts, marketing, catering, psychological counseling related work.</span>`;
                    } else if (dayWuxing === '土') {
                        adviceHtml += `<span data-lang="zh">房地产、建筑、农业、餐饮、零售相关工作。</span>`;
                        adviceHtml += `<span data-lang="en" style="display:none">Real estate, construction, agriculture, catering, retail related work.</span>`;
                    } else if (dayWuxing === '金') {
                        adviceHtml += `<span data-lang="zh">金融、军警、IT、工程、机械相关工作。</span>`;
                        adviceHtml += `<span data-lang="en" style="display:none">Finance, military/police, IT, engineering, mechanical related work.</span>`;
                    } else if (dayWuxing === '水') {
                        adviceHtml += `<span data-lang="zh">学术研究、智能科技、医药、物流、外交相关工作。</span>`;
                        adviceHtml += `<span data-lang="en" style="display:none">Academic research, intelligent technology, medicine, logistics, diplomacy related work.</span>`;
                    }
                    
                } else {
                    // 日主平衡建议
                    adviceHtml += `<p data-lang="zh"><strong>日主状态：</strong><span>中和</span>，您的日主五行(${dayWuxing})在八字中力量适中。</p>`;
                    adviceHtml += `<p data-lang="en" style="display:none"><strong>Day Master Status: </strong><span>Balanced</span>, your Day Master element (${wuxingEnglishNames[dayWuxing]}) has moderate strength in your BaZi chart.</p>`;
                    
                    adviceHtml += `<p data-lang="zh"><strong>平衡建议：</strong>整体五行较为平衡，可以根据实际情况灵活调整，以下是具体建议：</p>`;
                    adviceHtml += `<p data-lang="en" style="display:none"><strong>Balance Suggestion: </strong>The overall five elements are relatively balanced, you can adjust flexibly according to the actual situation, here are specific suggestions:</p>`;
                    
                    adviceHtml += `<ul data-lang="zh">`;
                    adviceHtml += `<li>可以适当补充与日主相同(${dayWuxing})的五行和生日主的五行(${relationships[dayWuxing].被生})，保持能量平衡。</li>`;
                    adviceHtml += `<li>在五行最弱的(${weakestWuxing})方面适当加强，使八字更加平衡。</li>`;
                    adviceHtml += `<li>在学习和工作中，建议全面发展，注重多领域能力的提升。</li>`;
                    adviceHtml += `</ul>`;
                    
                    adviceHtml += `<ul data-lang="en" style="display:none">`;
                    adviceHtml += `<li>You can appropriately supplement with elements that are the same as your Day Master (${wuxingEnglishNames[dayWuxing]}) and elements that generate your Day Master (${wuxingEnglishNames[relationships[dayWuxing].被生]}), maintaining energy balance.</li>`;
                    adviceHtml += `<li>Strengthen appropriately in the weakest element (${wuxingEnglishNames[weakestWuxing]}) to make your BaZi more balanced.</li>`;
                    adviceHtml += `<li>In learning and work, it is recommended to develop comprehensively, focusing on improving abilities in multiple fields.</li>`;
                    adviceHtml += `</ul>`;
                    
                    // 职业建议
                    adviceHtml += `<p data-lang="zh"><strong>职业方向：</strong>适合从事多元化或综合性的工作，各种行业都可以考虑，尤其是：</p>`;
                    adviceHtml += `<p data-lang="en" style="display:none"><strong>Career Direction: </strong>Suitable for diversified or comprehensive work, various industries can be considered, especially:</p>`;
                    
                    adviceHtml += `<span data-lang="zh">管理、咨询、教育、创业、跨领域研究等需要平衡多种能力的工作。</span>`;
                    adviceHtml += `<span data-lang="en" style="display:none">Management, consulting, education, entrepreneurship, cross-field research and other work that requires balancing multiple abilities.</span>`;
                }
                
                // 健康与生活建议
                adviceHtml += `<p data-lang="zh"><strong>健康建议：</strong></p>`;
                adviceHtml += `<p data-lang="en" style="display:none"><strong>Health Suggestions:</strong></p>`;
                
                adviceHtml += `<ul data-lang="zh">`;
                if (dayWuxing === '木') {
                    adviceHtml += `<li>注意肝胆系统健康，保持情绪平和，避免压力过大。</li>`;
                    adviceHtml += `<li>建议多接触自然环境，参与户外活动，保持身心舒畅。</li>`;
                } else if (dayWuxing === '火') {
                    adviceHtml += `<li>注意心脏和血液循环系统，避免情绪过度兴奋。</li>`;
                    adviceHtml += `<li>建议保持充足睡眠，避免熬夜，适当控制辛辣刺激食物。</li>`;
                } else if (dayWuxing === '土') {
                    adviceHtml += `<li>注意消化系统健康，保持饮食规律，避免过度思虑。</li>`;
                    adviceHtml += `<li>建议增强脾胃功能，注意饮食均衡，避免过度劳累。</li>`;
                } else if (dayWuxing === '金') {
                    adviceHtml += `<li>注意呼吸系统和肺部健康，保持居所通风，避免接触过敏原。</li>`;
                    adviceHtml += `<li>建议保持情绪稳定，增强肺部功能的运动，如慢跑、游泳等。</li>`;
                } else if (dayWuxing === '水') {
                    adviceHtml += `<li>注意肾脏和泌尿系统，避免过度劳累，保持身体温暖。</li>`;
                    adviceHtml += `<li>建议适量补水但避免过饮，保持充足睡眠，避免熬夜。</li>`;
                }
                adviceHtml += `</ul>`;
                
                adviceHtml += `<ul data-lang="en" style="display:none">`;
                if (dayWuxing === '木') {
                    adviceHtml += `<li>Pay attention to liver and gallbladder health, maintain emotional calm, and avoid excessive stress.</li>`;
                    adviceHtml += `<li>Recommended to have more contact with natural environments, participate in outdoor activities, and maintain physical and mental well-being.</li>`;
                } else if (dayWuxing === '火') {
                    adviceHtml += `<li>Pay attention to heart and circulatory system health, avoid excessive emotional excitement.</li>`;
                    adviceHtml += `<li>Recommended to maintain sufficient sleep, avoid staying up late, and moderately control spicy and stimulating foods.</li>`;
                } else if (dayWuxing === '土') {
                    adviceHtml += `<li>Pay attention to digestive system health, maintain regular eating habits, and avoid overthinking.</li>`;
                    adviceHtml += `<li>Recommended to strengthen spleen and stomach function, pay attention to balanced diet, and avoid excessive fatigue.</li>`;
                } else if (dayWuxing === '金') {
                    adviceHtml += `<li>Pay attention to respiratory system and lung health, keep living spaces well-ventilated, and avoid contact with allergens.</li>`;
                    adviceHtml += `<li>Recommended to maintain emotional stability and engage in exercises that enhance lung function, such as jogging, swimming, etc.</li>`;
                } else if (dayWuxing === '水') {
                    adviceHtml += `<li>Pay attention to kidney and urinary system health, avoid excessive fatigue, and keep the body warm.</li>`;
                    adviceHtml += `<li>Recommended to drink water moderately but avoid excessive drinking, maintain sufficient sleep, and avoid staying up late.</li>`;
                }
                adviceHtml += `</ul>`;
                
                // 色彩与环境建议
                adviceHtml += `<p data-lang="zh"><strong>色彩与环境建议：</strong></p>`;
                adviceHtml += `<p data-lang="en" style="display:none"><strong>Color and Environment Suggestions:</strong></p>`;
                
                if (dayGanStrength === '旺' || dayWuxingScore > 30) {
                    // 日主过旺，建议用被克的五行颜色
                    const restrainingColor = getColorForElement(relationships[dayWuxing].被克);
                    const restrainingColorEn = getColorForElementEnglish(relationships[dayWuxing].被克);
                    adviceHtml += `<p data-lang="zh">建议在环境布置和服饰选择上增加${relationships[dayWuxing].被克}的色彩：${restrainingColor}，有助于平衡能量。</p>`;
                    adviceHtml += `<p data-lang="en" style="display:none">Recommended to increase colors of ${wuxingEnglishNames[relationships[dayWuxing].被克]} in environment arrangement and clothing choices: ${restrainingColorEn}, which helps balance energy.</p>`;
                } else if (dayGanStrength === '休' || dayGanStrength === '囚' || dayWuxingScore < 15) {
                    // 日主偏弱，建议用生的五行颜色
                    const supportingColor = getColorForElement(relationships[dayWuxing].被生);
                    const supportingColorEn = getColorForElementEnglish(relationships[dayWuxing].被生);
                    adviceHtml += `<p data-lang="zh">建议在环境布置和服饰选择上增加${dayWuxing}和${relationships[dayWuxing].被生}的色彩：${supportingColor}，有助于增强能量。</p>`;
                    adviceHtml += `<p data-lang="en" style="display:none">Recommended to increase colors of ${wuxingEnglishNames[dayWuxing]} and ${wuxingEnglishNames[relationships[dayWuxing].被生]} in environment arrangement and clothing choices: ${supportingColorEn}, which helps enhance energy.</p>`;
                } else {
                    // 日主平衡，建议用平衡的色彩
                    adviceHtml += `<p data-lang="zh">建议在环境布置和服饰选择上使用平衡的色彩组合，根据场合和需要灵活调整。</p>`;
                    adviceHtml += `<p data-lang="en" style="display:none">Recommended to use balanced color combinations in environment arrangement and clothing choices, adjusting flexibly according to occasions and needs.</p>`;
                }
                
                return adviceHtml;
            } catch (error) {
                console.error('生成五行建议出错:', error);
                return '生成五行建议时出错: ' + error.message;
            }
        }
        
        // 根据五行获取对应的颜色描述（中文）
        function getColorForElement(element) {
            switch (element) {
                case '木':
                    return '绿色、青色、淡蓝色';
                case '火':
                    return '红色、紫色、橙色';
                case '土':
                    return '黄色、棕色、米色';
                case '金':
                    return '白色、金色、银色';
                case '水':
                    return '黑色、深蓝色、灰色';
                default:
                    return '多种色彩';
            }
        }
        
        // 根据五行获取对应的颜色描述（英文）
        function getColorForElementEnglish(element) {
            switch (element) {
                case '木':
                    return 'green, cyan, light blue';
                case '火':
                    return 'red, purple, orange';
                case '土':
                    return 'yellow, brown, beige';
                case '金':
                    return 'white, gold, silver';
                case '水':
                    return 'black, dark blue, gray';
                default:
                    return 'various colors';
            }
        }
        
        // 渲染大运时间线
        function renderDayunTimeline(userData, analysisData) {
            try {
                if (!userData || !analysisData) {
                    console.error('缺少用户数据或分析数据');
                    return;
                }
                
                const timelineContainer = document.getElementById('dayun-timeline');
                if (!timelineContainer) return;
                
                // 用于计算大运的基本数据
                const gender = userData.gender;  // 性别：男/女
                const birthYear = parseInt(userData.birthDate.split('-')[0]);
                const birthMonth = parseInt(userData.birthDate.split('-')[1]);
                const birthDay = parseInt(userData.birthDate.split('-')[2]);
                const currentYear = new Date().getFullYear();
                
                // 获取八字月柱天干地支
                const monthGanzhi = analysisData.ganzhi.month;
                const monthZhi = monthGanzhi.charAt(1);
                
                // 大运起始年龄（简化计算，实际应根据精确的交运时间计算）
                // 阳男阴女顺排，阴男阳女逆排
                const isYang = ['甲', '丙', '戊', '庚', '壬'].includes(analysisData.ganzhi.year.charAt(0));
                const isMale = gender === '男';
                const isForward = (isYang && isMale) || (!isYang && !isMale);
                
                // 简单估算交运年龄（实际应该更精确计算）
                let startAge = 0;
                if (['寅', '午', '戌'].includes(monthZhi)) {
                    startAge = 1;  // 春天出生，1年交运
                } else if (['申', '子', '辰'].includes(monthZhi)) {
                    startAge = 6;  // 冬天出生，6年交运
                } else {
                    startAge = 3;  // 其他季节，约3年交运
                }
                
                // 构建大运数据
                const dayunCount = 8;  // 显示8个大运
                const tenGan = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
                const twelveZhi = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
                
                // 天干地支对应五行
                const ganWuxing = {
                    '甲': '木', '乙': '木',
                    '丙': '火', '丁': '火',
                    '戊': '土', '己': '土',
                    '庚': '金', '辛': '金',
                    '壬': '水', '癸': '水'
                };
                
                const zhiWuxing = {
                    '子': '水', '丑': '土',
                    '寅': '木', '卯': '木',
                    '辰': '土', '巳': '火',
                    '午': '火', '未': '土',
                    '申': '金', '酉': '金',
                    '戌': '土', '亥': '水'
                };
                
                // 计算起始大运和当前大运
                let dayunData = [];
                let monthGanIndex = tenGan.indexOf(monthGanzhi.charAt(0));
                let monthZhiIndex = twelveZhi.indexOf(monthGanzhi.charAt(1));

                // 准备大运数据
                for (let i = 0; i < dayunCount; i++) {
                    let ganIndex = -1;
                    let zhiIndex = -1;
                    
                    if (isForward) {
                        ganIndex = (monthGanIndex + i) % 10;
                        zhiIndex = (monthZhiIndex + i) % 12;
                    } else {
                        ganIndex = (monthGanIndex - i + 10) % 10;
                        zhiIndex = (monthZhiIndex - i + 12) % 12;
                    }
                    
                    const gan = tenGan[ganIndex];
                    const zhi = twelveZhi[zhiIndex];
                    const ganzhi = gan + zhi;
                    
                    // 计算大运开始和结束年
                    const startYear = birthYear + startAge + i * 10;
                    const endYear = startYear + 9;
                    
                    // 确定是否为当前大运
                    const isCurrent = currentYear >= startYear && currentYear <= endYear;
                    
                    dayunData.push({
                        ganzhi: ganzhi,
                        gan: gan,
                        zhi: zhi,
                        ganElement: ganWuxing[gan],
                        zhiElement: zhiWuxing[zhi],
                        startYear: startYear,
                        endYear: endYear,
                        startAge: startAge + i * 10,
                        endAge: startAge + (i+1) * 10 - 1,
                        isCurrent: isCurrent,
                        nayin: getNayin(ganzhi) || '未知'
                    });
                }
                
                // 构建HTML
                let html = `
                    <div class="dayun-flow-direction">
                        <span class="flow-label" data-lang="zh">大运流向：</span>
                        <span class="flow-label" data-lang="en">Destiny Flow Direction: </span>
                        <span class="flow-arrow">${isForward ? '→' : '←'}</span>
                        <span data-lang="zh">${isForward ? '顺行' : '逆行'}</span>
                        <span data-lang="en">${isForward ? 'Forward' : 'Reverse'}</span>
                    </div>
                    
                    <div class="dayun-timeline">
                        ${dayunData.map((dayun, index) => `
                            <div class="dayun-item">
                                <div class="dayun-dot ${dayun.isCurrent ? 'dayun-current' : ''}"></div>
                                <div class="dayun-content">
                                    <div class="dayun-age">
                                        <span data-lang="zh">${dayun.startAge}-${dayun.endAge}岁</span>
                                        <span data-lang="en">${dayun.startAge}-${dayun.endAge} years</span>
                                    </div>
                                    <div class="dayun-year">${dayun.startYear}-${dayun.endYear}</div>
                                    <div class="dayun-ganzhi ${getWuxingColorClass(dayun.ganElement)}">${dayun.ganzhi}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="dayun-analysis">
                        <div class="dayun-table-container">
                            <h3 data-lang="zh">大运详情</h3>
                            <h3 data-lang="en">Destiny Period Details</h3>
                            <table class="dayun-table">
                                <thead>
                                    <tr data-lang="zh">
                                        <th>大运</th>
                                        <th>干支</th>
                                        <th>纳音</th>
                                        <th>年龄</th>
                                        <th>年份</th>
                                        <th>天干五行</th>
                                        <th>地支五行</th>
                                        <th>与日主</th>
                                    </tr>
                                    <tr data-lang="en" style="display:none">
                                        <th>Period</th>
                                        <th>Stem-Branch</th>
                                        <th>Hidden Element</th>
                                        <th>Age</th>
                                        <th>Years</th>
                                        <th>Heavenly Element</th>
                                        <th>Earthly Element</th>
                                        <th>Day Master Relation</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${dayunData.map((dayun, index) => {
                                        // 获取天干十神
                                        const dayGan = analysisData.ganzhi.day.charAt(0);
                                        const shishen = getShishenRelation(dayGan, dayun.gan);
                                        
                                        return `
                                            <tr class="${dayun.isCurrent ? 'current-dayun' : ''}" onclick="showDayunDetail('${dayun.ganzhi}', ${index}, ${dayun.startYear}, ${dayun.endYear})" data-lang="zh">
                                                <td>${index+1}运</td>
                                                <td class="ganzhi-cell">${dayun.ganzhi}</td>
                                                <td>${dayun.nayin}</td>
                                                <td>${dayun.startAge}-${dayun.endAge}岁</td>
                                                <td>${dayun.startYear}-${dayun.endYear}</td>
                                                <td class="element-cell element-${dayun.ganElement.toLowerCase()}">${dayun.ganElement}</td>
                                                <td class="element-cell element-${dayun.zhiElement.toLowerCase()}">${dayun.zhiElement}</td>
                                                <td>${shishen}</td>
                                            </tr>
                                            <tr class="${dayun.isCurrent ? 'current-dayun' : ''}" onclick="showDayunDetail('${dayun.ganzhi}', ${index}, ${dayun.startYear}, ${dayun.endYear})" data-lang="en" style="display:none">
                                                <td>Period ${index+1}</td>
                                                <td class="ganzhi-cell">${dayun.ganzhi}</td>
                                                <td>${translateNayin(dayun.nayin)}</td>
                                                <td>${dayun.startAge}-${dayun.endAge} years</td>
                                                <td>${dayun.startYear}-${dayun.endYear}</td>
                                                <td class="element-cell element-${dayun.ganElement.toLowerCase()}">${translateWuxing(dayun.ganElement)}</td>
                                                <td class="element-cell element-${dayun.zhiElement.toLowerCase()}">${translateWuxing(dayun.zhiElement)}</td>
                                                <td>${translateShishen(shishen)}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="dayun-help">
                            <p><strong>${getCurrentDayunInfo(dayunData)}</strong></p>
                            <p>${getDayunTransitionInfo(dayunData, analysisData)}</p>
                        </div>
                        
                        <div class="flow-year-section">
                            <h3 data-lang="zh">流年信息</h3>
                            <h3 data-lang="en">Annual Destiny Information</h3>
                            <p>
                                <span data-lang="zh">当前流年: ${getCurrentFlowYear(currentYear)}</span>
                                <span data-lang="en">Current Year: ${getCurrentFlowYear(currentYear)}</span>
                            </p>
                            <p data-lang="zh">未来五年流年:</p>
                            <p data-lang="en">Next Five Years:</p>
                            <div class="flow-year-grid">
                                ${generateFutureFlowYears(currentYear, 5, true)}
                            </div>
                        </div>
                    </div>`;
                
                // 更新到页面
                timelineContainer.innerHTML = html;
                
            } catch (error) {
                console.error('渲染大运时间线出错:', error);
                document.getElementById('dayun-timeline').innerHTML = `
                    <p class="text-center">大运数据计算错误: ${error.message}</p>
                `;
            }
        }
        
        // 纳音翻译函数
        function translateNayin(nayin) {
            const nayinMap = {
                '海中金': 'Ocean Gold',
                '炉中火': 'Furnace Fire',
                '大林木': 'Big Forest Wood',
                '路旁土': 'Roadside Earth',
                '剑锋金': 'Sword Gold',
                '山头火': 'Mountain Fire',
                '涧下水': 'Valley Water',
                '城墙土': 'City Wall Earth',
                '白蜡金': 'White Wax Gold',
                '杨柳木': 'Willow Wood',
                '泉中水': 'Spring Water',
                '屋上土': 'Roof Earth',
                '霹雳火': 'Lightning Fire',
                '松柏木': 'Pine Wood',
                '长流水': 'Long River Water',
                '沙中金': 'Sand Gold',
                '山下火': 'Mountain Foot Fire',
                '平地木': 'Ground Wood',
                '壁上土': 'Wall Earth',
                '金箔金': 'Gold Foil',
                '覆灯火': 'Lamp Fire',
                '天河水': 'Sky River Water',
                '大驿土': 'Station Earth',
                '钗钏金': 'Hairpin Gold',
                '桑柘木': 'Mulberry Wood',
                '大溪水': 'Big Stream Water',
                '沙中土': 'Sand Earth',
                '天上火': 'Sky Fire',
                '石榴木': 'Pomegranate Wood',
                '大海水': 'Ocean Water',
                '沙中土': 'Sand Earth',
                '天上火': 'Sky Fire',
                '石榴木': 'Pomegranate Wood',
                '大海水': 'Ocean Water'
            };
            return nayinMap[nayin] || nayin;
        }

        // 五行翻译函数
        // 全局五行映射表
const wuxingMap = {
    '甲': '木',
    '乙': '木',
    '丙': '火',
    '丁': '火',
    '戊': '土',
    '己': '土',
    '庚': '金',
    '辛': '金',
    '壬': '水',
    '癸': '水',
    '子': '水',
    '丑': '土',
    '寅': '木',
    '卯': '木',
    '辰': '土',
    '巳': '火',
    '午': '火',
    '未': '土',
    '申': '金',
    '酉': '金',
    '戌': '土',
    '亥': '水'
};

function translateWuxing(wuxing) {
    const wuxingEnMap = {
        '木': 'Wood',
        '火': 'Fire',
        '土': 'Earth',
        '金': 'Metal',
        '水': 'Water'
    };
    return wuxingEnMap[wuxing] || wuxing;
        }

        // 十神翻译函数
        function translateShishen(shishen) {
            const shishenMap = {
                '正印': 'Direct Resource',
                '偏印': 'Indirect Resource',
                '正官': 'Direct Officer',
                '七杀': 'Seven Killing',
                '正财': 'Direct Wealth',
                '偏财': 'Indirect Wealth',
                '食神': 'Eating God',
                '伤官': 'Hurting Officer',
                '比肩': 'Equal',
                '劫财': 'Rob Wealth'
            };
            return shishenMap[shishen] || shishen;
        }
        
        // 生成健康与五行调节总结 - 直接给出具体行动建议
        function generateHealthSummary(analysisData) {
            try {
                if (!analysisData || !analysisData.wuxing) {
                    return '<p class="text-center">缺少分析数据，无法生成健康建议</p>';
                }
                
                // 获取五行数据和日主
                const wuxingStats = analysisData.wuxing;
                const dayGan = analysisData.ganzhi?.day?.charAt(0);
                
                if (!dayGan) {
                    return '<p class="text-center">缺少日主数据，无法生成健康建议</p>';
                }
                
                // 天干对应五行
                const ganWuxing = {
                    '甲': '木', '乙': '木',
                    '丙': '火', '丁': '火',
                    '戊': '土', '己': '土',
                    '庚': '金', '辛': '金',
                    '壬': '水', '癸': '水'
                };
                
                // 日主五行
                const dayMasterElement = ganWuxing[dayGan] || '未知';
                
                // 确定过旺和不足的元素
                const excessElements = [];
                const deficientElements = [];
                
                Object.keys(wuxingStats).forEach(element => {
                    const percentage = wuxingStats[element];
                    if (percentage >= 30) {
                        excessElements.push(element);
                    } else if (percentage <= 10) {
                        deficientElements.push(element);
                    }
                });
                
                // 日主状态
                let dayMasterStatus = '平衡';
                const dayMasterPercentage = wuxingStats[dayMasterElement] || 0;
                
                if (dayMasterPercentage >= 30) {
                    dayMasterStatus = '旺';
                } else if (dayMasterPercentage <= 10) {
                    dayMasterStatus = '弱';
                }
                
                // 创建直接的健康建议
                let healthAdvice = `
                    <div class="health-direct-advice">
                        <h4 class="text-center" data-lang="zh">您需要采取的具体行动</h4>
                        <h4 class="text-center" data-lang="en" style="display:none">Specific Actions You Need to Take</h4>
                        
                        <div class="advice-grid">
                `;
                
                // 为不同日主状态提供直接的建议
                if (dayMasterStatus === '旺') {
                    healthAdvice += `
                        <div class="advice-card">
                            <h5 data-lang="zh">您的日主五行（${dayMasterElement}）过旺，必须做：</h5>
                            <h5 data-lang="en" style="display:none">Your Day Master Element (${dayMasterElement}) is excessive, you must:</h5>
                            <ul>
                    `;
                    
                    // 根据日主五行提供抑制建议
                    switch(dayMasterElement) {
                        case '木':
                            healthAdvice += `
                                <li data-lang="zh"><strong>居家布置：</strong>在西方位置摆放金属饰品，减少绿色植物</li>
                                <li data-lang="en" style="display:none"><strong>Home Arrangement:</strong> Place metal decorations in the west, reduce green plants</li>
                                <li data-lang="zh"><strong>饮食调整：</strong>减少酸味食物，增加辛辣食物和白色食物</li>
                                <li data-lang="en" style="display:none"><strong>Diet Adjustment:</strong> Reduce sour foods, increase spicy and white-colored foods</li>
                                <li data-lang="zh"><strong>情绪管理：</strong>每天进行15分钟冥想，控制脾气，避免冲动</li>
                                <li data-lang="en" style="display:none"><strong>Emotion Management:</strong> Practice 15 minutes of meditation daily, control your temper, avoid impulsiveness</li>
                                <li data-lang="zh"><strong>着装选择：</strong>多穿白色、金色系衣物，减少绿色系</li>
                                <li data-lang="en" style="display:none"><strong>Clothing Choice:</strong> Wear more white and gold-colored clothes, reduce green colors</li>
                            `;
                            break;
                        case '火':
                            healthAdvice += `
                                <li data-lang="zh"><strong>居家布置：</strong>在北方位置摆放水景，如鱼缸或水培植物</li>
                                <li data-lang="en" style="display:none"><strong>Home Arrangement:</strong> Place water features in the north, such as fish tanks or hydroponic plants</li>
                                <li data-lang="zh"><strong>饮食调整：</strong>减少辛辣食物，增加咸味食物和黑色食物</li>
                                <li data-lang="en" style="display:none"><strong>Diet Adjustment:</strong> Reduce spicy foods, increase salty and black-colored foods</li>
                                <li data-lang="zh"><strong>情绪管理：</strong>睡前一小时避免强光刺激，保持情绪平稳</li>
                                <li data-lang="en" style="display:none"><strong>Emotion Management:</strong> Avoid strong light stimulation one hour before bedtime, maintain emotional stability</li>
                                <li data-lang="zh"><strong>着装选择：</strong>多穿黑色、蓝色系衣物，减少红色系</li>
                                <li data-lang="en" style="display:none"><strong>Clothing Choice:</strong> Wear more black and blue-colored clothes, reduce red colors</li>
                            `;
                            break;
                        case '土':
                            healthAdvice += `
                                <li data-lang="zh"><strong>居家布置：</strong>在东方增加绿色植物，减少黄色装饰</li>
                                <li data-lang="en" style="display:none"><strong>Home Arrangement:</strong> Add green plants in the east, reduce yellow decorations</li>
                                <li data-lang="zh"><strong>饮食调整：</strong>减少甜食和淀粉，增加酸性食物如柠檬、山楂</li>
                                <li data-lang="en" style="display:none"><strong>Diet Adjustment:</strong> Reduce sweets and starches, increase acidic foods like lemon and hawthorn</li>
                                <li data-lang="zh"><strong>运动要求：</strong>每天进行30分钟步行或舒展运动</li>
                                <li data-lang="en" style="display:none"><strong>Exercise Requirement:</strong> Take 30 minutes of walking or stretching exercises daily</li>
                                <li data-lang="zh"><strong>着装选择：</strong>多穿绿色系衣物，减少黄色、棕色系</li>
                                <li data-lang="en" style="display:none"><strong>Clothing Choice:</strong> Wear more green-colored clothes, reduce yellow and brown colors</li>
                            `;
                            break;
                        case '金':
                            healthAdvice += `
                                <li data-lang="zh"><strong>居家布置：</strong>在南方位置增加红色装饰或灯光</li>
                                <li data-lang="en" style="display:none"><strong>Home Arrangement:</strong> Add red decorations or lighting in the south</li>
                                <li data-lang="zh"><strong>饮食调整：</strong>减少辛辣食物，增加苦味食物如咖啡、茶</li>
                                <li data-lang="en" style="display:none"><strong>Diet Adjustment:</strong> Reduce spicy foods, increase bitter foods like coffee and tea</li>
                                <li data-lang="zh"><strong>环境调整：</strong>保持室内湿度，避免过于干燥</li>
                                <li data-lang="en" style="display:none"><strong>Environment Adjustment:</strong> Maintain indoor humidity, avoid excessive dryness</li>
                                <li data-lang="zh"><strong>着装选择：</strong>多穿红色、紫色系衣物，减少白色、银色系</li>
                                <li data-lang="en" style="display:none"><strong>Clothing Choice:</strong> Wear more red and purple-colored clothes, reduce white and silver colors</li>
                            `;
                            break;
                        case '水':
                            healthAdvice += `
                                <li data-lang="zh"><strong>居家布置：</strong>在中央或西南位置增加黄色、棕色装饰</li>
                                <li data-lang="en" style="display:none"><strong>Home Arrangement:</strong> Add yellow and brown decorations in the center or southwest</li>
                                <li data-lang="zh"><strong>饮食调整：</strong>减少咸味食物，增加甜味食物</li>
                                <li data-lang="en" style="display:none"><strong>Diet Adjustment:</strong> Reduce salty foods, increase sweet foods</li>
                                <li data-lang="zh"><strong>保暖措施：</strong>特别注意腰腿部位保暖，避免受凉</li>
                                <li data-lang="en" style="display:none"><strong>Warming Measures:</strong> Pay special attention to keeping your waist and legs warm, avoid getting cold</li>
                                <li data-lang="zh"><strong>着装选择：</strong>多穿黄色、棕色系衣物，减少黑色、蓝色系</li>
                                <li data-lang="en" style="display:none"><strong>Clothing Choice:</strong> Wear more yellow and brown-colored clothes, reduce black and blue colors</li>
                            `;
                            break;
                    }
                    
                    healthAdvice += `
                            </ul>
                        </div>
                    `;
                } else if (dayMasterStatus === '弱') {
                    healthAdvice += `
                        <div class="advice-card">
                            <h5 data-lang="zh">您的日主五行（${dayMasterElement}）偏弱，必须做：</h5>
                            <h5 data-lang="en" style="display:none">Your Day Master Element (${dayMasterElement}) is weak, you must:</h5>
                            <ul>
                    `;
                    
                    // 根据日主五行提供补益建议
                    switch(dayMasterElement) {
                        case '木':
                            healthAdvice += `
                                <li data-lang="zh"><strong>居家布置：</strong>在东方位置增加绿色植物，保持充足光照</li>
                                <li data-lang="en" style="display:none"><strong>Home Arrangement:</strong> Add green plants in the east, maintain sufficient lighting</li>
                                <li data-lang="zh"><strong>饮食调整：</strong>每天食用绿叶蔬菜，每周至少一次酸味食物</li>
                                <li data-lang="en" style="display:none"><strong>Diet Adjustment:</strong> Eat leafy greens daily, have sour foods at least once a week</li>
                                <li data-lang="zh"><strong>户外活动：</strong>每周至少两次森林或公园散步，接触自然</li>
                                <li data-lang="en" style="display:none"><strong>Outdoor Activities:</strong> Take walks in forests or parks at least twice a week, connect with nature</li>
                                <li data-lang="zh"><strong>着装选择：</strong>多穿绿色系衣物，家中可用绿色窗帘或饰品</li>
                                <li data-lang="en" style="display:none"><strong>Clothing Choice:</strong> Wear more green-colored clothes, use green curtains or decorations at home</li>
                            `;
                            break;
                        case '火':
                            healthAdvice += `
                                <li><strong>居家布置：</strong>在南方增加红色装饰或灯光，保持明亮</li>
                                <li><strong>阳光接触：</strong>每日确保至少20分钟阳光照射，早晨最佳</li>
                                <li><strong>饮食调整：</strong>适量增加辛辣和温性食物，如生姜、红枣</li>
                                <li><strong>社交活动：</strong>增加社交活动，保持积极情绪</li>
                            `;
                            break;
                        case '土':
                            healthAdvice += `
                                <li><strong>居家布置：</strong>在中央位置放置黄色、棕色装饰</li>
                                <li><strong>作息规律：</strong>严格执行规律作息表，固定时间进食</li>
                                <li><strong>饮食调整：</strong>适量增加米面等主食，每日一小勺蜂蜜</li>
                                <li><strong>环境稳定：</strong>减少居所变动，创造稳定环境</li>
                            `;
                            break;
                        case '金':
                            healthAdvice += `
                                <li><strong>居家布置：</strong>在西方增加金属饰品，如相框或装饰品</li>
                                <li><strong>环境整洁：</strong>保持居所整洁有序，物品规整摆放</li>
                                <li><strong>饮食调整：</strong>增加白色食物摄入，如萝卜、白菜、梨</li>
                                <li><strong>生活规律：</strong>建立严格的时间表，增强自律性</li>
                            `;
                            break;
                        case '水':
                            healthAdvice += `
                                <li><strong>居家布置：</strong>在北方摆放水景或蓝色装饰</li>
                                <li><strong>饮水习惯：</strong>每天至少饮水2000ml，分次饮用</li>
                                <li><strong>饮食调整：</strong>适量增加咸味食物和黑色食物，如黑豆、黑芝麻</li>
                                <li><strong>冥想活动：</strong>每天进行15分钟冥想，增强思考能力</li>
                            `;
                            break;
                    }
                    
                    healthAdvice += `
                            </ul>
                        </div>
                    `;
                } else {
                    healthAdvice += `
                        <div class="advice-card">
                            <h5 data-lang="zh">您的日主五行（${dayMasterElement}）平衡，建议做：</h5>
                            <h5 data-lang="en" style="display:none">Your Day Master Element (${dayMasterElement}) is balanced, recommended to:</h5>
                            <ul data-lang="zh">
                                <li><strong>维持平衡：</strong>保持现有的生活习惯和规律作息</li>
                                <li><strong>均衡饮食：</strong>确保五种口味（酸甜苦辣咸）均衡摄入</li>
                                <li><strong>环境布置：</strong>居住环境使用均衡色彩，避免某一色系过多</li>
                                <li><strong>适度运动：</strong>保持每周3-5次中等强度运动，30分钟/次</li>
                            </ul>
                            <ul data-lang="en" style="display:none">
                                <li><strong>Maintain Balance:</strong> Keep current lifestyle habits and regular schedule</li>
                                <li><strong>Balanced Diet:</strong> Ensure balanced intake of five flavors (sour, sweet, bitter, spicy, salty)</li>
                                <li><strong>Environment Arrangement:</strong> Use balanced colors in living environment, avoid excess of any single color</li>
                                <li><strong>Moderate Exercise:</strong> Maintain moderate intensity exercise 3-5 times per week, 30 minutes each time</li>
                            </ul>
                        </div>
                    `;
                }
                
                // 针对不足的五行元素提供直接建议
                if (deficientElements.length > 0) {
                    healthAdvice += `
                        <div class="advice-card">
                            <h5 data-lang="zh">必须补充的五行：</h5>
                            <h5 data-lang="en" style="display:none">Elements That Must Be Supplemented:</h5>
                            <ul data-lang="zh">
                    `;
                    
                    deficientElements.forEach(element => {
                        switch(element) {
                            case '木':
                                healthAdvice += `
                                    <li><strong>木行补充：</strong>每天食用一份绿叶蔬菜，在东方位置摆放活体植物，使用绿色装饰品</li>
                                `;
                                break;
                            case '火':
                                healthAdvice += `
                                    <li><strong>火行补充：</strong>每天晒15分钟太阳，在南方位置放置红色装饰，每周适量食用一次辛辣食物</li>
                                `;
                                break;
                            case '土':
                                healthAdvice += `
                                    <li><strong>土行补充：</strong>在中央位置放置黄色装饰，建立固定作息表，每天食用温和食物如山药、小米</li>
                                `;
                                break;
                            case '金':
                                healthAdvice += `
                                    <li><strong>金行补充：</strong>在西方位置增加金属饰品，保持环境整洁，每周食用两次白色食物如白萝卜</li>
                                `;
                                break;
                            case '水':
                                healthAdvice += `
                                    <li><strong>水行补充：</strong>每天饮水2000ml，在北方位置摆放水景或蓝色装饰，每周食用两次黑色食物如黑豆</li>
                                `;
                                break;
                        }
                    });
                    
                    healthAdvice += `
                            </ul>
                            <ul data-lang="en" style="display:none">
                    `;
                    
                    deficientElements.forEach(element => {
                        switch(element) {
                            case '木':
                                healthAdvice += `
                                    <li><strong>Wood Element Supplement:</strong> Eat one serving of leafy greens daily, place living plants in the east, use green decorations</li>
                                `;
                                break;
                            case '火':
                                healthAdvice += `
                                    <li><strong>Fire Element Supplement:</strong> Get 15 minutes of sunlight daily, place red decorations in the south, consume spicy food moderately once a week</li>
                                `;
                                break;
                            case '土':
                                healthAdvice += `
                                    <li><strong>Earth Element Supplement:</strong> Place yellow decorations in the center, establish a fixed schedule, eat mild foods like yam and millet daily</li>
                                `;
                                break;
                            case '金':
                                healthAdvice += `
                                    <li><strong>Metal Element Supplement:</strong> Add metal decorations in the west, keep environment clean, eat white foods like radish twice a week</li>
                                `;
                                break;
                            case '水':
                                healthAdvice += `
                                    <li><strong>Water Element Supplement:</strong> Drink 2000ml water daily, place water features or blue decorations in the north, eat black foods like black beans twice a week</li>
                                `;
                                break;
                        }
                    });
                    
                    healthAdvice += `
                            </ul>
                        </div>
                    `;
                }
                
                
                // 针对过旺的五行元素提供直接建议
                if (excessElements.length > 0) {
                    healthAdvice += `
                        <div class="advice-card">
                            <h5 data-lang="zh">必须抑制的五行：</h5>
                            <h5 data-lang="en" style="display:none">Elements That Must Be Restrained:</h5>
                            <ul data-lang="zh">
                    `;
                    
                    excessElements.forEach(element => {
                        switch(element) {
                            case '木':
                                healthAdvice += `
                                    <li><strong>木行抑制：</strong>放置金属饰品在西方，减少酸味食物摄入，控制情绪波动，每天进行深呼吸练习</li>
                                `;
                                break;
                            case '火':
                                healthAdvice += `
                                    <li><strong>火行抑制：</strong>在北方放置水景，避免过度阳光直射，减少辛辣食物，睡前一小时避免强光</li>
                                `;
                                break;
                            case '土':
                                healthAdvice += `
                                    <li><strong>土行抑制：</strong>增加绿色植物在东方，减少甜食和精细淀粉，每天至少走路30分钟，避免久坐</li>
                                `;
                                break;
                            case '金':
                                healthAdvice += `
                                    <li><strong>金行抑制：</strong>在南方位置增加红色装饰，使用加湿器保持湿度，减少辛辣刺激性食物</li>
                                `;
                                break;
                            case '水':
                                healthAdvice += `
                                    <li><strong>水行抑制：</strong>在中央增加黄色装饰，减少咸味和寒性食物，保持足部和腰部温暖，避免受凉</li>
                                `;
                                break;
                        }
                    });
                    
                    healthAdvice += `
                            </ul>
                            <ul data-lang="en" style="display:none">
                    `;
                    
                    excessElements.forEach(element => {
                        switch(element) {
                            case '木':
                                healthAdvice += `
                                    <li><strong>Wood Element Restraint:</strong> Place metal decorations in the west, reduce intake of sour foods, control emotional fluctuations, practice deep breathing daily</li>
                                `;
                                break;
                            case '火':
                                healthAdvice += `
                                    <li><strong>Fire Element Restraint:</strong> Place water features in the north, avoid excessive direct sunlight, reduce spicy foods, avoid strong light one hour before bedtime</li>
                                `;
                                break;
                            case '土':
                                healthAdvice += `
                                    <li><strong>Earth Element Restraint:</strong> Add green plants in the east, reduce sweets and refined starches, walk at least 30 minutes daily, avoid sitting for long periods</li>
                                `;
                                break;
                            case '金':
                                healthAdvice += `
                                    <li><strong>Metal Element Restraint:</strong> Add red decorations in the south, use humidifiers to maintain humidity, reduce spicy and stimulating foods</li>
                                `;
                                break;
                            case '水':
                                healthAdvice += `
                                    <li><strong>Water Element Restraint:</strong> Add yellow decorations in the center, reduce salty and cold-natured foods, keep feet and waist warm, avoid getting cold</li>
                                `;
                                break;
                        }
                    });
                    
                    healthAdvice += `
                            </ul>
                        </div>
                    `;
                }
                
                // 四季养生核心要点
                healthAdvice += `
                    <div class="advice-card">
                        <h5 data-lang="zh">四季养生具体做法：</h5>
                        <h5 data-lang="en" style="display:none">Seasonal Health Practices:</h5>
                        <div class="season-grid">
                            <div class="season-item">
                                <h5 data-lang="zh">春季</h5>
                                <h5 data-lang="en" style="display:none">Spring</h5>
                                <ul data-lang="zh">
                                    <li>食用绿叶蔬菜和微酸食物</li>
                                    <li>每天做5分钟伸展运动</li>
                                    <li>避免情绪激动和焦虑</li>
                                </ul>
                                <ul data-lang="en" style="display:none">
                                    <li>Eat leafy greens and slightly sour foods</li>
                                    <li>Do 5 minutes of stretching exercises daily</li>
                                    <li>Avoid emotional agitation and anxiety</li>
                                </ul>
                            </div>
                            <div class="season-item">
                                <h5 data-lang="zh">夏季</h5>
                                <h5 data-lang="en" style="display:none">Summer</h5>
                                <ul data-lang="zh">
                                    <li>多饮温水，少食辛辣</li>
                                    <li>避免长时间阳光直射</li>
                                    <li>保持11点前入睡</li>
                                </ul>
                                <ul data-lang="en" style="display:none">
                                    <li>Drink more warm water, reduce spicy foods</li>
                                    <li>Avoid prolonged direct sunlight</li>
                                    <li>Maintain bedtime before 11 PM</li>
                                </ul>
                            </div>
                            <div class="season-item">
                                <h5 data-lang="zh">秋季</h5>
                                <h5 data-lang="en" style="display:none">Autumn</h5>
                                <ul data-lang="zh">
                                    <li>食用梨、蜂蜜等润肺食物</li>
                                    <li>增加室内湿度</li>
                                    <li>适当增加运动量</li>
                                </ul>
                                <ul data-lang="en" style="display:none">
                                    <li>Eat lung-moistening foods like pears and honey</li>
                                    <li>Increase indoor humidity</li>
                                    <li>Moderately increase exercise</li>
                                </ul>
                            </div>
                            <div class="season-item">
                                <h5 data-lang="zh">冬季</h5>
                                <h5 data-lang="en" style="display:none">Winter</h5>
                                <ul data-lang="zh">
                                    <li>保暖腰部和足部</li>
                                    <li>食用温补食物如红枣、姜</li>
                                    <li>保持充足睡眠</li>
                                </ul>
                                <ul data-lang="en" style="display:none">
                                    <li>Keep waist and feet warm</li>
                                    <li>Eat warming foods like red dates and ginger</li>
                                    <li>Maintain sufficient sleep</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <p class="disclaimer" data-lang="zh">注：以上建议仅供参考，具体健康问题请咨询专业医疗人员。</p>
                    <p class="disclaimer" data-lang="en" style="display:none">Note: The above suggestions are for reference only. For specific health issues, please consult professional medical personnel.</p>
                </div>
                `;
                
                return healthAdvice;
            } catch (error) {
                console.error('生成健康总结时出错:', error);
                return `<p class="text-center">健康分析生成错误: ${error.message}</p>`;
            }
        }
        
        // 获取十神关系
        function getShishenRelation(dayGan, currentGan) {
            // 十天干顺序
            const stems = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
            
            // 五行属性对应表
            const wuxing = {
                '甲': '木', '乙': '木',
                '丙': '火', '丁': '火',
                '戊': '土', '己': '土',
                '庚': '金', '辛': '金',
                '壬': '水', '癸': '水'
            };
            
            // 获取日主和当前天干的五行
            const dayWuxing = wuxing[dayGan];
            const currentWuxing = wuxing[currentGan];
            
            // 阴阳性
            const isYang = (gan) => stems.indexOf(gan) % 2 === 0; // 偶数位的是阳干
            const dayYang = isYang(dayGan);
            const currentYang = isYang(currentGan);
            
            // 确定两者的阴阳关系
            const sameYinYang = (dayYang === currentYang);
            
            // 根据五行关系和阴阳确定十神
            if (dayWuxing === currentWuxing) {
                // 比劫
                return sameYinYang ? '比肩' : '劫财';
            } else if (
                (dayWuxing === '木' && currentWuxing === '火') ||
                (dayWuxing === '火' && currentWuxing === '土') ||
                (dayWuxing === '土' && currentWuxing === '金') ||
                (dayWuxing === '金' && currentWuxing === '水') ||
                (dayWuxing === '水' && currentWuxing === '木')
            ) {
                // 食伤
                return sameYinYang ? '食神' : '伤官';
            } else if (
                (dayWuxing === '木' && currentWuxing === '土') ||
                (dayWuxing === '火' && currentWuxing === '金') ||
                (dayWuxing === '土' && currentWuxing === '水') ||
                (dayWuxing === '金' && currentWuxing === '木') ||
                (dayWuxing === '水' && currentWuxing === '火')
            ) {
                // 财星
                return sameYinYang ? '正财' : '偏财';
            } else if (
                (dayWuxing === '木' && currentWuxing === '金') ||
                (dayWuxing === '火' && currentWuxing === '水') ||
                (dayWuxing === '土' && currentWuxing === '木') ||
                (dayWuxing === '金' && currentWuxing === '火') ||
                (dayWuxing === '水' && currentWuxing === '土')
            ) {
                // 官杀
                return sameYinYang ? '正官' : '七杀';
            } else if (
                (dayWuxing === '金' && currentWuxing === '土') ||
                (dayWuxing === '水' && currentWuxing === '金') ||
                (dayWuxing === '木' && currentWuxing === '水') ||
                (dayWuxing === '火' && currentWuxing === '木') ||
                (dayWuxing === '土' && currentWuxing === '火')
            ) {
                // 印枭
                return sameYinYang ? '正印' : '偏印';
            }
            
            return '未知';
        }
        
        // 获取五行颜色类
        function getWuxingColorClass(element) {
            const colorMap = {
                '木': 'element-wood',
                '火': 'element-fire',
                '土': 'element-earth',
                '金': 'element-metal',
                '水': 'element-water'
            };
            
            return colorMap[element] || '';
        }
        
        // 获取当前大运信息
        function getCurrentDayunInfo(dayunData) {
            const currentDayun = dayunData.find(dayun => dayun.isCurrent);
            
            if (!currentDayun) {
                return '暂无当前大运信息';
            }
            
            const zhInfo = `${currentDayun.ganzhi}大运 (${currentDayun.startYear}-${currentDayun.endYear})，
                    天干五行为${currentDayun.ganElement}，地支五行为${currentDayun.zhiElement}，
                    纳音为${currentDayun.nayin}`;
            const enInfo = `Destiny Period ${currentDayun.ganzhi} (${currentDayun.startYear}-${currentDayun.endYear}),
                    Heavenly Stem Element: ${currentDayun.ganElement}, Earthly Branch Element: ${currentDayun.zhiElement},
                    Hidden Element: ${currentDayun.nayin}`;
            
            return `<div data-lang="zh">${zhInfo}</div><div data-lang="en" style="display:none">${enInfo}</div>`;
        }
        
        // 获取大运变化信息
        function getDayunTransitionInfo(dayunData, analysisData) {
            const currentIndex = dayunData.findIndex(dayun => dayun.isCurrent);
            
            if (currentIndex === -1 || currentIndex === dayunData.length - 1) {
                return '无法获取大运变化信息';
            }
            
            const currentDayun = dayunData[currentIndex];
            const nextDayun = dayunData[currentIndex + 1];
            
            // 分析日主与大运之间的关系
            const zhInfo = `当前为${currentDayun.ganzhi}大运，
                   到${nextDayun.startYear}年将转入${nextDayun.ganzhi}大运，
                   五行从${currentDayun.ganElement}转为${nextDayun.ganElement}，
                   注意${currentDayun.endYear}年前后的人生变化。`;
            const enInfo = `Currently in Destiny Period ${currentDayun.ganzhi},
                   transitioning to ${nextDayun.ganzhi} Period in ${nextDayun.startYear},
                   Element changing from ${currentDayun.ganElement} to ${nextDayun.ganElement},
                   pay attention to life changes around ${currentDayun.endYear}.`;
            
            return `<div data-lang="zh">${zhInfo}</div><div data-lang="en" style="display:none">${enInfo}</div>`;
        }
        
        // 获取当前流年信息
        function getCurrentFlowYear(currentYear) {
            const heavenlyStems = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
            const earthlyBranches = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
            
            // 计算干支纪年
            const stemIndex = (currentYear - 4) % 10;
            const branchIndex = (currentYear - 4) % 12;
            
            const ganzhiYear = heavenlyStems[stemIndex] + earthlyBranches[branchIndex];
            
            // 获取五行
            const ganWuxing = {
                '甲': '木', '乙': '木',
                '丙': '火', '丁': '火',
                '戊': '土', '己': '土',
                '庚': '金', '辛': '金',
                '壬': '水', '癸': '水'
            };
            
            const wuxing = ganWuxing[heavenlyStems[stemIndex]];
            
            return `${currentYear}年，${ganzhiYear}年，五行属${wuxing}`;
        }
        
        // 生成未来流年信息
        function generateFutureFlowYears(currentYear, count, withTranslation = false) {
            const heavenlyStems = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
            const earthlyBranches = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
            
            let html = '';
            
            for (let i = 1; i <= count; i++) {
                const year = currentYear + i;
                const stemIndex = (year - 4) % 10;
                const branchIndex = (year - 4) % 12;
                
                const ganzhiYear = heavenlyStems[stemIndex] + earthlyBranches[branchIndex];
                
                // 获取五行和属相
                const ganWuxing = {
                    '甲': '木', '乙': '木',
                    '丙': '火', '丁': '火',
                    '戊': '土', '己': '土',
                    '庚': '金', '辛': '金',
                    '壬': '水', '癸': '水'
                };
                
                const wuxing = ganWuxing[heavenlyStems[stemIndex]];
                const zodiac = ['鼠', '牛', '虎', '兔', '龙', '蛇', '马', '羊', '猴', '鸡', '狗', '猪'][branchIndex];
                const zodiacEn = ['Rat', 'Ox', 'Tiger', 'Rabbit', 'Dragon', 'Snake', 'Horse', 'Goat', 'Monkey', 'Rooster', 'Dog', 'Pig'][branchIndex];
                const wuxingEn = {'木': 'Wood', '火': 'Fire', '土': 'Earth', '金': 'Metal', '水': 'Water'}[wuxing];
                
                html += `
                    <div class="flow-year-item" onclick="showFlowYearDetail('${ganzhiYear}', ${year})">
                        <div class="flow-year-header">
                            <span data-lang="zh">${year}年</span>
                            <span data-lang="en" style="display:none">${year}</span>
                        </div>
                        <div class="flow-year-ganzhi">${ganzhiYear}</div>
                        <div class="flow-year-details">
                            <span class="${getWuxingColorClass(wuxing)}">
                                <span data-lang="zh">${wuxing}</span>
                                <span data-lang="en" style="display:none">${wuxingEn}</span>
                            </span> | 
                            <span data-lang="zh">${zodiac}年</span>
                            <span data-lang="en" style="display:none">${zodiacEn}</span>
                        </div>
                    </div>
                `;
            }
            
            return html;
        }
        
        // 显示柱子详情 - 确保这个函数是全局的
        window.showPillarDetail = function(pillarType) {
            try {
                // 从localStorage获取分析数据
                const analysisDataStr = localStorage.getItem('baziAnalysisData');
                if (!analysisDataStr) {
                    showError('未找到分析数据');
                    return;
                }
                
                const analysisData = JSON.parse(analysisDataStr);
                if (!analysisData.ganzhi || !analysisData.ganzhi[pillarType]) {
                    showError(`未找到${pillarType}柱数据`);
                    return;
                }
                
                // 获取用户数据以计算出生季节等
                const userDataStr = localStorage.getItem('baziUserData');
                const userData = userDataStr ? JSON.parse(userDataStr) : null;
                let birthSeason = '未知';
                
                // 确定出生季节
                if (analysisData.ganzhi.month) {
                    birthSeason = determineSeason(analysisData.ganzhi.month);
                }
                
                // 获取柱子名称和干支
                const pillarNames = {
                    'year': {zh: '年', en: 'Year'},
                    'month': {zh: '月', en: 'Month'},
                    'day': {zh: '日', en: 'Day'},
                    'hour': {zh: '时', en: 'Hour'}
                };
                
                // 获取当前语言 - 通过检查DOM元素的显示状态来确定当前语言
                // 这样可以确保与toggleLanguage函数中的语言状态保持一致
                const isCurrentlyEnglish = document.querySelector('[data-lang="en"]').style.display !== 'none';
                const currentLang = isCurrentlyEnglish ? 'en' : 'zh';
                const isEnglish = currentLang === 'en';
                
                // 将当前语言保存到localStorage，确保其他函数可以获取到正确的语言设置
                localStorage.setItem('language', currentLang);
                
                const ganzhi = analysisData.ganzhi[pillarType];
                const gan = ganzhi.charAt(0);
                const zhi = ganzhi.charAt(1);
                
                // 获取五行
                const wuxingMap = {
                    '甲': {zh: '木', en: 'Wood'}, '乙': {zh: '木', en: 'Wood'},
                    '丙': {zh: '火', en: 'Fire'}, '丁': {zh: '火', en: 'Fire'},
                    '戊': {zh: '土', en: 'Earth'}, '己': {zh: '土', en: 'Earth'},
                    '庚': {zh: '金', en: 'Metal'}, '辛': {zh: '金', en: 'Metal'},
                    '壬': {zh: '水', en: 'Water'}, '癸': {zh: '水', en: 'Water'},
                    '寅': {zh: '木', en: 'Wood'}, '卯': {zh: '木', en: 'Wood'},
                    '巳': {zh: '火', en: 'Fire'}, '午': {zh: '火', en: 'Fire'},
                    '辰': {zh: '土', en: 'Earth'}, '戌': {zh: '土', en: 'Earth'}, '丑': {zh: '土', en: 'Earth'}, '未': {zh: '土', en: 'Earth'},
                    '申': {zh: '金', en: 'Metal'}, '酉': {zh: '金', en: 'Metal'},
                    '亥': {zh: '水', en: 'Water'}, '子': {zh: '水', en: 'Water'}
                };
                
                // 地支藏干定义
                const cangganMap = {
                    '子': '癸', 
                    '丑': '己癸辛', 
                    '寅': '甲丙戊', 
                    '卯': '乙',
                    '辰': '戊乙癸', 
                    '巳': '丙戊庚', 
                    '午': '丁己', 
                    '未': '己丁乙',
                    '申': '庚壬戊', 
                    '酉': '辛', 
                    '戌': '戊辛丁', 
                    '亥': '壬甲'
                };
                
                // 纳音定义
                const nayinMap = {
                    '甲子':'海中金', '乙丑':'海中金', 
                    '丙寅':'炉中火', '丁卯':'炉中火',
                    '戊辰':'大林木', '己巳':'大林木',
                    '庚午':'路旁土', '辛未':'路旁土',
                    '壬申':'剑锋金', '癸酉':'剑锋金',
                    '甲戌':'山头火', '乙亥':'山头火',
                    '丙子':'涧下水', '丁丑':'涧下水',
                    '戊寅':'城头土', '己卯':'城头土',
                    '庚辰':'白蜡金', '辛巳':'白蜡金',
                    '壬午':'杨柳木', '癸未':'杨柳木',
                    '甲申':'泉中水', '乙酉':'泉中水',
                    '丙戌':'屋上土', '丁亥':'屋上土',
                    '戊子':'霹雳火', '己丑':'霹雳火',
                    '庚寅':'松柏木', '辛卯':'松柏木',
                    '壬辰':'长流水', '癸巳':'长流水',
                    '甲午':'砂石金', '乙未':'砂石金',
                    '丙申':'山下火', '丁酉':'山下火',
                    '戊戌':'平地木', '己亥':'平地木',
                    '庚子':'壁上土', '辛丑':'壁上土',
                    '壬寅':'金薄金', '癸卯':'金薄金',
                    '甲辰':'覆灯火', '乙巳':'覆灯火',
                    '丙午':'天河水', '丁未':'天河水',
                    '戊申':'大驿土', '己酉':'大驿土',
                    '庚戌':'钗环金', '辛亥':'钗环金',
                    '壬子':'桑柘木', '癸丑':'桑柘木',
                    '甲寅':'大溪水', '乙卯':'大溪水',
                    '丙辰':'沙中土', '丁巳':'沙中土',
                    '戊午':'天上火', '己未':'天上火',
                    '庚申':'石榴木', '辛酉':'石榴木',
                    '壬戌':'大海水', '癸亥':'大海水'
                };
                
                // 空亡定义
                const kongwangMap = {
                    '甲子甲午':'戌亥', '乙丑乙未':'申酉', '丙寅丙申':'午未',
                    '丁卯丁酉':'辰巳', '戊辰戊戌':'寅卯', '己巳己亥':'子丑',
                    '庚午':'戌亥', '辛未':'申酉', '壬申':'午未',
                    '癸酉':'辰巳', '甲戌':'寅卯', '乙亥':'子丑'
                };
                
                // 副星定义（替代十神）
                const fuxingMap = {
                    '甲': {'甲':'比肩', '乙':'劫财', '丙':'食神', '丁':'伤官', '戊':'偏财', '己':'正财', '庚':'七杀', '辛':'正官', '壬':'偏印', '癸':'正印'},
                    '乙': {'甲':'劫财', '乙':'比肩', '丙':'伤官', '丁':'食神', '戊':'正财', '己':'偏财', '庚':'正官', '辛':'七杀', '壬':'正印', '癸':'偏印'},
                    '丙': {'甲':'偏印', '乙':'正印', '丙':'比肩', '丁':'劫财', '戊':'食神', '己':'伤官', '庚':'偏财', '辛':'正财', '壬':'七杀', '癸':'正官'},
                    '丁': {'甲':'正印', '乙':'偏印', '丙':'劫财', '丁':'比肩', '戊':'伤官', '己':'食神', '庚':'正财', '辛':'偏财', '壬':'正官', '癸':'七杀'},
                    '戊': {'甲':'七杀', '乙':'正官', '丙':'偏印', '丁':'正印', '戊':'比肩', '己':'劫财', '庚':'食神', '辛':'伤官', '壬':'偏财', '癸':'正财'},
                    '己': {'甲':'正官', '乙':'七杀', '丙':'正印', '丁':'偏印', '戊':'劫财', '己':'比肩', '庚':'伤官', '辛':'食神', '壬':'正财', '癸':'偏财'},
                    '庚': {'甲':'偏财', '乙':'正财', '丙':'七杀', '丁':'正官', '戊':'偏印', '己':'正印', '庚':'比肩', '辛':'劫财', '壬':'食神', '癸':'伤官'},
                    '辛': {'甲':'正财', '乙':'偏财', '丙':'正官', '丁':'七杀', '戊':'正印', '己':'偏印', '庚':'劫财', '辛':'比肩', '壬':'伤官', '癸':'食神'},
                    '壬': {'甲':'食神', '乙':'伤官', '丙':'偏财', '丁':'正财', '戊':'七杀', '己':'正官', '庚':'偏印', '辛':'正印', '壬':'比肩', '癸':'劫财'},
                    '癸': {'甲':'伤官', '乙':'食神', '丙':'正财', '丁':'偏财', '戊':'正官', '己':'七杀', '庚':'正印', '辛':'偏印', '壬':'劫财', '癸':'比肩'}
                };
                
                // 日主天干
                const dayGan = analysisData.ganzhi.day.charAt(0);
                
                // 计算副星关系
                let fuxing = '';
                if (fuxingMap[dayGan] && fuxingMap[dayGan][gan]) {
                    fuxing = fuxingMap[dayGan][gan];
                } else {
                    fuxing = '未知';
                }
                
                // 获取空亡
                let kongwang = '未知';
                if (pillarType === 'day') {
                    // 仅使用简单规则，实际应结合年柱干支计算
                    const index = (dayGan === '甲' || dayGan === '己') ? 0 :
                                  (dayGan === '乙' || dayGan === '庚') ? 1 :
                                  (dayGan === '丙' || dayGan === '辛') ? 2 :
                                  (dayGan === '丁' || dayGan === '壬') ? 3 : 4;
                    kongwang = ['戌亥', '申酉', '午未', '辰巳', '寅卯', '子丑'][index];
                }
                
                // 获取神煞信息，进行吉凶区分
                function formatShensha(shensha) {
                    if (!shensha || shensha.length === 0) return '无';
                    
                    // 吉神列表
                    const goodShensha = [
                        '天乙贵人', '文昌', '文曲', '驿马', '天德', '天德合', 
                        '月德', '金舆', '天喜', '六合', '福星', '福德', '司命',
                        '天贵', '天官', '天福', '国印', '天医', '解神', '青龙',
                        '明堂', '凤阁', '恩光', '天马', '玉堂', '唐符', '天印',
                        '太极贵人', '太极', '红鸾', '天魁', '天财', '博士'
                    ];
                    
                    // 凶煞列表
                    const badShensha = [
                        '白虎', '天罗', '地网', '孤辰', '寡宿', '咸池', '劫煞',
                        '灾煞', '天刑', '天牢', '岁破', '大耗', '华盖', '截路',
                        '地囚', '勾陈', '天空', '地杀', '旬空', '火星', '丧门',
                        '贯索', '铃星', '灾杀', '劫杀', '天厄', '大败', '吊客',
                        '死符', '孤独', '官符', '死神', '黄幡', '绞煞', '风刀',
                        '地狱', '披麻', '亡神', '病符', '破碎', '勾绞'
                    ];
                    
                    return shensha.map(item => {
                        if (goodShensha.includes(item)) {
                            return `<span class="shensha-good">${item}</span>`;
                        } else if (badShensha.includes(item)) {
                            return `<span class="shensha-bad">${item}</span>`;
                        } else {
                            return item;
                        }
                    }).join('、');
                }
                
                // 获取天干强弱
                function getGanStrength(gan, season) {
                    if (!ganWuxingStrength[gan] || !ganWuxingStrength[gan][season]) {
                        return '<span data-lang="zh">未知</span><span data-lang="en" style="display:none">Unknown</span>';
                    }
                    
                    const strength = ganWuxingStrength[gan][season];
                    let color = '';
                    let descriptionZh = '';
                    let descriptionEn = '';
                    
                    switch (strength) {
                        case '旺':
                            color = 'shensha-good';
                            descriptionZh = '，处于最强盛状态';
                            descriptionEn = ', in the strongest state';
                            break;
                        case '相':
                            color = 'shensha-good';
                            descriptionZh = '，处于次强状态';
                            descriptionEn = ', in a prosperous state';
                            break;
                        case '休':
                            color = '';
                            descriptionZh = '，处于较弱状态';
                            descriptionEn = ', in a relatively weak state';
                            break;
                        case '囚':
                            color = 'shensha-bad';
                            descriptionZh = '，处于最弱状态';
                            descriptionEn = ', in the weakest state';
                            break;
                    }
                    
                    return `<span class="${color}">${strength}</span><span data-lang="zh">${descriptionZh}</span><span data-lang="en" style="display:none">${descriptionEn}</span>`;
                }
                
                // 获取与日主的关系
                function getDayMasterRelation(dayGan, currentGan) {
                    if (!dayGanFate[dayGan]) {
                        return '<span data-lang="zh">未知</span><span data-lang="en" style="display:none">Unknown</span>';
                    }
                    
                    if (dayGan === currentGan) {
                        return `<span class="shensha-good">比肩</span><span data-lang="zh">，与日主同气相求</span><span data-lang="en" style="display:none">, sharing the same energy with Day Master</span>`;
                    }
                    
                    if (dayGanFate[dayGan].吉.includes(currentGan)) {
                        return `<span class="shensha-good">吉</span><span data-lang="zh">，对日主有利</span><span data-lang="en" style="display:none">, beneficial to Day Master</span>`;
                    } else if (dayGanFate[dayGan].凶.includes(currentGan)) {
                        return `<span class="shensha-bad">凶</span><span data-lang="zh">，对日主不利</span><span data-lang="en" style="display:none">, unfavorable to Day Master</span>`;
                    } else if (dayGanFate[dayGan].中.includes(currentGan)) {
                        return `<span>中性</span><span data-lang="zh">，对日主既有利也有弊</span><span data-lang="en" style="display:none">, both beneficial and unfavorable to Day Master</span>`;
                    }
                    
                    return '<span data-lang="zh">未知</span><span data-lang="en" style="display:none">Unknown</span>';
                }
                
                // 构建详情内容
                const details = `
                    <div style="margin-bottom: 20px;">
                        <h3>
                            <span data-lang="zh">${pillarNames[pillarType].zh}柱: ${ganzhi}</span>
                            <span data-lang="en" style="display:none">${pillarType.charAt(0).toUpperCase() + pillarType.slice(1)} Pillar: ${ganzhi}</span>
                        </h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>
                                    <span data-lang="zh">天干：</span>
                                    <span data-lang="en" style="display:none">Heavenly Stem: </span>
                                </label>
                                <span><span data-lang="zh">${gan}（${wuxingMap[gan] ? (typeof wuxingMap[gan] === 'object' ? wuxingMap[gan].zh : String(wuxingMap[gan])) : '未知'}）</span><span data-lang="en" style="display:none">${gan} (${wuxingMap[gan] ? (typeof wuxingMap[gan] === 'object' ? wuxingMap[gan].en : (translations[wuxingMap[gan]] ? translations[wuxingMap[gan]].en : wuxingMap[gan])) : 'Unknown'})</span></span>
                            </div>
                            <div class="detail-item">
                                <label>
                                    <span data-lang="zh">地支：</span>
                                    <span data-lang="en" style="display:none">Earthly Branch: </span>
                                </label>
                                <span><span data-lang="zh">${zhi}（${wuxingMap[zhi] ? (typeof wuxingMap[zhi] === 'object' ? wuxingMap[zhi].zh : String(wuxingMap[zhi])) : '未知'}）</span><span data-lang="en" style="display:none">${zhi} (${wuxingMap[zhi] ? (typeof wuxingMap[zhi] === 'object' ? wuxingMap[zhi].en : (translations[wuxingMap[zhi]] ? translations[wuxingMap[zhi]].en : wuxingMap[zhi])) : 'Unknown'})</span></span>
                            </div>
                            <div class="detail-item">
                                <label>
                                    <span data-lang="zh">藏干：</span>
                                    <span data-lang="en" style="display:none">Hidden Stem: </span>
                                </label>
                                <span><span data-lang="zh">${cangganMap[zhi] || '未知'}</span><span data-lang="en" style="display:none">${cangganMap[zhi] || 'Unknown'}</span> <a href="javascript:void(0)" onclick="showExplanation('canggan')" style="font-size:0.8em;color:var(--secondary);"><i class="fas fa-info-circle"></i></a></span>
                            </div>
                            <div class="detail-item">
                                <label>
                                    <span data-lang="zh">副星：</span>
                                    <span data-lang="en" style="display:none">Secondary Star: </span>
                                </label>
                                <span><span data-lang="zh">${fuxing}</span><span data-lang="en" style="display:none">${translations[fuxing] && typeof translations[fuxing] === 'object' ? translations[fuxing].en : fuxing}</span> <a href="javascript:void(0)" onclick="showExplanation('fuxing')" style="font-size:0.8em;color:var(--secondary);"><i class="fas fa-info-circle"></i></a></span>
                            </div>
                            <div class="detail-item">
                                <label>
                                    <span data-lang="zh">纳音：</span>
                                    <span data-lang="en" style="display:none">Hidden Sound: </span>
                                </label>
                                <span><span data-lang="zh">${nayinMap[ganzhi] || '未知'}</span><span data-lang="en" style="display:none">${nayinMap[ganzhi] || 'Unknown'}</span> <a href="javascript:void(0)" onclick="showExplanation('nayin')" style="font-size:0.8em;color:var(--secondary);"><i class="fas fa-info-circle"></i></a></span>
                            </div>
                            <div class="detail-item">
                                <label>
                                    <span data-lang="zh">空亡：</span>
                                    <span data-lang="en" style="display:none">Empty Space: </span>
                                </label>
                                <span><span data-lang="zh">${kongwang}</span><span data-lang="en" style="display:none">${kongwang}</span> <a href="javascript:void(0)" onclick="showExplanation('kongwang')" style="font-size:0.8em;color:var(--secondary);"><i class="fas fa-info-circle"></i></a></span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3>
                            <span data-lang="zh">神煞信息</span>
                            <span data-lang="en" style="display:none">Gods and Spirits</span>
                            <a href="javascript:void(0)" onclick="showExplanation('shensha')" style="font-size:0.8em;color:var(--secondary);"><i class="fas fa-info-circle"></i></a>
                        </h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>
                                    <span data-lang="zh">天干神煞：</span>
                                    <span data-lang="en" style="display:none">Heavenly Stem Spirits: </span>
                                </label>
                                <span><span data-lang="zh">${formatShensha(shenshaMap[gan])}</span><span data-lang="en" style="display:none">${formatShenshaEn(shenshaMap[gan])}</span></span>
                            </div>
                            <div class="detail-item">
                                <label>
                                    <span data-lang="zh">地支神煞：</span>
                                    <span data-lang="en" style="display:none">Earthly Branch Spirits: </span>
                                </label>
                                <span><span data-lang="zh">${formatShensha(zhiShenshaMap[zhi])}</span><span data-lang="en" style="display:none">${formatShenshaEn(zhiShenshaMap[zhi])}</span></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-divider"></div>
                    
                    <div>
                        <h3>
                            <span data-lang="zh">五行强弱</span>
                            <span data-lang="en" style="display:none">Five Elements Strength</span>
                        </h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>
                                    <span data-lang="zh">天干强弱：</span>
                                    <span data-lang="en" style="display:none">Heavenly Stem Strength: </span>
                                </label>
                                <span>${getGanStrength(gan, birthSeason)}</span>
                            </div>
                            <div class="detail-item">
                                <label>
                                    <span data-lang="zh">与日主关系：</span>
                                    <span data-lang="en" style="display:none">Relationship with Day Master: </span>
                                </label>
                                <span>${getDayMasterRelation(dayGan, gan)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pillar-analysis">
                        <h3>
                            <span data-lang="zh">详细解析</span>
                            <span data-lang="en" style="display:none">Detailed Analysis</span>
                        </h3>
                        <p>
                            <span data-lang="zh">天干${gan}属${typeof wuxingMap[gan] === 'object' ? wuxingMap[gan].zh : '未知'}，地支${zhi}属${typeof wuxingMap[zhi] === 'object' ? wuxingMap[zhi].zh : '未知'}。${getGanZhiRelationship(gan, zhi)}</span>
                            <span data-lang="en" style="display:none">Heavenly Stem ${gan} belongs to ${typeof wuxingMap[gan] === 'object' ? wuxingMap[gan].en : 'Unknown'}, Earthly Branch ${zhi} belongs to ${typeof wuxingMap[zhi] === 'object' ? wuxingMap[zhi].en : 'Unknown'}. ${getGanZhiRelationshipEn(gan, zhi)}</span>
                        </p>
                        <p>
                            <span data-lang="zh">您的日主为${dayGan}，本柱天干${gan}在日主天干中为${fuxing}，显示了${getShishenMeaning(fuxing)}的特质。</span>
                            <span data-lang="en" style="display:none">Your Day Master is ${dayGan}, the Heavenly Stem ${gan} in this pillar represents ${translations[fuxing] && typeof translations[fuxing] === 'object' ? translations[fuxing].en : fuxing}, showing the characteristics of ${getShishenMeaningEn(fuxing)}.</span>
                        </p>
                        <p>
                            <span data-lang="zh">本柱纳音为${nayinMap[ganzhi] || '未知'}，代表${getNayinMeaning(nayinMap[ganzhi] || '未知')}。</span>
                            <span data-lang="en" style="display:none">The Hidden Sound of this pillar is ${nayinMap[ganzhi] || 'Unknown'}, representing ${getNayinMeaningEn(nayinMap[ganzhi] || 'Unknown')}.</span>
                        </p>
                        ${getPillarSpecificAnalysisWithLang(pillarType, gan, zhi)}
                    </div>
                `;
                
                // 显示详情并应用当前语言
                document.getElementById('pillar-details').innerHTML = details;
                document.getElementById('pillar-modal').style.display = 'flex';
                
                // 强制应用当前语言
                document.querySelectorAll('[data-lang="zh"], [data-lang="en"]').forEach(el => {
                    if (el.getAttribute('data-lang') === currentLang) {
                        el.style.display = '';
                    } else {
                        el.style.display = 'none';
                    }
                });
                
            } catch (error) {
                console.error('显示柱子详情出错:', error);
                showError('无法显示详情: ' + error.message);
            }
        };
        
        // 关闭柱子详情模态框
        window.closePillarModal = function() {
            document.getElementById('pillar-modal').style.display = 'none';
        };
        
        // 关闭解释模态框
        function closeExplanationModal() {
            document.getElementById('explanation-modal').style.display = 'none';
        }
        
        // 中英文翻译映射
        const translations = {
            '木': { zh: '木', en: 'Wood' },
            '火': { zh: '火', en: 'Fire' },
            '土': { zh: '土', en: 'Earth' },
            '金': { zh: '金', en: 'Metal' },
            '水': { zh: '水', en: 'Water' },
            '比肩': { zh: '比肩', en: 'Peer' },
            '劫财': { zh: '劫财', en: 'Rob Wealth' },
            '食神': { zh: '食神', en: 'Food God' },
            '伤官': { zh: '伤官', en: 'Hurting Officer' },
            '偏财': { zh: '偏财', en: 'Partial Wealth' },
            '正财': { zh: '正财', en: 'Proper Wealth' },
            '七杀': { zh: '七杀', en: 'Seven Killings' },
            '正官': { zh: '正官', en: 'Proper Officer' },
            '偏印': { zh: '偏印', en: 'Partial Seal' },
            '正印': { zh: '正印', en: 'Proper Seal' },
            '旺': { zh: '旺', en: 'Strong' },
            '相': { zh: '相', en: 'Prosperous' },
            '休': { zh: '休', en: 'Rest' },
            '囚': { zh: '囚', en: 'Imprisoned' },
            // 神煞翻译
            '天乙贵人': { zh: '天乙贵人', en: 'Heavenly Noble' },
            '文昌': { zh: '文昌', en: 'Literary Star' },
            '文曲': { zh: '文曲', en: 'Academic Star' },
            '驿马': { zh: '驿马', en: 'Travel Horse' },
            '桃花': { zh: '桃花', en: 'Romance Star' },
            '华盖': { zh: '华盖', en: 'Solitude Star' },
            '天德': { zh: '天德', en: 'Heavenly Virtue' },
            '月德': { zh: '月德', en: 'Monthly Virtue' },
            '金舆': { zh: '金舆', en: 'Golden Carriage' },
            '天喜': { zh: '天喜', en: 'Heavenly Joy' },
            '六合': { zh: '六合', en: 'Six Harmony' },
            '白虎': { zh: '白虎', en: 'White Tiger' },
            '天罗': { zh: '天罗', en: 'Sky Net' },
            '地网': { zh: '地网', en: 'Earth Web' },
            '孤辰': { zh: '孤辰', en: 'Lonely Star' },
            '寡宿': { zh: '寡宿', en: 'Widow Star' },
            '咸池': { zh: '咸池', en: 'Salty Pool' }
        };

        // 格式化神煞信息的英文显示
        function formatShenshaEn(shensha) {
            if (!shensha || shensha.length === 0) return 'None';
            return shensha.map(item => translations[item] ? translations[item].en : item).join(', ');
        }


        // 获取干支关系英文描述
        function getGanZhiRelationshipEn(gan, zhi) {
            const ganWuxing = {
                '甲': '木', '乙': '木',
                '丙': '火', '丁': '火',
                '戊': '土', '己': '土',
                '庚': '金', '辛': '金',
                '壬': '水', '癸': '水'
            };
            
            const zhiWuxing = {
                '寅': '木', '卯': '木',
                '巳': '火', '午': '火',
                '辰': '土', '戌': '土', '丑': '土', '未': '土',
                '申': '金', '酉': '金',
                '亥': '水', '子': '水'
            };
            
            if (ganWuxing[gan] === zhiWuxing[zhi]) {
                return `The Heavenly Stem and Earthly Branch both belong to ${translations[ganWuxing[gan]].en}, showing stable ${translations[ganWuxing[gan]].en} characteristics.`;
            } else if (
                (ganWuxing[gan] === '木' && zhiWuxing[zhi] === '火') ||
                (ganWuxing[gan] === '火' && zhiWuxing[zhi] === '土') ||
                (ganWuxing[gan] === '土' && zhiWuxing[zhi] === '金') ||
                (ganWuxing[gan] === '金' && zhiWuxing[zhi] === '水') ||
                (ganWuxing[gan] === '水' && zhiWuxing[zhi] === '木')
            ) {
                return `The Heavenly Stem ${gan} (${translations[ganWuxing[gan]].en}) generates the Earthly Branch ${zhi} (${translations[zhiWuxing[zhi]].en}), showing a harmonious flow of energy.`;
            } else {
                return `There is a conflicting relationship between Heavenly Stem ${gan} (${translations[ganWuxing[gan]].en}) and Earthly Branch ${zhi} (${translations[zhiWuxing[zhi]].en}).`;
            }
        }

        // 获取十神含义英文描述
        function getShishenMeaningEn(shishen) {
            const meanings = {
                '比肩': 'peer support and competition',
                '劫财': 'wealth competition and resource sharing',
                '食神': 'intelligence and creativity',
                '伤官': 'innovation and rebellion',
                '偏财': 'unexpected wealth and opportunities',
                '正财': 'steady wealth and material gains',
                '七杀': 'power and authority',
                '正官': 'leadership and responsibility',
                '偏印': 'knowledge and wisdom',
                '正印': 'education and inheritance'
            };
            return meanings[shishen] || 'unknown characteristics';
        }

        // 获取纳音含义英文描述
        function getNayinMeaningEn(nayin) {
            const meanings = {
                '海中金': 'Gold in the sea - hidden wealth and potential',
                '炉中火': 'Fire in the furnace - contained power and transformation',
                '大林木': 'Big forest wood - growth and abundance',
                '路旁土': 'Roadside earth - practical and grounded',
                '剑锋金': 'Sword edge gold - sharp and decisive',
                '山头火': 'Mountain top fire - visible influence and leadership',
                '涧下水': 'Stream water - adaptable and flowing',
                '城头土': 'City wall earth - protection and defense',
                '白蜡金': 'White wax gold - refined and pure',
                '杨柳木': 'Willow wood - flexible and resilient',
                '泉中水': 'Spring water - source of life and renewal',
                '屋上土': 'Roof earth - shelter and support',
                '霹雳火': 'Lightning fire - sudden change and inspiration',
                '松柏木': 'Pine wood - endurance and longevity',
                '长流水': 'Long river water - continuous and persistent',
                '砂中金': 'Sand gold - scattered wealth and opportunities',
                '山下火': 'Mountain fire - hidden influence and potential',
                '平地木': 'Plain wood - steady growth and development',
                '壁上土': 'Wall earth - boundaries and protection',
                '金薄金': 'Gold foil - delicate and precious',
                '覆灯火': 'Covered lamp fire - hidden wisdom and guidance',
                '天河水': 'Celestial river water - grand aspirations and flow',
                '大驿土': 'Station earth - connection and communication',
                '钗环金': 'Hairpin gold - ornamental and decorative',
                '桑柘木': 'Mulberry wood - nurturing and productive',
                '大溪水': 'Big stream water - powerful and influential',
                '沙中土': 'Sand earth - adaptable and widespread',
                '天上火': 'Heavenly fire - divine inspiration and leadership',
                '石榴木': 'Pomegranate wood - fertility and abundance',
                '大海水': 'Ocean water - depth and mystery'
            };
            return meanings[nayin] || 'unknown characteristics';
        }
        
        // 填充八字表格
        function fillBaziTable(analysisData) {
            try {
                if (!analysisData.ganzhi) return;
                
                const cangganMap = {
                    '子': '癸', 
                    '丑': '己癸辛', 
                    '寅': '甲丙戊', 
                    '卯': '乙',
                    '辰': '戊乙癸', 
                    '巳': '丙戊庚', 
                    '午': '丁己', 
                    '未': '己丁乙',
                    '申': '庚壬戊', 
                    '酉': '辛', 
                    '戌': '戊辛丁', 
                    '亥': '壬甲'
                };
                
                const nayinMap = {
                    '甲子':'海中金', '乙丑':'海中金', 
                    '丙寅':'炉中火', '丁卯':'炉中火',
                    '戊辰':'大林木', '己巳':'大林木',
                    '庚午':'路旁土', '辛未':'路旁土',
                    '壬申':'剑锋金', '癸酉':'剑锋金',
                    '甲戌':'山头火', '乙亥':'山头火',
                    '丙子':'涧下水', '丁丑':'涧下水',
                    '戊寅':'城头土', '己卯':'城头土',
                    '庚辰':'白蜡金', '辛巳':'白蜡金',
                    '壬午':'杨柳木', '癸未':'杨柳木',
                    '甲申':'泉中水', '乙酉':'泉中水',
                    '丙戌':'屋上土', '丁亥':'屋上土',
                    '戊子':'霹雳火', '己丑':'霹雳火',
                    '庚寅':'松柏木', '辛卯':'松柏木',
                    '壬辰':'长流水', '癸巳':'长流水',
                    '甲午':'砂石金', '乙未':'砂石金',
                    '丙申':'山下火', '丁酉':'山下火',
                    '戊戌':'平地木', '己亥':'平地木',
                    '庚子':'壁上土', '辛丑':'壁上土',
                    '壬寅':'金薄金', '癸卯':'金薄金',
                    '甲辰':'覆灯火', '乙巳':'覆灯火',
                    '丙午':'天河水', '丁未':'天河水',
                    '戊申':'大驿土', '己酉':'大驿土',
                    '庚戌':'钗环金', '辛亥':'钗环金',
                    '壬子':'桑柘木', '癸丑':'桑柘木',
                    '甲寅':'大溪水', '乙卯':'大溪水',
                    '丙辰':'沙中土', '丁巳':'沙中土',
                    '戊午':'天上火', '己未':'天上火',
                    '庚申':'石榴木', '辛酉':'石榴木',
                    '壬戌':'大海水', '癸亥':'大海水'
                };
                
                // 判断五行颜色类
                function getWuxingClass(char) {
                    const wuxingMap = {
                        '甲': 'gan-wood', '乙': 'gan-wood',
                        '丙': 'gan-fire', '丁': 'gan-fire',
                        '戊': 'gan-earth', '己': 'gan-earth',
                        '庚': 'gan-metal', '辛': 'gan-metal',
                        '壬': 'gan-water', '癸': 'gan-water'
                    };
                    return wuxingMap[char] || '';
                }
                
                // 计算十神关系
                function getShishen(dayGan, targetGan) {
                    const shishenMap = {
                        '甲': {'甲':'比肩', '乙':'劫财', '丙':'食神', '丁':'伤官', '戊':'偏财', '己':'正财', '庚':'七杀', '辛':'正官', '壬':'偏印', '癸':'正印'},
                        '乙': {'甲':'劫财', '乙':'比肩', '丙':'伤官', '丁':'食神', '戊':'正财', '己':'偏财', '庚':'正官', '辛':'七杀', '壬':'正印', '癸':'偏印'},
                        '丙': {'甲':'偏印', '乙':'正印', '丙':'比肩', '丁':'劫财', '戊':'食神', '己':'伤官', '庚':'偏财', '辛':'正财', '壬':'七杀', '癸':'正官'},
                        '丁': {'甲':'正印', '乙':'偏印', '丙':'劫财', '丁':'比肩', '戊':'伤官', '己':'食神', '庚':'正财', '辛':'偏财', '壬':'正官', '癸':'七杀'},
                        '戊': {'甲':'七杀', '乙':'正官', '丙':'偏印', '丁':'正印', '戊':'比肩', '己':'劫财', '庚':'食神', '辛':'伤官', '壬':'偏财', '癸':'正财'},
                        '己': {'甲':'正官', '乙':'七杀', '丙':'正印', '丁':'偏印', '戊':'劫财', '己':'比肩', '庚':'伤官', '辛':'食神', '壬':'正财', '癸':'偏财'},
                        '庚': {'甲':'偏财', '乙':'正财', '丙':'七杀', '丁':'正官', '戊':'偏印', '己':'正印', '庚':'比肩', '辛':'劫财', '壬':'食神', '癸':'伤官'},
                        '辛': {'甲':'正财', '乙':'偏财', '丙':'正官', '丁':'七杀', '戊':'正印', '己':'偏印', '庚':'劫财', '辛':'比肩', '壬':'伤官', '癸':'食神'},
                        '壬': {'甲':'食神', '乙':'伤官', '丙':'偏财', '丁':'正财', '戊':'七杀', '己':'正官', '庚':'偏印', '辛':'正印', '壬':'比肩', '癸':'劫财'},
                        '癸': {'甲':'伤官', '乙':'食神', '丙':'正财', '丁':'偏财', '戊':'正官', '己':'七杀', '庚':'正印', '辛':'偏印', '壬':'劫财', '癸':'比肩'}
                    };
                    
                    if (shishenMap[dayGan] && shishenMap[dayGan][targetGan]) {
                        return shishenMap[dayGan][targetGan];
                    }
                    return '未知';
                }
                
                // 填充表格数据
                const pillars = ['year', 'month', 'day', 'hour'];
                const dayGan = analysisData.ganzhi.day.charAt(0);
                
                pillars.forEach(pillar => {
                    const ganzhi = analysisData.ganzhi[pillar] || '--';
                    if (ganzhi === '--') return;
                    
                    const gan = ganzhi.charAt(0);
                    const zhi = ganzhi.charAt(1);
                    
                    // 天干
                    const ganElement = document.getElementById(`table-${pillar}-gan`);
                    ganElement.innerHTML = `<span class="${getWuxingClass(gan)}">${gan}</span>`;
                    if (pillar === 'day') ganElement.classList.add('highlight');
                    
                    // 地支
                    document.getElementById(`table-${pillar}-zhi`).textContent = zhi;
                    
                    // 藏干
                    document.getElementById(`table-${pillar}-canggan`).textContent = cangganMap[zhi] || '-';
                    
                    // 十神
                    document.getElementById(`table-${pillar}-shishen`).textContent = getShishen(dayGan, gan);
                    
                    // 纳音
                    document.getElementById(`table-${pillar}-nayin`).textContent = nayinMap[ganzhi] || '-';
                });
                
                console.log('八字表格填充完成');
                
            } catch (error) {
                console.error('填充八字表格出错:', error);
                showError('八字表格数据错误: ' + error.message);
            }
        }
        
        // 获取干支关系描述
        function getGanZhiRelationship(gan, zhi) {
            const ganWuxing = {
                '甲': '木', '乙': '木',
                '丙': '火', '丁': '火',
                '戊': '土', '己': '土',
                '庚': '金', '辛': '金',
                '壬': '水', '癸': '水'
            };
            
            const zhiWuxing = {
                '寅': '木', '卯': '木',
                '巳': '火', '午': '火',
                '辰': '土', '戌': '土', '丑': '土', '未': '土',
                '申': '金', '酉': '金',
                '亥': '水', '子': '水'
            };
            
            if (ganWuxing[gan] === zhiWuxing[zhi]) {
                return `天干地支五行相同，均为${ganWuxing[gan]}，显示较为稳定的${ganWuxing[gan]}性特质。`;
            } else if (
                (ganWuxing[gan] === '木' && zhiWuxing[zhi] === '火') ||
                (ganWuxing[gan] === '火' && zhiWuxing[zhi] === '土') ||
                (ganWuxing[gan] === '土' && zhiWuxing[zhi] === '金') ||
                (ganWuxing[gan] === '金' && zhiWuxing[zhi] === '水') ||
                (ganWuxing[gan] === '水' && zhiWuxing[zhi] === '木')
            ) {
                return `天干${gan}(${ganWuxing[gan]})生地支${zhi}(${zhiWuxing[zhi]})，五行关系为相生，能量流动顺畅。`;
            } else {
                return `天干${gan}(${ganWuxing[gan]})与地支${zhi}(${zhiWuxing[zhi]})之间为相克关系，存在一定的能量冲突。`;
            }
        }
        
        // 获取十神含义
        function getShishenMeaning(shishen) {
            const meanings = {
                '比肩': '自我、独立、竞争',
                '劫财': '进取、果断、争执',
                '食神': '创造、乐观、享受',
                '伤官': '灵活、变通、叛逆',
                '偏财': '外交、活跃、意外之财',
                '正财': '稳定之财、储蓄、节俭',
                '七杀': '权威、决断、变革',
                '正官': '规矩、守序、执行力',
                '偏印': '学习、聪明、独特见解',
                '正印': '学术、智慧、传统知识'
            };
            
            return meanings[shishen] || '未知特质';
        }
        
        // 获取纳音含义
        function getNayinMeaning(nayin) {
            if (!nayin) return '未知意义';
            
            const base = nayin.substring(0, nayin.length - 1);
            const wuxing = nayin.substring(nayin.length - 1);
            
            let meaning = '';
            switch (base) {
                case '海中':
                    meaning = '深沉内敛、蕴藏丰富';
                    break;
                case '炉中':
                    meaning = '热情活跃、光明正大';
                    break;
                case '大林':
                    meaning = '高大挺拔、生机勃勃';
                    break;
                case '路旁':
                    meaning = '稳重踏实、宽容包容';
                    break;
                case '剑锋':
                    meaning = '锐利果断、刚毅坚定';
                    break;
                // 可添加更多纳音基础描述
                default:
                    meaning = '特殊组合';
            }
            
            return meaning + `，具有${wuxing}的特性`;
        }
        
        // 获取柱位特定分析
        function getPillarSpecificAnalysis(pillarType, gan, zhi) {
            switch (pillarType) {
                case 'year':
                    return `<span data-lang="zh"><p>年柱代表您的早年运势和祖上关系，天干${gan}显示了您的祖上根基，地支${zhi}则体现了您的成长环境。</p></span>
                           <span data-lang="en" style="display:none"><p>The year pillar represents your early life fortune and ancestral relationships. The Heavenly Stem ${gan} shows your ancestral foundation, while the Earthly Branch ${zhi} reflects your growth environment.</p></span>`;
                case 'month':
                    return `<span data-lang="zh"><p>月柱代表您的中年运势和父母关系，天干${gan}显示了您的事业方向，地支${zhi}则体现了您的工作环境。</p></span>
                           <span data-lang="en" style="display:none"><p>The month pillar represents your middle-age fortune and parental relationships. The Heavenly Stem ${gan} shows your career direction, while the Earthly Branch ${zhi} reflects your work environment.</p></span>`;
                case 'day':
                    return `<span data-lang="zh"><p>日柱代表您的核心性格与婚姻，天干${gan}是您的日主，显示了您的主要性格特质，地支${zhi}则体现了您的社交关系与婚姻特点。</p></span>
                           <span data-lang="en" style="display:none"><p>The day pillar represents your core personality and marriage. The Heavenly Stem ${gan} is your Day Master, showing your main personality traits, while the Earthly Branch ${zhi} reflects your social relationships and marriage characteristics.</p></span>`;
                case 'hour':
                    return `<span data-lang="zh"><p>时柱代表人生晚年与子女关系，天干${gan}显示了您的未来发展走向，地支${zhi}则体现了您的归宿与子嗣特点。</p></span>
                           <span data-lang="en" style="display:none"><p>The hour pillar represents your late life and relationships with children. The Heavenly Stem ${gan} shows your future development direction, while the Earthly Branch ${zhi} reflects your final destiny and offspring characteristics.</p></span>`;
                default:
                    return '';
            }
        }

        // 获取柱位特定分析（多语言支持）
        function getPillarSpecificAnalysisWithLang(pillarType, gan, zhi) {
            // 获取天干地支的五行属性
            const ganWuxingObj = wuxingMap[gan] || {zh: '未知', en: 'Unknown'};
            const zhiWuxingObj = wuxingMap[zhi] || {zh: '未知', en: 'Unknown'};
            return `
                <span data-lang="zh">${getPillarSpecificAnalysis(pillarType, gan, zhi)}</span>
                <span data-lang="en" style="display:none">
                    ${(() => {
                        switch (pillarType) {
                            case 'year':
                                return `<p>The year pillar represents early life and ancestral relationships. The Heavenly Stem ${gan} (${ganWuxingObj.en}) shows your ancestral foundation, while the Earthly Branch ${zhi} (${zhiWuxingObj.en}) reflects the environmental influences during your growth.</p>`;
                            case 'month':
                                return `<p>The month pillar represents middle age and parental relationships. The Heavenly Stem ${gan} (${ganWuxingObj.en}) influences your career direction, while the Earthly Branch ${zhi} (${zhiWuxingObj.en}) reflects your work environment.</p>`;
                            case 'day':
                                return `<p>The day pillar represents your core personality and marriage. The Heavenly Stem ${gan} (${ganWuxingObj.en}) is your Day Master, showing your main personality traits, while the Earthly Branch ${zhi} (${zhiWuxingObj.en}) reflects your social relationships and marriage characteristics.</p>`;
                            case 'hour':
                                return `<p>The hour pillar represents late life and relationships with children. The Heavenly Stem ${gan} (${ganWuxingObj.en}) shows your future development direction, while the Earthly Branch ${zhi} (${zhiWuxingObj.en}) reflects your final destiny and characteristics of offspring.</p>`;
                            default:
                                return '';
                        }
                    })()} 
                </span>
            `;
        }
        
        // 关闭解释模态框
        window.closeExplanationModal = function() {
            document.getElementById('explanation-modal').style.display = 'none';
        };
        
        // 显示解释信息 - 设为全局函数
        window.showExplanation = function(type) {
            try {
                const explanationDB = {
                    'nayin': {
                        title: '纳音五行',
                        titleEn: 'Earthly Branches Hidden Stem',
                        content: `<div data-lang="zh">
                            <p>纳音五行是干支纳入五行体系的一种方法，每个干支组合都有对应的纳音五行。</p>
                            <p>纳音五行表示一种更为内在、潜藏的能量，它展现了人物内在气质的特点。</p>
                            <p>纳音五行共有30种不同的表达方式，如海中金、炉中火、大林木等，每一种都有其特殊的性质和含义。</p>
                            <p>纳音比单纯的五行更精准地描述了事物的特性，提供了更详细的命理分析基础。</p>
                            <div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee;">
                                <h4>纳音五行对应表（部分）:</h4>
                                <ul style="columns: 2;">
                                    <li>甲子、乙丑：海中金</li>
                                    <li>丙寅、丁卯：炉中火</li>
                                    <li>戊辰、己巳：大林木</li>
                                    <li>庚午、辛未：路旁土</li>
                                    <li>壬申、癸酉：剑锋金</li>
                                    <li>甲戌、乙亥：山头火</li>
                                </ul>
                            </div>
                        </div>
                        <div data-lang="en" style="display:none">
                            <p>Nayin Five Elements is a method of integrating Heavenly Stems and Earthly Branches into the Five Elements system, with each stem-branch combination corresponding to a specific Nayin Five Element.</p>
                            <p>Nayin Five Elements represent a more internal, latent energy that reveals the characteristics of one's inner temperament.</p>
                            <p>There are 30 different expressions of Nayin Five Elements, such as Ocean Metal, Furnace Fire, Great Forest Wood, etc., each with its special nature and meaning.</p>
                            <p>Nayin provides a more precise description of the characteristics of things than the simple Five Elements, providing a more detailed basis for destiny analysis.</p>
                            <div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee;">
                                <h4>Nayin Five Elements Correspondence Table (Partial):</h4>
                                <ul style="columns: 2;">
                                    <li>Jia-Zi, Yi-Chou: Ocean Metal</li>
                                    <li>Bing-Yin, Ding-Mao: Furnace Fire</li>
                                    <li>Wu-Chen, Ji-Si: Great Forest Wood</li>
                                    <li>Geng-Wu, Xin-Wei: Roadside Earth</li>
                                    <li>Ren-Shen, Gui-You: Sword Metal</li>
                                    <li>Jia-Xu, Yi-Hai: Hilltop Fire</li>
                                </ul>
                            </div>
                            </div>`
                    },
                    'canggan': {
                        title: '藏干',
                        titleEn: 'Hidden Stems',
                        content: `<div data-lang="zh">
                            <p>藏干是指地支中所藏的天干，每个地支都蕴含着一至三个天干的能量。</p>
                            <p>藏干反映了地支中潜藏的能量特质，理解藏干对解读命盘有重要作用。</p>
                            <div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee;">
                                <h4>地支藏干对应表:</h4>
                                <ul style="columns: 2;">
                                    <li>子：癸水</li>
                                    <li>丑：己土、癸水、辛金</li>
                                    <li>寅：甲木、丙火、戊土</li>
                                    <li>卯：乙木</li>
                                    <li>辰：戊土、乙木、癸水</li>
                                    <li>巳：丙火、戊土、庚金</li>
                                    <li>午：丁火、己土</li>
                                    <li>未：己土、丁火、乙木</li>
                                    <li>申：庚金、壬水、戊土</li>
                                    <li>酉：辛金</li>
                                    <li>戌：戊土、辛金、丁火</li>
                                    <li>亥：壬水、甲木</li>
                                </ul>
                            </div>
                        </div>
                        <div data-lang="en" style="display:none">
                            <p>Hidden Stems refer to the Heavenly Stems concealed within Earthly Branches, with each Earthly Branch containing the energy of one to three Heavenly Stems.</p>
                            <p>Hidden Stems reflect the latent energy characteristics within Earthly Branches, and understanding them is crucial for interpreting the destiny chart.</p>
                            <div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee;">
                                <h4>Earthly Branch Hidden Stem Correspondence Table:</h4>
                                <ul style="columns: 2;">
                                    <li>Zi: Gui Water</li>
                                    <li>Chou: Ji Earth, Gui Water, Xin Metal</li>
                                    <li>Yin: Jia Wood, Bing Fire, Wu Earth</li>
                                    <li>Mao: Yi Wood</li>
                                    <li>Chen: Wu Earth, Yi Wood, Gui Water</li>
                                    <li>Si: Bing Fire, Wu Earth, Geng Metal</li>
                                    <li>Wu: Ding Fire, Ji Earth</li>
                                    <li>Wei: Ji Earth, Ding Fire, Yi Wood</li>
                                    <li>Shen: Geng Metal, Ren Water, Wu Earth</li>
                                    <li>You: Xin Metal</li>
                                    <li>Xu: Wu Earth, Xin Metal, Ding Fire</li>
                                    <li>Hai: Ren Water, Jia Wood</li>
                                </ul>
                            </div>
                            </div>`
                    },
                    'fuxing': {
                        title: '副星',
                        titleEn: 'Ten Gods',
                        content: `<div data-lang="zh">
                            <p>副星是命理学中用来描述日主与其他天干关系的术语，由日主天干推导而来。</p>
                            <p>副星包括：比肩、劫财、食神、伤官、偏财、正财、七杀、正官、偏印、正印。</p>
                            <p>每个副星都代表特定的人物关系和性格特质，是分析八字人际关系和性格的重要工具。</p>
                            <div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee;">
                                <h4>副星基本含义:</h4>
                                <ul>
                                    <li><strong>比肩:</strong> 象征自我认同、兄弟姐妹、竞争</li>
                                    <li><strong>劫财:</strong> 象征争斗、争夺、助力</li>
                                    <li><strong>食神:</strong> 象征才艺、享受、子女</li>
                                    <li><strong>伤官:</strong> 象征变革、突破、叛逆</li>
                                    <li><strong>偏财:</strong> 象征意外之财、灵活、异性缘</li>
                                    <li><strong>正财:</strong> 象征稳定收入、勤俭节约</li>
                                    <li><strong>七杀:</strong> 象征权威、决断、挑战</li>
                                    <li><strong>正官:</strong> 象征规则、制度、权威</li>
                                    <li><strong>偏印:</strong> 象征学习、智慧、直觉</li>
                                    <li><strong>正印:</strong> 象征学问、读书、母亲</li>
                                </ul>
                            </div>
                        </div>
                        <div data-lang="en" style="display:none">
                            <p>Ten Gods are terms used in destiny studies to describe the relationship between the Day Master and other Heavenly Stems, derived from the Day Master's Heavenly Stem.</p>
                            <p>Ten Gods include: Peer, Rob Wealth, Resource, Hurting Officer, Indirect Wealth, Direct Wealth, Seven Killings, Direct Officer, Indirect Print, and Direct Print.</p>
                            <p>Each Ten God represents specific personal relationships and personality traits, and is an important tool for analyzing BaZi interpersonal relationships and personality.</p>
                            <div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee;">
                                <h4>Basic Meanings of Ten Gods:</h4>
                                <ul>
                                    <li><strong>Peer:</strong> Symbolizes self-identity, siblings, competition</li>
                                    <li><strong>Rob Wealth:</strong> Symbolizes struggle, contention, assistance</li>
                                    <li><strong>Resource:</strong> Symbolizes talents, enjoyment, children</li>
                                    <li><strong>Hurting Officer:</strong> Symbolizes reform, breakthrough, rebellion</li>
                                    <li><strong>Indirect Wealth:</strong> Symbolizes unexpected wealth, flexibility, attraction to the opposite sex</li>
                                    <li><strong>Direct Wealth:</strong> Symbolizes stable income, frugality</li>
                                    <li><strong>Seven Killings:</strong> Symbolizes authority, decisiveness, challenges</li>
                                    <li><strong>Direct Officer:</strong> Symbolizes rules, systems, authority</li>
                                    <li><strong>Indirect Print:</strong> Symbolizes learning, wisdom, intuition</li>
                                    <li><strong>Direct Print:</strong> Symbolizes scholarship, study, mother</li>
                                </ul>
                            </div>
                            </div>`
                    },
                    'shensha': {
                        title: '神煞',
                        titleEn: 'Gods and Spirits',
                        content: `<div data-lang="zh">
                            <p>神煞是命理学中用来描述特定干支组合产生的特殊运势和影响的术语。</p>
                            <p>神煞分为吉神和凶煞两类，吉神如天乙贵人、文昌等代表有利影响，凶煞如白虎、天罗等代表不利影响。</p>
                            <p>神煞的出现需要特定干支条件，不同柱位的神煞对命主的影响也有所不同。一般来说，年柱神煞影响童年及祖上，月柱神煞影响青年及事业，日柱神煞影响成年及夫妻关系，时柱神煞影响老年及子女。</p>
                            <div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee;">
                                <h4>常见吉神及其含义:</h4>
                                <ul style="columns: 2;">
                                    <li><strong>天乙贵人:</strong> 贵人相助、逢凶化吉</li>
                                    <li><strong>文昌:</strong> 学业有成、才华横溢</li>
                                    <li><strong>文曲:</strong> 艺术才能、文学造诣</li>
                                    <li><strong>驿马:</strong> 活动力强、变动和外出</li>
                                    <li><strong>桃花:</strong> 异性缘佳、情感丰富</li>
                                    <li><strong>华盖:</strong> 特立独行、宗教信仰</li>
                                    <li><strong>天德:</strong> 德行好、得人帮助</li>
                                    <li><strong>天德合:</strong> 行善积德、贵人提携</li>
                                    <li><strong>月德:</strong> 逢凶化吉、官非消散</li>
                                    <li><strong>金舆:</strong> 财运亨通、奢华享受</li>
                                    <li><strong>天喜:</strong> 婚姻喜庆、家庭和睦</li>
                                    <li><strong>六合:</strong> 贵人相助、人缘良好</li>
                                </ul>
                                
                                <h4>常见凶煞及其含义:</h4>
                                <ul style="columns: 2;">
                                    <li><strong>白虎:</strong> 冲动莽撞、意外伤灾</li>
                                    <li><strong>天罗:</strong> 困境限制、难以解脱</li>
                                    <li><strong>地网:</strong> 局限、牵绊、束缚</li>
                                    <li><strong>孤辰:</strong> 孤独、缺少支持</li>
                                    <li><strong>寡宿:</strong> 婚姻不顺、孤独寂寞</li>
                                    <li><strong>咸池:</strong> 情感复杂、桃色纠纷</li>
                                    <li><strong>劫煞:</strong> 破财、波折、意外</li>
                                    <li><strong>灾煞:</strong> 灾祸、伤灾、官非</li>
                                    <li><strong>天刑:</strong> 伤灾、手术、争执</li>
                                    <li><strong>天牢:</strong> 牢狱之灾、限制束缚</li>
                                    <li><strong>岁破:</strong> 变动较大、不利稳定</li>
                                    <li><strong>大耗:</strong> 破财、消耗、疾病</li>
                                </ul>
                            </div>
                            
                            <div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee;">
                                <h4>神煞对命局的影响:</h4>
                                <p>神煞信息需要结合具体年、月、日、时柱位置和强弱来判断其影响。例如:</p>
                                <ul>
                                    <li>吉神在日主旺相时，对命局增益更明显；</li>
                                    <li>凶煞在日主衰弱时，不利影响往往更加突出；</li>
                                    <li>多个吉神同时出现在同一柱，往往代表该方面有特殊才能或好运；</li>
                                    <li>多个凶煞聚集在同一柱，可能预示该方面有特殊挑战或难关。</li>
                                </ul>
                                <p>神煞信息是八字命理分析中的重要补充，但不宜孤立看待，应结合整体命局的格局和五行强弱综合分析。</p>
                            </div>
                        </div>
                        <div data-lang="en" style="display:none">
                            <p>Gods and Spirits are terms used in destiny studies to describe special fortunes and influences produced by specific stem-branch combinations.</p>
                            <p>Gods and Spirits are divided into two categories: auspicious gods such as Tian Yi Noble Person and Wen Chang, which represent favorable influences, and inauspicious spirits such as White Tiger and Heavenly Net, which represent unfavorable influences.</p>
                            <p>The appearance of Gods and Spirits requires specific stem-branch conditions, and Gods and Spirits in different pillars have different effects on the destiny owner. Generally speaking, Gods and Spirits in the year pillar affect childhood and ancestors, Gods and Spirits in the month pillar affect youth and career, Gods and Spirits in the day pillar affect adulthood and marital relationships, and Gods and Spirits in the hour pillar affect old age and children.</p>
                            <div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee;">
                                <h4>Common Auspicious Gods and Their Meanings:</h4>
                                <ul style="columns: 2;">
                                    <li><strong>Tian Yi Noble Person:</strong> Noble assistance, turning misfortune into good fortune</li>
                                    <li><strong>Wen Chang:</strong> Academic success, outstanding talent</li>
                                    <li><strong>Wen Qu:</strong> Artistic ability, literary attainment</li>
                                    <li><strong>Yi Ma:</strong> Strong activity, change and going out</li>
                                    <li><strong>Peach Blossom:</strong> Good relationship with the opposite sex, rich emotions</li>
                                    <li><strong>Hua Gai:</strong> Independence, religious belief</li>
                                    <li><strong>Tian De:</strong> Good virtue, receiving help from others</li>
                                    <li><strong>Tian De He:</strong> Doing good deeds, receiving support from noble people</li>
                                    <li><strong>Yue De:</strong> Turning misfortune into good fortune, dissipation of official troubles</li>
                                    <li><strong>Jin Yu:</strong> Prosperous wealth, luxurious enjoyment</li>
                                    <li><strong>Tian Xi:</strong> Happy marriage, harmonious family</li>
                                    <li><strong>Liu He:</strong> Noble assistance, good relationships</li>
                                </ul>
                                
                                <h4>Common Inauspicious Spirits and Their Meanings:</h4>
                                <ul style="columns: 2;">
                                    <li><strong>White Tiger:</strong> Impulsive recklessness, accidental injury</li>
                                    <li><strong>Tian Luo:</strong> Difficult circumstances, hard to escape</li>
                                    <li><strong>Di Wang:</strong> Limitations, entanglements, constraints</li>
                                    <li><strong>Gu Chen:</strong> Loneliness, lack of support</li>
                                    <li><strong>Gua Su:</strong> Unsuccessful marriage, lonely and desolate</li>
                                    <li><strong>Xian Chi:</strong> Complex emotions, romantic entanglements</li>
                                    <li><strong>Jie Sha:</strong> Financial loss, setbacks, accidents</li>
                                    <li><strong>Zai Sha:</strong> Disasters, injuries, official troubles</li>
                                    <li><strong>Tian Xing:</strong> Injuries, surgery, disputes</li>
                                    <li><strong>Tian Lao:</strong> Imprisonment, restrictions and constraints</li>
                                    <li><strong>Sui Po:</strong> Major changes, unfavorable for stability</li>
                                    <li><strong>Da Hao:</strong> Financial loss, consumption, illness</li>
                                </ul>
                            </div>
                            
                            <div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee;">
                                <h4>The Influence of Gods and Spirits on Destiny:</h4>
                                <p>Information about Gods and Spirits needs to be judged in combination with the specific position and strength of the year, month, day, and hour pillars. For example:</p>
                                <ul>
                                    <li>Auspicious gods have more obvious benefits to destiny when the Day Master is strong;</li>
                                    <li>Unfavorable influences of inauspicious spirits are often more prominent when the Day Master is weak;</li>
                                    <li>Multiple auspicious gods appearing in the same pillar often represent special talents or good luck in that aspect;</li>
                                    <li>Multiple inauspicious spirits gathering in the same pillar may indicate special challenges or difficulties in that aspect.</li>
                                </ul>
                                <p>Information about Gods and Spirits is an important supplement to BaZi destiny analysis, but should not be viewed in isolation. It should be analyzed comprehensively in combination with the overall pattern of destiny and the strength and weakness of the Five Elements.</p>
                            </div>
                            </div>`
                    },
                    'kongwang': {
                        title: '空亡',
                        titleEn: 'Void',
                        content: `<div data-lang="zh">
                            <p>空亡是指在流年或命盘中，某些地支在特定干支组合下所产生的"虚空"现象。</p>
                            <p>空亡的地支代表其能量不稳定、难以发挥作用，可能导致相关事项难以实现或需要调整。</p>
                            <p>空亡并非一定不好，有时也可以代表放下、超脱或不执着的状态。</p>
                            <div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee;">
                                <h4>空亡判断规则:</h4>
                                <p>空亡的判断与日柱天干有关。例如：</p>
                                <ul>
                                    <li>甲己日空亡：戌亥</li>
                                    <li>乙庚日空亡：申酉</li>
                                    <li>丙辛日空亡：午未</li>
                                    <li>丁壬日空亡：辰巳</li>
                                    <li>戊癸日空亡：寅卯</li>
                                </ul>
                            </div>
                        </div>
                        <div data-lang="en" style="display:none">
                            <p>Void refers to the phenomenon of "emptiness" produced by certain Earthly Branches under specific stem-branch combinations in the flowing year or destiny chart.</p>
                            <p>The Void Earthly Branches represent unstable energy that is difficult to take effect, which may cause related matters to be difficult to achieve or need adjustment.</p>
                            <p>Void is not necessarily bad, and can sometimes represent a state of letting go, transcendence, or non-attachment.</p>
                            <div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee;">
                                <h4>Rules for Determining Void:</h4>
                                <p>The determination of Void is related to the Heavenly Stem of the day pillar. For example:</p>
                                <ul>
                                    <li>Jia/Ji day Void: Xu-Hai</li>
                                    <li>Yi/Geng day Void: Shen-You</li>
                                    <li>Bing/Xin day Void: Wu-Wei</li>
                                    <li>Ding/Ren day Void: Chen-Si</li>
                                    <li>Wu/Gui day Void: Yin-Mao</li>
                                </ul>
                            </div>
                            </div>`
                    }
                };
                
                if (!explanationDB[type]) {
                    showError('未找到相关解释');
                    return;
                }
                
                const explanation = explanationDB[type];
                
                // 构建解释内容
                const content = `
                    <h3 data-lang="zh">${explanation.title}</h3>
                    <h3 data-lang="en" style="display:none">${explanation.titleEn || explanation.title}</h3>
                    <div class="explanation-body">
                        ${explanation.content}
                    </div>
                `;
                
                // 显示解释
                document.getElementById('explanation-content').innerHTML = content;
                document.getElementById('explanation-modal').style.display = 'flex';
                
            } catch (error) {
                console.error('显示解释出错:', error);
                showError('无法显示解释: ' + error.message);
            }
        };
        
        // 点击模态框背景时关闭
        window.addEventListener('click', function(event) {
            const pillarModal = document.getElementById('pillar-modal');
            const explanationModal = document.getElementById('explanation-modal');
            
            if (event.target === pillarModal) {
                closePillarModal();
            }
            
            if (event.target === explanationModal) {
                closeExplanationModal();
            }
        });
        
        // 显示大运详情的函数
        window.showDayunDetail = function(ganzhi, dayunIndex, startYear, endYear) {
            try {
                // 获取当前语言设置
                const isEnglish = document.querySelector('[data-lang="en"]').style.display !== 'none';
                const currentLang = isEnglish ? 'en' : 'zh';
                
                // 从localStorage获取分析数据
                const analysisDataStr = localStorage.getItem('baziAnalysisData');
                if (!analysisDataStr) {
                    showError('未找到分析数据');
                    return;
                }
                
                const analysisData = JSON.parse(analysisDataStr);
                if (!analysisData.ganzhi) {
                    showError('分析数据不完整');
                    return;
                }
                
                // 获取用户数据
                const userDataStr = localStorage.getItem('baziUserData');
                const userData = userDataStr ? JSON.parse(userDataStr) : null;
                
                // 确定出生季节
                let birthSeason = '未知';
                if (analysisData.ganzhi.month) {
                    birthSeason = determineSeason(analysisData.ganzhi.month);
                }
                
                // 解析干支
                const gan = ganzhi.charAt(0);
                const zhi = ganzhi.charAt(1);
                
                // 获取五行属性
                const ganWuxing = {
                    '甲': '木', '乙': '木',
                    '丙': '火', '丁': '火',
                    '戊': '土', '己': '土',
                    '庚': '金', '辛': '金',
                    '壬': '水', '癸': '水'
                };
                
                const zhiWuxing = {
                    '子': '水', '丑': '土',
                    '寅': '木', '卯': '木',
                    '辰': '土', '巳': '火',
                    '午': '火', '未': '土',
                    '申': '金', '酉': '金',
                    '戌': '土', '亥': '水'
                };
                
                // 纳音定义
                const nayinMap = {
                    '甲子':'海中金', '乙丑':'海中金', 
                    '丙寅':'炉中火', '丁卯':'炉中火',
                    '戊辰':'大林木', '己巳':'大林木',
                    '庚午':'路旁土', '辛未':'路旁土',
                    '壬申':'剑锋金', '癸酉':'剑锋金',
                    '甲戌':'山头火', '乙亥':'山头火',
                    '丙子':'涧下水', '丁丑':'涧下水',
                    '戊寅':'城头土', '己卯':'城头土',
                    '庚辰':'白蜡金', '辛巳':'白蜡金',
                    '壬午':'杨柳木', '癸未':'杨柳木',
                    '甲申':'泉中水', '乙酉':'泉中水',
                    '丙戌':'屋上土', '丁亥':'屋上土',
                    '戊子':'霹雳火', '己丑':'霹雳火',
                    '庚寅':'松柏木', '辛卯':'松柏木',
                    '壬辰':'长流水', '癸巳':'长流水',
                    '甲午':'砂石金', '乙未':'砂石金',
                    '丙申':'山下火', '丁酉':'山下火',
                    '戊戌':'平地木', '己亥':'平地木',
                    '庚子':'壁上土', '辛丑':'壁上土',
                    '壬寅':'金薄金', '癸卯':'金薄金',
                    '甲辰':'覆灯火', '乙巳':'覆灯火',
                    '丙午':'天河水', '丁未':'天河水',
                    '戊申':'大驿土', '己酉':'大驿土',
                    '庚戌':'钗环金', '辛亥':'钗环金',
                    '壬子':'桑柘木', '癸丑':'桑柘木',
                    '甲寅':'大溪水', '乙卯':'大溪水',
                    '丙辰':'沙中土', '丁巳':'沙中土',
                    '戊午':'天上火', '己未':'天上火',
                    '庚申':'石榴木', '辛酉':'石榴木',
                    '壬戌':'大海水', '癸亥':'大海水'
                };
                
                // 日主天干
                const dayGan = analysisData.ganzhi.day.charAt(0);
                
                // 计算十神关系
                let shishen = '';
                if (dayGan) {
                    shishen = getShishenRelation(dayGan, gan);
                }
                
                // 流年预测
                let flowYearsHTML = '';
                let flowYearsHTMLEn = '';
                
                // 生肖的英文翻译
                const zodiacEn = {
                    '鼠': 'Rat', '牛': 'Ox', '虎': 'Tiger', '兔': 'Rabbit',
                    '龙': 'Dragon', '蛇': 'Snake', '马': 'Horse', '羊': 'Goat',
                    '猴': 'Monkey', '鸡': 'Rooster', '狗': 'Dog', '猪': 'Pig'
                };
                
                // 五行的英文翻译
                const wuxingEn = {
                    '木': 'Wood', '火': 'Fire', '土': 'Earth',
                    '金': 'Metal', '水': 'Water'
                };

                // 十神的英文翻译
                const shishenEn = {
                    '正官': 'Direct Officer', '七杀': 'Seven Killings',
                    '正印': 'Direct Resource', '偏印': 'Indirect Resource',
                    '正财': 'Direct Wealth', '偏财': 'Indirect Wealth',
                    '食神': 'Direct Output', '伤官': 'Indirect Output',
                    '比肩': 'Direct Peer', '劫财': 'Indirect Peer'
                };
                
                for (let i = 0; i < 10; i++) {
                    const year = startYear + i;
                    const age = year - parseInt(userData.birthDate.split('-')[0]);
                    
                    // 计算干支纪年
                    const heavenlyStems = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
                    const earthlyBranches = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
                    
                    const stemIndex = (year - 4) % 10;
                    const branchIndex = (year - 4) % 12;
                    
                    const flowYearGanzhi = heavenlyStems[stemIndex] + earthlyBranches[branchIndex];
                    const flowYearElement = ganWuxing[heavenlyStems[stemIndex]];
                    const zodiac = ['鼠', '牛', '虎', '兔', '龙', '蛇', '马', '羊', '猴', '鸡', '狗', '猪'][branchIndex];
                    
                    // 中文版本
                    flowYearsHTML += `
                        <tr>
                            <td>${year}年</td>
                            <td>${age}岁</td>
                            <td>${flowYearGanzhi}</td>
                            <td class="${getWuxingColorClass(flowYearElement)}">${flowYearElement}</td>
                            <td>${zodiac}</td>
                            <td>${getDayunFlowYearAdvice(ganWuxing[gan], flowYearElement)}</td>
                        </tr>
                    `;
                    
                    // 英文版本
                    flowYearsHTMLEn += `
                        <tr>
                            <td>${year}</td>
                            <td>${age}</td>
                            <td>${flowYearGanzhi}</td>
                            <td class="${getWuxingColorClass(flowYearElement)}">${wuxingEn[flowYearElement]}</td>
                            <td>${zodiacEn[zodiac]}</td>
                            <td>${getDayunFlowYearAdviceEn(ganWuxing[gan], flowYearElement)}</td>
                        </tr>
                    `;
                }
                
                // 构建详细信息HTML
                const nayin = nayinMap[ganzhi] || '未知';
                const ganElement = ganWuxing[gan] || '未知';
                const zhiElement = zhiWuxing[zhi] || '未知';
                
                const details = `
                    <div class="dayun-detail-header">
                        <div data-lang="zh">
                        <h3>第${dayunIndex + 1}大运：${ganzhi}运 (${startYear}年-${endYear}年)</h3>
                        </div>
                        <div data-lang="en" style="display:none">
                            <h3>Destiny Period ${dayunIndex + 1}: ${ganzhi} (${startYear}-${endYear})</h3>
                        </div>
                    </div>
                    
                    <div class="dayun-detail-grid">
                        <div class="detail-item">
                            <div data-lang="zh">
                            <label>天干：</label>
                            <span>${gan}（${ganElement}）</span>
                            </div>
                            <div data-lang="en" style="display:none">
                                <label>Heavenly Stem:</label>
                                <span>${gan} (${ganElement})</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div data-lang="zh">
                            <label>地支：</label>
                            <span>${zhi}（${zhiElement}）</span>
                            </div>
                            <div data-lang="en" style="display:none">
                                <label>Earthly Branch:</label>
                                <span>${zhi} (${zhiElement})</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div data-lang="zh">
                            <label>纳音：</label>
                            <span>${nayin}</span>
                            </div>
                            <div data-lang="en" style="display:none">
                                <label>Hidden Stem:</label>
                                <span>${nayin}</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div data-lang="zh">
                            <label>与日主关系：</label>
                            <span>${shishen}</span>
                            </div>
                            <div data-lang="en" style="display:none">
                                <label>Relationship with Day Master:</label>
                                <span>${shishenEn[shishen] || shishen}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-divider"></div>
                    
                    <div class="dayun-analysis">
                        <div data-lang="zh">
                        <h3>大运分析</h3>
                        <p>${getDayunAnalysis(ganElement, zhiElement, dayGan ? ganWuxing[dayGan] : null, birthSeason)}</p>
                        </div>
                        <div data-lang="en" style="display:none">
                            <h3>Destiny Period Analysis</h3>
                            <p>${getDayunAnalysisEn(ganElement, zhiElement, dayGan ? ganWuxing[dayGan] : null, birthSeason)}</p>
                        </div>
                    </div>
                    
                    <div class="dayun-advice">
                        <div data-lang="zh">
                        <h3>大运建议</h3>
                        <ul>
                            ${getDayunAdvice(ganElement, zhiElement, shishen)}
                        </ul>
                        </div>
                        <div data-lang="en" style="display:none">
                            <h3>Destiny Period Advice</h3>
                            <ul>
                                ${getDayunAdviceEn(ganElement, zhiElement, shishen)}
                            </ul>
                        </div>
                    </div>
                    
                    <div class="section-divider"></div>
                    
                    <div class="flow-years">
                        <div data-lang="zh">
                        <h3>流年详情</h3>
                        <table class="flow-years-table">
                            <thead>
                                <tr>
                                    <th>年份</th>
                                    <th>年龄</th>
                                    <th>干支</th>
                                    <th>五行</th>
                                    <th>生肖</th>
                                    <th>提示</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${flowYearsHTML}
                            </tbody>
                        </table>
                        </div>
                        <div data-lang="en" style="display:none">
                            <h3>Annual Details</h3>
                            <table class="flow-years-table">
                                <thead>
                                    <tr>
                                        <th>Year</th>
                                        <th>Age</th>
                                        <th>Stem-Branch</th>
                                        <th>Element</th>
                                        <th>Zodiac</th>
                                        <th>Note</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${flowYearsHTMLEn}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // 显示详情
                const dayunDetailsElement = document.getElementById('dayun-details');
                
                // 根据当前语言设置显示或隐藏对应语言的内容
                const zhElements = dayunDetailsElement.querySelectorAll('[data-lang="zh"]');
                const enElements = dayunDetailsElement.querySelectorAll('[data-lang="en"]');
                
                zhElements.forEach(el => el.style.display = currentLang === 'zh' ? '' : 'none');
                enElements.forEach(el => el.style.display = currentLang === 'en' ? '' : 'none');
                
                dayunDetailsElement.innerHTML = `
                    <div class="dayun-header">
                        <div data-lang="zh">
                            <h2>第${dayunIndex + 1}大运: ${ganzhi}运 (${startYear}年-${endYear}年)</h2>
                        </div>
                        <div data-lang="en" style="display:none">
                            <h2>Destiny Period ${dayunIndex + 1}: ${ganzhi} (${startYear}-${endYear})</h2>
                        </div>
                    </div>
                    
                    <div class="dayun-basic-info">
                        <div class="detail-item">
                            <div data-lang="zh">
                                <label>天干：</label>
                                <span>${gan}（${ganElement}）</span>
                            </div>
                            <div data-lang="en" style="display:none">
                                <label>Heavenly Stem:</label>
                                <span>${gan} (${ganElement})</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div data-lang="zh">
                                <label>地支：</label>
                                <span>${zhi}（${zhiElement}）</span>
                            </div>
                            <div data-lang="en" style="display:none">
                                <label>Earthly Branch:</label>
                                <span>${zhi} (${zhiElement})</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div data-lang="zh">
                                <label>纳音：</label>
                                <span>${nayin}</span>
                            </div>
                            <div data-lang="en" style="display:none">
                                <label>Hidden Stem:</label>
                                <span>${translateNayin(nayin)}</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div data-lang="zh">
                                <label>与日主关系：</label>
                                <span>${shishen}</span>
                            </div>
                            <div data-lang="en" style="display:none">
                                <label>Relationship with Day Master:</label>
                                <span>${shishenEn[shishen] || shishen}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-divider"></div>
                    
                    <div class="dayun-analysis">
                        <div data-lang="zh">
                            <h3>大运分析</h3>
                            <p>${getDayunAnalysis(ganElement, zhiElement, dayGan ? ganWuxing[dayGan] : null, birthSeason)}</p>
                        </div>
                        <div data-lang="en" style="display:none">
                            <h3>Destiny Period Analysis</h3>
                            <p>${getDayunAnalysisEn(ganElement, zhiElement, dayGan ? ganWuxing[dayGan] : null, birthSeason)}</p>
                        </div>
                    </div>
                    
                    <div class="dayun-advice">
                        <div data-lang="zh">
                            <h3>大运建议</h3>
                            <ul>
                                ${getDayunAdvice(ganElement, zhiElement, shishen)}
                            </ul>
                        </div>
                        <div data-lang="en" style="display:none">
                            <h3>Destiny Period Advice</h3>
                            <ul>
                                ${getDayunAdviceEn(ganElement, zhiElement, shishen)}
                            </ul>
                        </div>
                    </div>
                    
                    <div class="section-divider"></div>
                    
                    <div class="flow-years">
                        <div data-lang="zh">
                            <h3>流年详情</h3>
                            <table class="flow-years-table">
                                <thead>
                                    <tr>
                                        <th>年份</th>
                                        <th>年龄</th>
                                        <th>干支</th>
                                        <th>五行</th>
                                        <th>生肖</th>
                                        <th>提示</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${flowYearsHTML}
                                </tbody>
                            </table>
                        </div>
                        <div data-lang="en" style="display:none">
                            <h3>Annual Details</h3>
                            <table class="flow-years-table">
                                <thead>
                                    <tr>
                                        <th>Year</th>
                                        <th>Age</th>
                                        <th>Stem-Branch</th>
                                        <th>Element</th>
                                        <th>Zodiac</th>
                                        <th>Note</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${flowYearsHTMLEn}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                document.getElementById('dayun-modal').style.display = 'flex';
                
            } catch (error) {
                console.error('显示大运详情出错:', error);
                showError('无法显示大运详情: ' + error.message);
            }
        };
        
        // 关闭大运详情模态框
        window.closeDayunModal = function() {
            document.getElementById('dayun-modal').style.display = 'none';
        };
        
        // 获取大运分析（中文）
        function getDayunAnalysis(ganElement, zhiElement, dayElement, birthSeason) {
            let analysis = '';
            
            if (!dayElement) {
                analysis = `这个大运的天干五行为${ganElement}，地支五行为${zhiElement}。`;
                return analysis;
            }
            
            // 分析天干五行与日主的关系
            if (ganElement === dayElement) {
                analysis += `天干五行为${ganElement}，与日主五行相同，能量相互协调。`;
            } else if (
                (ganElement === '木' && dayElement === '火') ||
                (ganElement === '火' && dayElement === '土') ||
                (ganElement === '土' && dayElement === '金') ||
                (ganElement === '金' && dayElement === '水') ||
                (ganElement === '水' && dayElement === '木')
            ) {
                analysis += `天干五行${ganElement}生日主${dayElement}，为日主提供能量，有助于个人发展。`;
            } else if (
                (dayElement === '木' && ganElement === '火') ||
                (dayElement === '火' && ganElement === '土') ||
                (dayElement === '土' && ganElement === '金') ||
                (dayElement === '金' && ganElement === '水') ||
                (dayElement === '水' && ganElement === '木')
            ) {
                analysis += `日主五行${dayElement}生天干五行${ganElement}，日主能量被消耗，需要谨慎应对。`;
            } else if (
                (ganElement === '木' && dayElement === '金') ||
                (ganElement === '火' && dayElement === '水') ||
                (ganElement === '土' && dayElement === '木') ||
                (ganElement === '金' && dayElement === '火') ||
                (ganElement === '水' && dayElement === '土')
            ) {
                analysis += `天干五行${ganElement}克制日主${dayElement}，这段时期会面临挑战和压力。`;
            } else if (
                (dayElement === '木' && ganElement === '土') ||
                (dayElement === '火' && ganElement === '金') ||
                (dayElement === '土' && ganElement === '水') ||
                (dayElement === '金' && ganElement === '木') ||
                (dayElement === '水' && ganElement === '火')
            ) {
                analysis += `日主五行${dayElement}克制天干五行${ganElement}，个人能力得到发挥，但需注意平衡。`;
            }
            
            // 添加关于季节影响的分析
            if (birthSeason) {
                const seasonalStrength = getSeasonalStrength(ganElement, birthSeason);
                analysis += ` 在${birthSeason}季节中，${ganElement}的能量${seasonalStrength}。`;
            }
            
            return analysis;
        }

        // 获取大运分析（英文）
        function getDayunAnalysisEn(ganElement, zhiElement, dayElement, birthSeason) {
            let analysis = '';
            
            if (!dayElement) {
                analysis = `This destiny period has a heavenly stem element of ${ganElement} and an earthly branch element of ${zhiElement}.`;
                return analysis;
            }
            
            // 分析天干五行与日主的关系
            if (ganElement === dayElement) {
                analysis += `The heavenly stem element ${ganElement} matches your day master element, indicating a period of harmony and balance.`;
            } else if (
                (ganElement === '木' && dayElement === '火') ||
                (ganElement === '火' && dayElement === '土') ||
                (ganElement === '土' && dayElement === '金') ||
                (ganElement === '金' && dayElement === '水') ||
                (ganElement === '水' && dayElement === '木')
            ) {
                analysis += `The heavenly stem element ${ganElement} generates your day master element ${dayElement}, bringing supportive energy and opportunities.`;
            } else if (
                (dayElement === '木' && ganElement === '火') ||
                (dayElement === '火' && ganElement === '土') ||
                (dayElement === '土' && ganElement === '金') ||
                (dayElement === '金' && ganElement === '水') ||
                (dayElement === '水' && ganElement === '木')
            ) {
                analysis += `Your day master element ${dayElement} generates the heavenly stem element ${ganElement}, suggesting a period of giving and contribution.`;
            } else if (
                (ganElement === '木' && dayElement === '金') ||
                (ganElement === '火' && dayElement === '水') ||
                (ganElement === '土' && dayElement === '木') ||
                (ganElement === '金' && dayElement === '火') ||
                (ganElement === '水' && dayElement === '土')
            ) {
                analysis += `The heavenly stem element ${ganElement} controls your day master element ${dayElement}, indicating potential challenges and transformations.`;
            } else if (
                (dayElement === '木' && ganElement === '土') ||
                (dayElement === '火' && ganElement === '金') ||
                (dayElement === '土' && ganElement === '水') ||
                (dayElement === '金' && ganElement === '木') ||
                (dayElement === '水' && ganElement === '火')
            ) {
                analysis += `Your day master element ${dayElement} controls the heavenly stem element ${ganElement}, suggesting a period of personal power and influence.`;
            }
            
            // 添加关于季节影响的分析
            if (birthSeason) {
                const seasonalStrengthEn = {
                    '最旺': 'is at its strongest',
                    '次旺': 'is relatively strong',
                    '较弱': 'is relatively weak',
                    '最弱': 'is at its weakest',
                    '一般': 'has moderate strength'
                };
                const seasonEn = {
                    '春': 'Spring',
                    '夏': 'Summer',
                    '秋': 'Autumn',
                    '冬': 'Winter'
                };
                const strength = getSeasonalStrength(ganElement, birthSeason);
                analysis += ` During the ${seasonEn[birthSeason]} season, the ${ganElement} element ${seasonalStrengthEn[strength]}.`;
            }
            
            return analysis;
        }

        function analyzeDayMasterRelation(dayElement, ganElement, zhiElement) {
            let analysis = '';
            
            if (!dayElement) {
                analysis = `这个大运的天干五行为${ganElement}，地支五行为${zhiElement}。`;
                return analysis;
            }
            
            // 分析天干五行与日主的关系
            if (ganElement === dayElement) {
                analysis += `天干五行为${ganElement}，与日主五行相同，能量相互协调。`;
            } else if (
                (ganElement === '木' && dayElement === '火') ||
                (ganElement === '火' && dayElement === '土') ||
                (ganElement === '土' && dayElement === '金') ||
                (ganElement === '金' && dayElement === '水') ||
                (ganElement === '水' && dayElement === '木')
            ) {
                analysis += `天干五行${ganElement}生日主${dayElement}，为日主提供能量，有助于个人发展。`;
            } else if (
                (dayElement === '木' && ganElement === '火') ||
                (dayElement === '火' && ganElement === '土') ||
                (dayElement === '土' && ganElement === '金') ||
                (dayElement === '金' && ganElement === '水') ||
                (dayElement === '水' && ganElement === '木')
            ) {
                analysis += `日主五行${dayElement}生天干五行${ganElement}，日主能量被消耗，需要谨慎应对。`;
            } else if (
                (ganElement === '木' && dayElement === '金') ||
                (ganElement === '火' && dayElement === '水') ||
                (ganElement === '土' && dayElement === '木') ||
                (ganElement === '金' && dayElement === '火') ||
                (ganElement === '水' && dayElement === '土')
            ) {
                analysis += `天干五行${ganElement}克制日主${dayElement}，这段时期会面临挑战和压力。`;
            } else if (
                (dayElement === '木' && ganElement === '土') ||
                (dayElement === '火' && ganElement === '金') ||
                (dayElement === '土' && ganElement === '水') ||
                (dayElement === '金' && ganElement === '木') ||
                (dayElement === '水' && ganElement === '火')
            ) {
                analysis += `日主五行${dayElement}克制天干五行${ganElement}，个人能力得到发挥，但需注意平衡。`;
            }
            
            // 添加关于季节影响的分析
            if (birthSeason) {
                const seasonalStrength = getSeasonalStrength(ganElement, birthSeason);
                analysis += ` 在${birthSeason}季节中，${ganElement}的能量${seasonalStrength}。`;
            }
            
            return analysis;
        }
        
        // 获取流年分析的英文版本
        function getFlowYearAnalysisEn(dayElement, ganElement, fuxing) {
            let analysis = '';
            
            // 分析五行关系
            if (ganElement === dayElement) {
                analysis += `The heavenly stem's element ${ganElement} is the same as your day master element, indicating a period of harmony and balance.`;
            } else if (
                (ganElement === 'Wood' && dayElement === 'Fire') ||
                (ganElement === 'Fire' && dayElement === 'Earth') ||
                (ganElement === 'Earth' && dayElement === 'Metal') ||
                (ganElement === 'Metal' && dayElement === 'Water') ||
                (ganElement === 'Water' && dayElement === 'Wood')
            ) {
                analysis += `The year's element ${ganElement} generates your day master element ${dayElement}, bringing supportive energy and opportunities.`;
            } else if (
                (dayElement === 'Wood' && ganElement === 'Fire') ||
                (dayElement === 'Fire' && ganElement === 'Earth') ||
                (dayElement === 'Earth' && ganElement === 'Metal') ||
                (dayElement === 'Metal' && ganElement === 'Water') ||
                (dayElement === 'Water' && ganElement === 'Wood')
            ) {
                analysis += `Your day master element ${dayElement} generates the year's element ${ganElement}, suggesting a period of giving and contribution.`;
            } else if (
                (ganElement === 'Wood' && dayElement === 'Metal') ||
                (ganElement === 'Fire' && dayElement === 'Water') ||
                (ganElement === 'Earth' && dayElement === 'Wood') ||
                (ganElement === 'Metal' && dayElement === 'Fire') ||
                (ganElement === 'Water' && dayElement === 'Earth')
            ) {
                analysis += `The year's element ${ganElement} controls your day master element ${dayElement}, indicating potential challenges and transformations.`;
            } else if (
                (dayElement === 'Wood' && ganElement === 'Earth') ||
                (dayElement === 'Fire' && ganElement === 'Metal') ||
                (dayElement === 'Earth' && ganElement === 'Water') ||
                (dayElement === 'Metal' && ganElement === 'Wood') ||
                (dayElement === 'Water' && ganElement === 'Fire')
            ) {
                analysis += `Your day master element ${dayElement} controls the year's element ${ganElement}, suggesting a period of personal power and influence.`;
            }
            
            // 添加十神影响分析
            const fuxingAdvice = {
                'Peer': ' This year brings opportunities for collaboration and teamwork.',
                'Robbing Wealth': ' Financial matters require careful attention and planning.',
                'Food God': ' A good time for creative and artistic pursuits.',
                'Hurting Officer': ' Focus on innovation and learning, but avoid conflicts.',
                'Partial Wealth': ' Potential for unexpected gains, stay alert for opportunities.',
                'Proper Wealth': ' Stable financial prospects, focus on steady growth.',
                'Seven Killing': ' Face challenges with strategy and adaptability.',
                'Proper Officer': ' Good time for career advancement and recognition.',
                'Partial Seal': ' Period of learning and self-improvement.',
                'Proper Seal': ' Beneficial for academic and spiritual growth.'
            };
            
            if (fuxingAdvice[fuxing]) {
                analysis += fuxingAdvice[fuxing];
            }
            
            return analysis;
        }
        
        // 纳音五行翻译函数
        function translateNayin(nayin) {
            const nayinTranslation = {
                '海中金': 'Gold in Sea',
                '炉中火': 'Fire in Furnace',
                '大林木': 'Wood in Forest',
                '路旁土': 'Earth by Road',
                '剑锋金': 'Gold of Sword',
                '山头火': 'Fire on Mountain',
                '涧下水': 'Water in Valley',
                '城头土': 'Earth on Wall',
                '白蜡金': 'White Wax Gold',
                '杨柳木': 'Willow Wood',
                '泉中水': 'Water in Spring',
                '屋上土': 'Earth on House',
                '霹雳火': 'Thunder Fire',
                '松柏木': 'Pine Wood',
                '长流水': 'Flowing Water',
                '砂石金': 'Sand Gold',
                '山下火': 'Fire under Mountain',
                '平地木': 'Wood on Ground',
                '壁上土': 'Earth on Wall',
                '金薄金': 'Gold Foil',
                '覆灯火': 'Candle Fire',
                '天河水': 'Celestial Water',
                '大驿土': 'Earth of Post Station'
            };
            return nayinTranslation[nayin] || nayin;
        }
        
        // 获取季节对五行的影响
        function getSeasonalStrength(element, season) {
            const seasonalMap = {
                '木': {'春': '最旺', '夏': '次旺', '秋': '较弱', '冬': '最弱'},
                '火': {'春': '次旺', '夏': '最旺', '秋': '最弱', '冬': '较弱'},
                '土': {'春': '最弱', '夏': '次旺', '秋': '最旺', '冬': '较弱'},
                '金': {'春': '较弱', '夏': '最弱', '秋': '最旺', '冬': '次旺'},
                '水': {'春': '次旺', '夏': '较弱', '秋': '最弱', '冬': '最旺'}
            };
            
            return seasonalMap[element] && seasonalMap[element][season] 
                ? seasonalMap[element][season] 
                : '一般';
        }
        
        // 获取大运建议（中文）
        function getDayunAdvice(ganElement, zhiElement, shishen) {
            let advice = '';
            
            // 基于五行的建议
            const elementAdvice = {
                '木': '<li>适合发展创新和成长型事业，如教育、艺术、环保等领域。</li><li>注意培养耐心和稳定性，避免冲动。</li><li>注意肝胆健康，避免情绪波动。</li>',
                '火': '<li>适合需要热情和表现力的工作，如营销、表演、管理等。</li><li>控制情绪，避免过度兴奋和疲劳。</li><li>注意心脏和循环系统健康，保持作息规律。</li>',
                '土': '<li>适合稳定发展，需要责任心和踏实的工作。</li><li>培养决断力，避免过度思虑和犹豫。</li><li>注意消化系统健康，保持饮食规律。</li>',
                '金': '<li>适合需要精确和纪律性的工作，如金融、法律、工程等。</li><li>培养灵活性和情感表达。</li><li>注意呼吸系统健康，保持环境清洁。</li>',
                '水': '<li>适合运用智慧和沟通能力的文化、科技、咨询等行业。</li><li>加强自信和决断力，避免过度顺从。</li><li>注意肾脏和泌尿系统健康，注意保暖。</li>'
            };
            
            // 基于十神的建议
            const shishenAdvice = {
                '比肩': '<li>此运势能量相似，适合合作与竞争。</li><li>注意协调关系，避免过度竞争。</li>',
                '劫财': '<li>财运有波动，需要谨慎理财。</li><li>可以发挥个人能力但要避免自负。</li>',
                '食神': '<li>适合发挥创造力和艺术才能。</li><li>享受生活，保持乐观积极的心态。</li>',
                '伤官': '<li>思维活跃，适合学习和创新。</li><li>控制情绪，避免言行过激。</li>',
                '偏财': '<li>可能有意外收获，但也需要防范风险。</li><li>积极把握机会，开拓新的领域。</li>',
                '正财': '<li>财运稳定，适合稳健投资和积累。</li><li>注重实际效益，避免投机。</li>',
                '七杀': '<li>面临挑战和压力，需要调整策略。</li><li>培养领导能力但避免过度冲突。</li>',
                '正官': '<li>适合遵循规则，获得正式认可。</li><li>注重事业发展和社会责任。</li>',
                '偏印': '<li>适合学习和反思，提升内在修养。</li><li>培养独立思考能力，注重精神成长。</li>',
                '正印': '<li>获得知识和支持，增强个人素质。</li><li>注重传统知识和技能的学习。</li>'
            };
            
            advice = elementAdvice[ganElement] || '';
            
            if (shishen && shishenAdvice[shishen]) {
                advice += shishenAdvice[shishen];
            }
            
            return advice || '<li>保持平衡的生活方式，注重身心健康。</li><li>根据具体情况灵活调整策略。</li>';
        }
        
        // 获取大运建议（英文）
        function getDayunAdviceEn(ganElement, zhiElement, shishen) {
            let advice = '';
            
            // 基于五行的建议
            const elementAdvice = {
                '木': '<li>Suitable for developing innovative and growth-oriented careers, such as education, arts, and environmental protection.</li><li>Focus on cultivating patience and stability, avoid being impulsive.</li><li>Maintain liver and gallbladder health, avoid emotional fluctuations.</li>',
                '火': '<li>Suitable for work requiring enthusiasm and expressiveness, such as marketing, performance, and management.</li><li>Control emotions, avoid over-excitement and fatigue.</li><li>Pay attention to heart and circulatory system health, maintain regular routines.</li>',
                '土': '<li>Suitable for stable development, work requiring responsibility and steadiness.</li><li>Cultivate decisiveness, avoid overthinking and indecision.</li><li>Pay attention to digestive system health, maintain regular eating habits.</li>',
                '金': '<li>Suitable for work requiring precision and discipline, such as finance, law, and engineering.</li><li>Cultivate flexibility and emotional expression.</li><li>Pay attention to respiratory system health, maintain a clean environment.</li>',
                '水': '<li>Suitable for utilizing wisdom and communication skills in culture, technology, and consulting industries.</li><li>Strengthen self-confidence and decisiveness, avoid excessive compliance.</li><li>Pay attention to kidney and urinary system health, stay warm.</li>'
            };
            
            // 基于十神的建议
            const shishenAdvice = {
                '比肩': '<li>This period has similar energy, suitable for cooperation and competition.</li><li>Focus on harmonizing relationships, avoid excessive competition.</li>',
                '劫财': '<li>Financial fluctuations may occur, careful financial management is needed.</li><li>Can utilize personal abilities but avoid overconfidence.</li>',
                '食神': '<li>Suitable for expressing creativity and artistic talents.</li><li>Enjoy life, maintain an optimistic and positive attitude.</li>',
                '伤官': '<li>Active thinking, suitable for learning and innovation.</li><li>Control emotions, avoid excessive words and actions.</li>',
                '偏财': '<li>Possible unexpected gains, but also need to guard against risks.</li><li>Actively seize opportunities, explore new areas.</li>',
                '正财': '<li>Stable financial fortune, suitable for steady investment and accumulation.</li><li>Focus on practical benefits, avoid speculation.</li>',
                '七杀': '<li>Facing challenges and pressure, need to adjust strategies.</li><li>Develop leadership abilities but avoid excessive conflict.</li>',
                '正官': '<li>Suitable for following rules and gaining formal recognition.</li><li>Focus on career development and social responsibility.</li>',
                '偏印': '<li>Suitable for learning and reflection, enhance inner cultivation.</li><li>Develop independent thinking ability, focus on spiritual growth.</li>',
                '正印': '<li>Gain knowledge and support, strengthen personal qualities.</li><li>Focus on learning traditional knowledge and skills.</li>'
            };
            
            advice = elementAdvice[ganElement] || '';
            
            if (shishen && shishenAdvice[shishen]) {
                advice += shishenAdvice[shishen];
            }
            
            return advice || '<li>Maintain a balanced lifestyle, focus on physical and mental health.</li><li>Adjust strategies according to specific situations.</li>';
        }
        
        // 获取大运与流年的建议（中文）
        function getDayunFlowYearAdvice(dayunElement, flowYearElement) {
            if (dayunElement === flowYearElement) {
                return '能量相似，互相强化';
            } else if (
                (dayunElement === '木' && flowYearElement === '火') ||
                (dayunElement === '火' && flowYearElement === '土') ||
                (dayunElement === '土' && flowYearElement === '金') ||
                (dayunElement === '金' && flowYearElement === '水') ||
                (dayunElement === '水' && flowYearElement === '木')
            ) {
                return '相生关系，能量流动顺畅';
            } else if (
                (dayunElement === '木' && flowYearElement === '金') ||
                (dayunElement === '火' && flowYearElement === '水') ||
                (dayunElement === '土' && flowYearElement === '木') ||
                (dayunElement === '金' && flowYearElement === '火') ||
                (dayunElement === '水' && flowYearElement === '土')
            ) {
                return '相克关系，注意调和';
            } else if (
                (flowYearElement === '木' && dayunElement === '火') ||
                (flowYearElement === '火' && dayunElement === '土') ||
                (flowYearElement === '土' && dayunElement === '金') ||
                (flowYearElement === '金' && dayunElement === '水') ||
                (flowYearElement === '水' && dayunElement === '木')
            ) {
                return '流年生大运，有助力';
            } else if (
                (flowYearElement === '木' && dayunElement === '金') ||
                (flowYearElement === '火' && dayunElement === '水') ||
                (flowYearElement === '土' && dayunElement === '木') ||
                (flowYearElement === '金' && dayunElement === '火') ||
                (flowYearElement === '水' && dayunElement === '土')
            ) {
                return '流年克大运，有挑战';
            }
            
            return '能量变化平稳';
        }

        // 获取大运与流年的建议（英文）
        function getDayunFlowYearAdviceEn(dayunElement, flowYearElement) {
            if (dayunElement === flowYearElement) {
                return 'Similar energy, mutually reinforcing';
            } else if (
                (dayunElement === '木' && flowYearElement === '火') ||
                (dayunElement === '火' && flowYearElement === '土') ||
                (dayunElement === '土' && flowYearElement === '金') ||
                (dayunElement === '金' && flowYearElement === '水') ||
                (dayunElement === '水' && flowYearElement === '木')
            ) {
                return 'Generating relationship, smooth energy flow';
            } else if (
                (dayunElement === '木' && flowYearElement === '金') ||
                (dayunElement === '火' && flowYearElement === '水') ||
                (dayunElement === '土' && flowYearElement === '木') ||
                (dayunElement === '金' && flowYearElement === '火') ||
                (dayunElement === '水' && flowYearElement === '土')
            ) {
                return 'Controlling relationship, need harmonization';
            } else if (
                (flowYearElement === '木' && dayunElement === '火') ||
                (flowYearElement === '火' && dayunElement === '土') ||
                (flowYearElement === '土' && dayunElement === '金') ||
                (flowYearElement === '金' && dayunElement === '水') ||
                (flowYearElement === '水' && dayunElement === '木')
            ) {
                return 'Annual branch supports destiny period';
            } else if (
                (flowYearElement === '木' && dayunElement === '金') ||
                (flowYearElement === '火' && dayunElement === '水') ||
                (flowYearElement === '土' && dayunElement === '木') ||
                (flowYearElement === '金' && dayunElement === '火') ||
                (flowYearElement === '水' && dayunElement === '土')
            ) {
                return 'Annual branch challenges destiny period';
            }
            
            return 'Stable energy changes';
        }

        // 获取大运与流年的建议（英文）
        function getDayunFlowYearAdviceEn(dayunElement, flowYearElement) {
            if (dayunElement === flowYearElement) {
                return 'Similar energy, mutually reinforcing';
            } else if (
                (dayunElement === '木' && flowYearElement === '火') ||
                (dayunElement === '火' && flowYearElement === '土') ||
                (dayunElement === '土' && flowYearElement === '金') ||
                (dayunElement === '金' && flowYearElement === '水') ||
                (dayunElement === '水' && flowYearElement === '木')
            ) {
                return 'Generating relationship, smooth energy flow';
            } else if (
                (dayunElement === '木' && flowYearElement === '金') ||
                (dayunElement === '火' && flowYearElement === '水') ||
                (dayunElement === '土' && flowYearElement === '木') ||
                (dayunElement === '金' && flowYearElement === '火') ||
                (dayunElement === '水' && flowYearElement === '土')
            ) {
                return 'Controlling relationship, need harmonization';
            } else if (
                (flowYearElement === '木' && dayunElement === '火') ||
                (flowYearElement === '火' && dayunElement === '土') ||
                (flowYearElement === '土' && dayunElement === '金') ||
                (flowYearElement === '金' && dayunElement === '水') ||
                (flowYearElement === '水' && dayunElement === '木')
            ) {
                return 'Annual branch supports destiny period';
            } else if (
                (flowYearElement === '木' && dayunElement === '金') ||
                (flowYearElement === '火' && dayunElement === '水') ||
                (flowYearElement === '土' && dayunElement === '木') ||
                (flowYearElement === '金' && dayunElement === '火') ||
                (flowYearElement === '水' && dayunElement === '土')
            ) {
                return 'Annual branch challenges destiny period';
            }
            
            return 'Stable energy changes';
        }
        
        
        // 确定季节函数
        function determineSeason(month) {
            // 月份干支
            const monthZhi = month.charAt(1);
            
            // 根据地支判断季节
            if (monthZhi === '寅' || monthZhi === '卯' || monthZhi === '辰') {
                return '春';
            } else if (monthZhi === '巳' || monthZhi === '午' || monthZhi === '未') {
                return '夏';
            } else if (monthZhi === '申' || monthZhi === '酉' || monthZhi === '戌') {
                return '秋';
            } else if (monthZhi === '亥' || monthZhi === '子' || monthZhi === '丑') {
                return '冬';
            }
            
            return '未知';
        }
        
        // 显示流年详情
        window.showFlowYearDetail = function(ganzhi, year) {
            try {
                // 从localStorage获取分析数据
                const analysisDataStr = localStorage.getItem('baziAnalysisData');
                if (!analysisDataStr) {
                    showError('未找到分析数据');
                    return;
                }
                
                const analysisData = JSON.parse(analysisDataStr);
                const userData = localStorage.getItem('baziUserData') ? JSON.parse(localStorage.getItem('baziUserData')) : null;
                
                // 获取日主天干
                const dayGan = analysisData.ganzhi.day.charAt(0);
                
                // 解析干支
                const gan = ganzhi.charAt(0);
                const zhi = ganzhi.charAt(1);
                
                // 五行属性对应表
                const wuxing = {
                    '甲': '木', '乙': '木',
                    '丙': '火', '丁': '火',
                    '戊': '土', '己': '土',
                    '庚': '金', '辛': '金',
                    '壬': '水', '癸': '水',
                    '子': '水', '丑': '土', '寅': '木', '卯': '木', 
                    '辰': '土', '巳': '火', '午': '火', '未': '土',
                    '申': '金', '酉': '金', '戌': '土', '亥': '水'
                };
                
                const wuxingEn = {
                    '木': 'Wood', '火': 'Fire', '土': 'Earth',
                    '金': 'Metal', '水': 'Water'
                };
                
                // 天干五行
                const ganWuxing = wuxing[gan];
                const ganWuxingEn = wuxingEn[ganWuxing];
                // 地支五行
                const zhiWuxing = wuxing[zhi];
                const zhiWuxingEn = wuxingEn[zhiWuxing];
                
                // 生肖
                const zodiacMap = {
                    '子': '鼠', '丑': '牛', '寅': '虎', '卯': '兔',
                    '辰': '龙', '巳': '蛇', '午': '马', '未': '羊',
                    '申': '猴', '酉': '鸡', '戌': '狗', '亥': '猪'
                };
                
                const zodiacMapEn = {
                    '鼠': 'Rat', '牛': 'Ox', '虎': 'Tiger', '兔': 'Rabbit',
                    '龙': 'Dragon', '蛇': 'Snake', '马': 'Horse', '羊': 'Goat',
                    '猴': 'Monkey', '鸡': 'Rooster', '狗': 'Dog', '猪': 'Pig'
                };
                const zodiac = zodiacMap[zhi];
                
                // 纳音
                const nayinMap = {
                    '甲子':'海中金', '乙丑':'海中金', 
                    '丙寅':'炉中火', '丁卯':'炉中火',
                    '戊辰':'大林木', '己巳':'大林木',
                    '庚午':'路旁土', '辛未':'路旁土',
                    '壬申':'剑锋金', '癸酉':'剑锋金',
                    '甲戌':'山头火', '乙亥':'山头火',
                    '丙子':'涧下水', '丁丑':'涧下水',
                    '戊寅':'城头土', '己卯':'城头土',
                    '庚辰':'白蜡金', '辛巳':'白蜡金',
                    '壬午':'杨柳木', '癸未':'杨柳木',
                    '甲申':'泉中水', '乙酉':'泉中水',
                    '丙戌':'屋上土', '丁亥':'屋上土',
                    '戊子':'霹雳火', '己丑':'霹雳火',
                    '庚寅':'松柏木', '辛卯':'松柏木',
                    '壬辰':'长流水', '癸巳':'长流水',
                    '甲午':'砂石金', '乙未':'砂石金',
                    '丙申':'山下火', '丁酉':'山下火',
                    '戊戌':'平地木', '己亥':'平地木',
                    '庚子':'壁上土', '辛丑':'壁上土',
                    '壬寅':'金薄金', '癸卯':'金薄金',
                    '甲辰':'覆灯火', '乙巳':'覆灯火',
                    '丙午':'天河水', '丁未':'天河水',
                    '戊申':'大驿土', '己酉':'大驿土',
                    '庚戌':'钗环金', '辛亥':'钗环金',
                    '壬子':'桑柘木', '癸丑':'桑柘木',
                    '甲寅':'大溪水', '乙卯':'大溪水',
                    '丙辰':'沙中土', '丁巳':'沙中土',
                    '戊午':'天上火', '己未':'天上火',
                    '庚申':'石榴木', '辛酉':'石榴木',
                    '壬戌':'大海水', '癸亥':'大海水'
                };
                const nayinMapEn = {
                    '海中金': 'Gold in Sea', '炉中火': 'Fire in Furnace',
                    '大林木': 'Wood in Forest', '路旁土': 'Earth by Road',
                    '剑锋金': 'Gold of Sword', '山头火': 'Fire on Mountain',
                    '涧下水': 'Water under Valley', '城头土': 'Earth on City Wall',
                    '白蜡金': 'White Wax Gold', '杨柳木': 'Willow Wood',
                    '泉中水': 'Water in Spring', '屋上土': 'Earth on House',
                    '霹雳火': 'Lightning Fire', '松柏木': 'Pine Wood',
                    '长流水': 'Flowing Water', '砂石金': 'Sand Gold',
                    '山下火': 'Fire under Mountain', '平地木': 'Wood on Ground',
                    '壁上土': 'Earth on Wall', '金薄金': 'Gold Foil',
                    '覆灯火': 'Candle Fire', '天河水': 'Heaven River Water',
                    '大驿土': 'Earth of Post Station', '钗环金': 'Hairpin Gold',
                    '桑柘木': 'Mulberry Wood', '大溪水': 'Big Stream Water',
                    '沙中土': 'Earth in Sand', '天上火': 'Fire in Sky',
                    '石榴木': 'Pomegranate Wood', '大海水': 'Ocean Water'
                };
                
                const nayin = nayinMap[ganzhi] || '未知';
                const nayinEn = nayinMapEn[nayin] || 'Unknown';
                
                const fuxingMapEn = {
                    '比肩': 'Peer', '劫财': 'Robbing Wealth',
                    '食神': 'Food God', '伤官': 'Hurting Officer',
                    '偏财': 'Partial Wealth', '正财': 'Proper Wealth',
                    '七杀': 'Seven Killing', '正官': 'Proper Officer',
                    '偏印': 'Partial Seal', '正印': 'Proper Seal',
                    '未知': 'Unknown'
                };
                
                // 计算与日主的关系
                const fuxingMap = {
                    '甲': {'甲':'比肩', '乙':'劫财', '丙':'食神', '丁':'伤官', '戊':'偏财', '己':'正财', '庚':'七杀', '辛':'正官', '壬':'偏印', '癸':'正印'},
                    '乙': {'甲':'劫财', '乙':'比肩', '丙':'伤官', '丁':'食神', '戊':'正财', '己':'偏财', '庚':'正官', '辛':'七杀', '壬':'正印', '癸':'偏印'},
                    '丙': {'甲':'偏印', '乙':'正印', '丙':'比肩', '丁':'劫财', '戊':'食神', '己':'伤官', '庚':'偏财', '辛':'正财', '壬':'七杀', '癸':'正官'},
                    '丁': {'甲':'正印', '乙':'偏印', '丙':'劫财', '丁':'比肩', '戊':'伤官', '己':'食神', '庚':'正财', '辛':'偏财', '壬':'正官', '癸':'七杀'},
                    '戊': {'甲':'七杀', '乙':'正官', '丙':'偏印', '丁':'正印', '戊':'比肩', '己':'劫财', '庚':'食神', '辛':'伤官', '壬':'偏财', '癸':'正财'},
                    '己': {'甲':'正官', '乙':'七杀', '丙':'正印', '丁':'偏印', '戊':'劫财', '己':'比肩', '庚':'伤官', '辛':'食神', '壬':'正财', '癸':'偏财'},
                    '庚': {'甲':'偏财', '乙':'正财', '丙':'七杀', '丁':'正官', '戊':'偏印', '己':'正印', '庚':'比肩', '辛':'劫财', '壬':'食神', '癸':'伤官'},
                    '辛': {'甲':'正财', '乙':'偏财', '丙':'正官', '丁':'七杀', '戊':'正印', '己':'偏印', '庚':'劫财', '辛':'比肩', '壬':'伤官', '癸':'食神'},
                    '壬': {'甲':'食神', '乙':'伤官', '丙':'偏财', '丁':'正财', '戊':'七杀', '己':'正官', '庚':'偏印', '辛':'正印', '壬':'比肩', '癸':'劫财'},
                    '癸': {'甲':'伤官', '乙':'食神', '丙':'正财', '丁':'偏财', '戊':'正官', '己':'七杀', '庚':'正印', '辛':'偏印', '壬':'劫财', '癸':'比肩'}
                };
                const fuxing = fuxingMap[dayGan] && fuxingMap[dayGan][gan] ? fuxingMap[dayGan][gan] : '未知';
                
                // 分析五行影响，基于日主五行和流年五行
                const dayGanWuxing = wuxing[dayGan];
                function getFlowYearAnalysis(dayGanWuxing, ganWuxing, fuxing) {
                    let analysis = [];
                    
                    // 分析五行关系
                    if (dayGanWuxing === ganWuxing) {
                        analysis.push('本年度与日主五行相同，表示能量相互支持');
                    } else {
                        const relationship = getWuxingRelationship(dayGanWuxing, ganWuxing);
                        switch(relationship) {
                            case '生':
                                analysis.push('本年度五行生助日主，整体运势较为顺遂');
                                break;
                            case '克':
                                analysis.push('本年度五行克制日主，需要谨慎行事');
                                break;
                            case '被生':
                                analysis.push('本年度得到日主生助，发展机会较多');
                                break;
                            case '被克':
                                analysis.push('本年度克制日主五行，易有阻力与挑战');
                                break;
                        }
                    }
                    
                    // 分析命格关系
                    switch(fuxing) {
                        case '比肩':
                            analysis.push('本年度与同类人合作共事机会多');
                            break;
                        case '劫财':
                            analysis.push('本年度竞争意识较强，适合独立发展');
                            break;
                        case '食神':
                            analysis.push('本年度学习进取、人际关系良好');
                            break;
                        case '伤官':
                            analysis.push('本年度创新能力强，适合开创新局');
                            break;
                        case '偏财':
                            analysis.push('本年度偏财运旺，投资机会较多');
                            break;
                        case '正财':
                            analysis.push('本年度正财运佳，事业发展稳定');
                            break;
                        case '七杀':
                            analysis.push('本年度竞争力强，但需注意人际关系');
                            break;
                        case '正官':
                            analysis.push('本年度官运亨通，易得领导赏识');
                            break;
                        case '偏印':
                            analysis.push('本年度学习能力提升，易有贵人相助');
                            break;
                        case '正印':
                            analysis.push('本年度文书运佳，适合考试进修');
                            break;
                    }
                    
                    return analysis;
                }

                function getFlowYearAnalysisEn(dayGanWuxing, ganWuxing, fuxing) {
                    let analysis = [];
                    
                    // Analyze Five Elements relationship
                    if (dayGanWuxing === ganWuxing) {
                        analysis.push('This year shares the same element as your Day Master, indicating mutual support of energy');
                    } else {
                        const relationship = getWuxingRelationship(dayGanWuxing, ganWuxing);
                        switch(relationship) {
                            case '生':
                                analysis.push('This year\'s element nurtures your Day Master, overall fortune is favorable');
                                break;
                            case '克':
                                analysis.push('This year\'s element controls your Day Master, caution is needed');
                                break;
                            case '被生':
                                analysis.push('This year you receive support from Day Master, many opportunities for development');
                                break;
                            case '被克':
                                analysis.push('This year controls Day Master element, may face resistance and challenges');
                                break;
                        }
                    }
                    
                    // Analyze relationship with Day Master
                    switch(fuxing) {
                        case '比肩':
                            analysis.push('Many opportunities for cooperation with peers this year');
                            break;
                        case '劫财':
                            analysis.push('Strong competitive consciousness, suitable for independent development');
                            break;
                        case '食神':
                            analysis.push('Good for learning and interpersonal relationships');
                            break;
                        case '伤官':
                            analysis.push('Strong innovation ability, suitable for new ventures');
                            break;
                        case '偏财':
                            analysis.push('Strong indirect wealth luck, many investment opportunities');
                            break;
                        case '正财':
                            analysis.push('Good direct wealth luck, stable career development');
                            break;
                        case '七杀':
                            analysis.push('Strong competitiveness, but need to pay attention to relationships');
                            break;
                        case '正官':
                            analysis.push('Official luck is prosperous, likely to gain recognition from leaders');
                            break;
                        case '偏印':
                            analysis.push('Enhanced learning ability, likely to receive help from noble people');
                            break;
                        case '正印':
                            analysis.push('Good for documentation and examinations');
                            break;
                    }
                    
                    return analysis;
                }

                function getWuxingRelationship(dayGanWuxing, ganWuxing) {
                    const wuxingOrder = ['木', '火', '土', '金', '水'];
                    const dayIndex = wuxingOrder.indexOf(dayGanWuxing);
                    const yearIndex = wuxingOrder.indexOf(ganWuxing);
                    
                    if (dayIndex === yearIndex) return '同';
                    
                    // 生关系：木生火，火生土，土生金，金生水，水生木
                    if ((dayIndex + 1) % 5 === yearIndex) return '生';
                    if (dayIndex === (yearIndex + 1) % 5) return '被生';
                    
                    // 克关系：木克土，土克水，水克火，火克金，金克木
                    if ((dayIndex + 2) % 5 === yearIndex) return '克';
                    if (dayIndex === (yearIndex + 2) % 5) return '被克';
                    
                    return '无';
                }

                const flowYearAnalysis = getFlowYearAnalysis(dayGanWuxing, ganWuxing, fuxing);
                const flowYearAnalysisEn = getFlowYearAnalysisEn(dayGanWuxing, ganWuxing, fuxing);
                
                // 分析月份信息
                function generateMonthAnalysis(gan, zhi, year) {
                    const analysis = [];
                    const zodiac = zodiacMap[zhi];
                    
                    // 分析月份特点
                    analysis.push(`本年度以${zodiac}为主要生肖特征，各月运势分析如下：`);
                    
                    // 春季（2-4月）
                    if (zodiac === '虎' || zodiac === '兔' || zodiac === '龙') {
                        analysis.push('春季（2-4月）运势较好，适合开展新项目');
                    } else {
                        analysis.push('春季（2-4月）需稳扎稳打，循序渐进');
                    }
                    
                    // 夏季（5-7月）
                    if (zodiac === '蛇' || zodiac === '马' || zodiac === '羊') {
                        analysis.push('夏季（5-7月）事业有起色，人际关系和谐');
                    } else {
                        analysis.push('夏季（5-7月）宜静不宜动，注意休养生息');
                    }
                    
                    // 秋季（8-10月）
                    if (zodiac === '猴' || zodiac === '鸡' || zodiac === '狗') {
                        analysis.push('秋季（8-10月）收获颇丰，适合总结经验');
                    } else {
                        analysis.push('秋季（8-10月）需谨慎行事，防范风险');
                    }
                    
                    // 冬季（11-1月）
                    if (zodiac === '猪' || zodiac === '鼠' || zodiac === '牛') {
                        analysis.push('冬季（11-1月）适合沉淀积累，为来年做准备');
                    } else {
                        analysis.push('冬季（11-1月）保持稳健，避免冒进');
                    }
                    
                    return analysis;
                }

                function generateMonthAnalysisEn(gan, zhi, year) {
                    const analysis = [];
                    const zodiac = zodiacMap[zhi];
                    const zodiacEn = zodiacMapEn[zodiac];
                    
                    // Analyze monthly characteristics
                    analysis.push(`This year is characterized by the zodiac ${zodiacEn}, monthly fortune analysis is as follows:`);
                    
                    // Spring (Feb-Apr)
                    if (zodiac === '虎' || zodiac === '兔' || zodiac === '龙') {
                        analysis.push('Spring (Feb-Apr): Good fortune, suitable for starting new projects');
                    } else {
                        analysis.push('Spring (Feb-Apr): Need to progress steadily and gradually');
                    }
                    
                    // Summer (May-Jul)
                    if (zodiac === '蛇' || zodiac === '马' || zodiac === '羊') {
                        analysis.push('Summer (May-Jul): Career improvement, harmonious relationships');
                    } else {
                        analysis.push('Summer (May-Jul): Better to stay calm, focus on self-cultivation');
                    }
                    
                    // Autumn (Aug-Oct)
                    if (zodiac === '猴' || zodiac === '鸡' || zodiac === '狗') {
                        analysis.push('Autumn (Aug-Oct): Fruitful harvest, good for summarizing experience');
                    } else {
                        analysis.push('Autumn (Aug-Oct): Need to be cautious, prevent risks');
                    }
                    
                    // Winter (Nov-Jan)
                    if (zodiac === '猪' || zodiac === '鼠' || zodiac === '牛') {
                        analysis.push('Winter (Nov-Jan): Suitable for accumulation, prepare for next year');
                    } else {
                        analysis.push('Winter (Nov-Jan): Stay steady, avoid rushing');
                    }
                    
                    return analysis;
                }

                const monthAnalysis = generateMonthAnalysis(gan, zhi, year);
                const monthAnalysisEn = generateMonthAnalysisEn(gan, zhi, year);
                
                // 吉凶事件预测
                const luckyEvents = getLuckyEvents(fuxing, ganWuxing);
                const luckyEventsEn = getLuckyEventsEn(fuxing, ganWuxing);
                // 获取吉凶事件预测函数
                function getLuckyEvents(fuxing, ganWuxing) {
                    const events = [];
                    switch(fuxing) {
                        case '比肩':
                            events.push('事业发展顺利', '人际关系和谐', '适合合作共事');
                            break;
                        case '劫财':
                            events.push('独立创业有利', '个人能力提升', '竞争中占优');
                            break;
                        case '食神':
                            events.push('学习进步显著', '考试成绩优异', '人缘好转');
                            break;
                        case '伤官':
                            events.push('创新思维活跃', '艺术创作顺利', '表现欲望强');
                            break;
                        case '偏财':
                            events.push('偏财运旺盛', '投资有收获', '意外之财');
                            break;
                        case '正财':
                            events.push('正财运亨通', '事业收入稳定', '生意兴隆');
                            break;
                        case '七杀':
                            events.push('竞争力增强', '决策力提升', '威信提高');
                            break;
                        case '正官':
                            events.push('官运亨通', '升职加薪', '得到赏识');
                            break;
                        case '偏印':
                            events.push('学习能力提升', '智慧增长', '贵人相助');
                            break;
                        case '正印':
                            events.push('文书顺利', '考试成功', '贵人扶持');
                            break;
                    }
                    return events;
                }

                function getLuckyEventsEn(fuxing, ganWuxing) {
                    const events = [];
                    switch(fuxing) {
                        case '比肩':
                            events.push('Career development goes smoothly', 'Harmonious interpersonal relationships', 'Suitable for cooperation');
                            break;
                        case '劫财':
                            events.push('Favorable for independent entrepreneurship', 'Personal ability improvement', 'Advantage in competition');
                            break;
                        case '食神':
                            events.push('Significant progress in learning', 'Excellent test results', 'Good relationships');
                            break;
                        case '伤官':
                            events.push('Active innovative thinking', 'Smooth artistic creation', 'Strong desire for expression');
                            break;
                        case '偏财':
                            events.push('Strong indirect wealth luck', 'Investment gains', 'Unexpected income');
                            break;
                        case '正财':
                            events.push('Direct wealth luck prosperous', 'Stable career income', 'Business prosperity');
                            break;
                        case '七杀':
                            events.push('Enhanced competitiveness', 'Improved decision-making', 'Increased prestige');
                            break;
                        case '正官':
                            events.push('Official luck prosperous', 'Promotion and salary increase', 'Recognition');
                            break;
                        case '偏印':
                            events.push('Enhanced learning ability', 'Wisdom growth', 'Noble person assistance');
                            break;
                        case '正印':
                            events.push('Smooth documentation', 'Success in examinations', 'Support from noble people');
                            break;
                    }
                    return events;
                }

                function getChallenges(fuxing, ganWuxing) {
                    const challenges = [];
                    switch(fuxing) {
                        case '比肩':
                            challenges.push('竞争压力大', '人际关系复杂', '需要调整心态');
                            break;
                        case '劫财':
                            challenges.push('财务压力增加', '合作关系紧张', '需要控制支出');
                            break;
                        case '食神':
                            challenges.push('情绪波动大', '需要专注学习', '避免过度消费');
                            break;
                        case '伤官':
                            challenges.push('容易冲动', '需要稳定情绪', '避免过度表现');
                            break;
                        case '偏财':
                            challenges.push('投资需谨慎', '财务风险增加', '需要理性决策');
                            break;
                        case '正财':
                            challenges.push('工作压力大', '需要平衡生活', '避免过度劳累');
                            break;
                        case '七杀':
                            challenges.push('人际关系紧张', '需要控制脾气', '避免冲突');
                            break;
                        case '正官':
                            challenges.push('压力较大', '需要谨言慎行', '避免得罪人');
                            break;
                        case '偏印':
                            challenges.push('学习压力大', '需要专注', '避免分心');
                            break;
                        case '正印':
                            challenges.push('竞争激烈', '需要加倍努力', '避免懈怠');
                            break;
                    }
                    return challenges;
                }

                function getChallengesEn(fuxing, ganWuxing) {
                    const challenges = [];
                    switch(fuxing) {
                        case '比肩':
                            challenges.push('High competitive pressure', 'Complex interpersonal relationships', 'Need to adjust mentality');
                            break;
                        case '劫财':
                            challenges.push('Increased financial pressure', 'Tense partnerships', 'Need to control expenses');
                            break;
                        case '食神':
                            challenges.push('Emotional fluctuations', 'Need to focus on learning', 'Avoid overspending');
                            break;
                        case '伤官':
                            challenges.push('Prone to impulsiveness', 'Need to stabilize emotions', 'Avoid over-expression');
                            break;
                        case '偏财':
                            challenges.push('Investment needs caution', 'Increased financial risks', 'Need rational decision-making');
                            break;
                        case '正财':
                            challenges.push('High work pressure', 'Need to balance life', 'Avoid overwork');
                            break;
                        case '七杀':
                            challenges.push('Tense interpersonal relationships', 'Need to control temper', 'Avoid conflicts');
                            break;
                        case '正官':
                            challenges.push('High pressure', 'Need to be cautious in words and actions', 'Avoid offending others');
                            break;
                        case '偏印':
                            challenges.push('High learning pressure', 'Need to focus', 'Avoid distractions');
                            break;
                        case '正印':
                            challenges.push('Intense competition', 'Need to work harder', 'Avoid laziness');
                            break;
                    }
                    return challenges;
                }

                const challenges = getChallenges(fuxing, ganWuxing);
                const challengesEn = getChallengesEn(fuxing, ganWuxing);
                
                // 创建流年详情内容
                // 获取当前语言
                const isCurrentlyEnglish = document.querySelector('[data-lang="en"]').style.display !== 'none';
                const currentLang = isCurrentlyEnglish ? 'en' : 'zh';
                
                let detailsHtml = `
                    <div class="flowyear-modal-inner">
                        <div class="flowyear-header">
                            ${currentLang === 'zh' ? 
                              `<div>${year}年 ${ganzhi}年 流年详情</div>` : 
                              `<div>${year} ${ganzhi} Annual Destiny Details</div>`
                            }
                            <span class="close-button" onclick="closeFlowYearModal()">×</span>
                        </div>
                        
                        <div class="flowyear-content">
                            <div class="flowyear-basic-info">
                                <div class="info-section">
                                    <h3>${currentLang === 'zh' ? '基本信息' : 'Basic Information'}</h3>
                    <div class="flowyear-info-grid">
                        <div class="detail-item">
                                            <label>${currentLang === 'zh' ? '年龄' : 'Age'}</label>
                                            ${currentLang === 'zh' ? 
                                              `<span>${userData ? (year - parseInt(userData.birthYear)) : '未知'}岁</span>` : 
                                              `<span>${userData ? (year - parseInt(userData.birthYear)) : 'Unknown'} years old</span>`
                                            }
                        </div>
                        <div class="detail-item">
                                            <label>${currentLang === 'zh' ? '生肖' : 'Zodiac'}</label>
                                            ${currentLang === 'zh' ? 
                                              `<span>${zodiac}年</span>` : 
                                              `<span>Year of the ${zodiacMapEn[zodiac]}</span>`
                                            }
                        </div>
                                    </div>
                                </div>
                                
                                <div class="info-section">
                                    <h3>${currentLang === 'zh' ? '五行信息' : 'Five Elements Information'}</h3>
                                    <div class="flowyear-info-grid">
                        <div class="detail-item">
                                            <label>${currentLang === 'zh' ? '天干' : 'Heavenly Stem'}</label>
                                            ${currentLang === 'zh' ? 
                                              `<span>${gan} (五行: ${ganWuxing})</span>` : 
                                              `<span>${gan} (Element: ${wuxingEn[ganWuxing]})</span>`
                                            }
                        </div>
                        <div class="detail-item">
                                            <label>${currentLang === 'zh' ? '地支' : 'Earthly Branch'}</label>
                                            ${currentLang === 'zh' ? 
                                              `<span>${zhi} (五行: ${zhiWuxing})</span>` : 
                                              `<span>${zhi} (Element: ${wuxingEn[zhiWuxing]})</span>`
                                            }
                        </div>
                        <div class="detail-item">
                                            <label>${currentLang === 'zh' ? '纳音' : 'Hidden Stem'}</label>
                                            ${currentLang === 'zh' ? 
                                              `<span>${nayin}</span>` : 
                                              `<span>${nayinMapEn[nayin]}</span>`
                                            }
                        </div>
                        <div class="detail-item">
                                            <label>${currentLang === 'zh' ? '副星' : 'Secondary Star'}</label>
                                            ${currentLang === 'zh' ? 
                                              `<span>${fuxing}</span>` : 
                                              `<span>${fuxingMapEn[fuxing]}</span>`
                                            }
                                        </div>
                                    </div>
                        </div>
                    </div>
                    
                    <div class="flowyear-section">
                                <h3>${currentLang === 'zh' ? '流年分析' : 'Annual Analysis'}</h3>
                                <p class="analysis-text">${currentLang === 'zh' ? flowYearAnalysis : flowYearAnalysisEn}</p>
                        
                                <div class="events-container">
                        <div class="flowyear-lucky-events">
                                        <h4>${currentLang === 'zh' ? '有利事件' : 'Favorable Events'}</h4>
                                        <ul class="events-list">
                                            ${currentLang === 'zh' ? 
                                              luckyEvents.map(event => `<li>${event}</li>`).join('') : 
                                              luckyEventsEn.map(event => `<li>${event}</li>`).join('')
                                            }
                            </ul>
                        </div>
                        
                        <div class="flowyear-challenges">
                                        <h4>${currentLang === 'zh' ? '可能挑战' : 'Potential Challenges'}</h4>
                                        <ul class="events-list">
                                            ${currentLang === 'zh' ? 
                                              challenges.map(challenge => `<li>${challenge}</li>`).join('') : 
                                              challengesEn.map(challenge => `<li>${challenge}</li>`).join('')
                                            }
                            </ul>
                                    </div>
                        </div>
                    </div>
                    
                    <div class="flowyear-section">
                                <h3>${currentLang === 'zh' ? '流月预测' : 'Monthly Prediction'}</h3>
                        <div class="flowyear-month-grid">
                                    ${currentLang === 'zh' ? 
                                      monthAnalysis.map(item => `<p>${item}</p>`).join('') : 
                                      monthAnalysisEn.map(item => `<p>${item}</p>`).join('')
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 显示模态框
                document.getElementById('flowyear-details').innerHTML = detailsHtml;
                
                const modal = document.getElementById('flowyear-modal');
                modal.style.display = 'flex';
                
                // 添加ESC键关闭
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape') {
                        closeFlowYearModal();
                    }
                });
                
                // 添加点击外部关闭
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        closeFlowYearModal();
                    }
                });
                
            } catch (error) {
                console.error('显示流年详情出错:', error);
                showError(`显示流年详情时出错: ${error.message}`);
            }
        };
        
        // 关闭流年详情模态框
        window.closeFlowYearModal = function() {
            document.getElementById('flowyear-modal').style.display = 'none';
            document.removeEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeFlowYearModal();
                }
            });
        };
        
        // 获取流年分析
        function getFlowYearAnalysis(dayGanWuxing, flowYearWuxing, fuxing) {
            // 五行相生相克关系
            const generates = {
                '木': '火',
                '火': '土',
                '土': '金',
                '金': '水',
                '水': '木'
            };
            
            const restricts = {
                '木': '土',
                '土': '水',
                '水': '火',
                '火': '金',
                '金': '木'
            };
            
            // 确定五行关系
            let relationship = '';
            
            if (dayGanWuxing === flowYearWuxing) {
                relationship = '同';
            } else if (generates[dayGanWuxing] === flowYearWuxing) {
                relationship = '生';
            } else if (generates[flowYearWuxing] === dayGanWuxing) {
                relationship = '泄';
            } else if (restricts[dayGanWuxing] === flowYearWuxing) {
                relationship = '克';
            } else if (restricts[flowYearWuxing] === dayGanWuxing) {
                relationship = '被克';
            }
            
            // 基于五行关系和十神提供分析
            switch (relationship) {
                case '同':
                    return `这一年五行与日主同类，表示能量相似，有助于强化自身特质。${fuxing}为${getStarDescription(fuxing)}，意味着这一年自身能量会得到加强，有利于发展个人特长，但也需要注意个性可能过于强烈。`;
                case '生':
                    return `这一年日主五行生助流年五行，表示能量外流。${fuxing}为${getStarDescription(fuxing)}，意味着这一年可能需要付出更多，适合培养人际关系和投资未来，但也需要避免过度消耗。`;
                case '泄':
                    return `这一年流年五行生助日主，表示能量得到补充。${fuxing}为${getStarDescription(fuxing)}，意味着这一年可能会获得支持和助力，适合接受新机会和发展新项目。`;
                case '克':
                    return `这一年日主五行克制流年五行，表示具有主动权。${fuxing}为${getStarDescription(fuxing)}，意味着这一年将有较强的控制力，适合做决策和领导工作，但需要避免过于强势。`;
                case '被克':
                    return `这一年流年五行克制日主，表示可能面临挑战。${fuxing}为${getStarDescription(fuxing)}，意味着这一年可能需要应对外部压力，建议保持谨慎，提前做好准备，寻求合作而非对抗。`;
                default:
                    return `这一年流年干支为${fuxing}，五行为${flowYearWuxing}，将对您的运势产生多方面影响。建议结合个人具体情况，灵活应对各种变化。`;
            }
        }
        
        // 获取流年吉事
        function getLuckyEvents(fuxing, wuxing) {
            const baseEvents = [
                '身体健康状况改善',
                '遇到贵人相助',
                '有机会拓展人际圈',
                '适合学习新技能',
                '工作或学业可能有突破'
            ];
            
            // 根据副星(十神)添加具体事件
            const specialEvents = {
                '正官': ['升职或得到认可', '获得奖项或荣誉', '法律事务有利进展'],
                '偏官': ['获得权威支持', '竞争中取胜', '改革创新成功'],
                '正印': ['学习进步明显', '考试成绩优秀', '提升专业技能'],
                '偏印': ['获得知识启发', '灵感和创意增多', '精神层面有所提升'],
                '正财': ['收入稳定增长', '投资回报理想', '获得稳定财源'],
                '偏财': ['意外收获', '偶然机会带来收益', '副业发展良好'],
                '食神': ['生活品质提升', '艺术才能展现', '人缘和口碑良好'],
                '伤官': ['创新能力增强', '表达和沟通更流畅', '公关活动成功'],
                '比肩': ['团队合作顺利', '志同道合者增多', '个人能力得到认可'],
                '劫财': ['摆脱困境', '改变现状的机会', '获得自由发展空间']
            };
            
            // 根据五行添加事件
            const wuxingEvents = {
                '木': ['计划顺利实施', '创业或新项目启动', '自我成长明显'],
                '火': ['人际关系活跃', '社交活动增多', '表现机会增加'],
                '土': ['稳定性增强', '房产相关事务有利', '基础建设成功'],
                '金': ['财务状况改善', '精确决策带来好结果', '收获成果'],
                '水': ['学习机会增多', '思维更加灵活', '沟通和谈判顺利']
            };
            
            // 合并事件
            let events = [...baseEvents];
            
            if (specialEvents[fuxing]) {
                events = events.concat(specialEvents[fuxing]);
            }
            
            if (wuxingEvents[wuxing]) {
                events = events.concat(wuxingEvents[wuxing]);
            }
            
            // 随机选择5-7个事件
            const count = Math.floor(Math.random() * 3) + 5;
            const shuffled = events.sort(() => 0.5 - Math.random());
            
            return shuffled.slice(0, Math.min(count, events.length));
        }
        
        // 获取流年吉事（英文版）
        function getLuckyEventsEn(fuxing, wuxing) {
            const baseEvents = [
                'Improvement in physical health',
                'Meeting helpful people',
                'Opportunities to expand social network',
                'Good timing to learn new skills',
                'Potential breakthroughs in work or study'
            ];
            
            // Special events based on auxiliary stars
            const specialEvents = {
                '正官': ['Promotion or recognition', 'Awards or honors', 'Favorable legal matters'],
                '偏官': ['Support from authorities', 'Success in competition', 'Successful innovation'],
                '正印': ['Notable progress in learning', 'Excellence in examinations', 'Professional skill enhancement'],
                '偏印': ['Knowledge enlightenment', 'Increased inspiration and creativity', 'Spiritual growth'],
                '正财': ['Stable income growth', 'Good investment returns', 'Stable financial sources'],
                '偏财': ['Unexpected gains', 'Opportunities for additional income', 'Good development in side business'],
                '食神': ['Improved quality of life', 'Artistic talent display', 'Good reputation and relationships'],
                '伤官': ['Enhanced innovation ability', 'Smooth communication', 'Successful public relations'],
                '比肩': ['Smooth teamwork', 'Meeting like-minded people', 'Recognition of personal abilities'],
                '劫财': ['Overcoming difficulties', 'Opportunities for change', 'Gaining space for free development']
            };
            
            // Events based on five elements
            const wuxingEvents = {
                '木': ['Smooth implementation of plans', 'Successful startup or new projects', 'Notable personal growth'],
                '火': ['Active interpersonal relationships', 'Increased social activities', 'More opportunities for performance'],
                '土': ['Enhanced stability', 'Favorable real estate matters', 'Successful foundation building'],
                '金': ['Improved financial situation', 'Good results from precise decisions', 'Harvesting achievements'],
                '水': ['Increased learning opportunities', 'More flexible thinking', 'Smooth communication and negotiation']
            };
            
            let events = [...baseEvents];
            
            if (specialEvents[fuxing]) {
                events = events.concat(specialEvents[fuxing]);
            }
            
            if (wuxingEvents[wuxing]) {
                events = events.concat(wuxingEvents[wuxing]);
            }
            
            const count = Math.floor(Math.random() * 3) + 5;
            const shuffled = events.sort(() => 0.5 - Math.random());
            
            return shuffled.slice(0, Math.min(count, events.length));
        }
        
        // 获取流年挑战
        function getChallenges(fuxing, wuxing) {
            const baseChallenges = [
                '工作压力可能增大',
                '需要更加注意健康',
                '人际关系需要处理',
                '可能面临决策困难',
                '需要平衡各方面的时间分配'
            ];
            
            // 根据副星(十神)添加具体挑战
            const specialChallenges = {
                '正官': ['来自权威的压力', '规则约束增多', '责任增加'],
                '偏官': ['可能遇到强势对手', '规则变动带来困扰', '权力斗争'],
                '正印': ['学习压力增大', '知识更新需求', '理论与实践脱节'],
                '偏印': ['思想混乱或犹豫', '过度理想化', '现实与理想冲突'],
                '正财': ['财务管理压力', '固定开支增加', '投资需谨慎'],
                '偏财': ['财务波动', '投机风险', '意外支出'],
                '食神': ['享乐倾向影响正事', '创作瓶颈', '注意力分散'],
                '伤官': ['言行需谨慎', '创新阻力', '反对意见增多'],
                '比肩': ['竞争加剧', '团队协作困难', '责任分担不均'],
                '劫财': ['资源竞争', '意见分歧', '变动带来不安']
            };
            
            // 根据五行添加挑战
            const wuxingChallenges = {
                '木': ['急躁情绪增加', '计划执行受阻', '灵活性不足'],
                '火': ['情绪波动较大', '过度兴奋', '注意力不集中'],
                '土': ['行动迟缓', '保守倾向阻碍发展', '墨守成规'],
                '金': ['过于严格', '人际关系疏远', '情感表达受限'],
                '水': ['优柔寡断', '过度分析', '缺乏执行力']
            };
            
            // 合并挑战
            let challenges = [...baseChallenges];
            
            if (specialChallenges[fuxing]) {
                challenges = challenges.concat(specialChallenges[fuxing]);
            }
            
            if (wuxingChallenges[wuxing]) {
                challenges = challenges.concat(wuxingChallenges[wuxing]);
            }
            
            // 随机选择4-6个挑战
            const count = Math.floor(Math.random() * 3) + 4;
            const shuffled = challenges.sort(() => 0.5 - Math.random());
            
            return shuffled.slice(0, Math.min(count, challenges.length));
        }
        
        // 生成流月分析
        function generateMonthAnalysis(yearGan, yearZhi, year) {
            const monthNames = ['正月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
            
            // 计算月干支 (简化算法，实际应使用更复杂的农历计算)
            const baseStem = {'甲':'丙', '乙':'戊', '丙':'庚', '丁':'壬', '戊':'甲', '己':'丙', '庚':'戊', '辛':'庚', '壬':'壬', '癸':'甲'}[yearGan] || '甲';
            const stems = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
            const branches = ['寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥', '子', '丑'];
            
            const baseIndex = stems.indexOf(baseStem);
            let html = '';
            
            for (let i = 0; i < 12; i++) {
                const stemIndex = (baseIndex + i) % 10;
                const stem = stems[stemIndex];
                const branch = branches[i];
                
                // 简化的月份特性分析
                let monthTip = '';
                if (i >= 2 && i <= 4) { // 春季
                    monthTip = '春季活力';
                } else if (i >= 5 && i <= 7) { // 夏季
                    monthTip = '夏季繁荣';
                } else if (i >= 8 && i <= 10) { // 秋季
                    monthTip = '秋季收获';
                } else { // 冬季
                    monthTip = '冬季蓄藏';
                }
                
                html += `
                    <div class="flowyear-month-item">
                        <span class="month-name">${monthNames[i]}</span>
                        <span>${stem}${branch}</span>
                        <span>${monthTip}</span>
                    </div>
                `;
            }
            
            return html;
        }
        
        // 获取副星(十神)描述
        function getStarDescription(star) {
            const descriptions = {
                '比肩': '代表平等、竞争、合作，与同类相处，志同道合',
                '劫财': '代表竞争、分夺、冲突，同类相争，性格刚强',
                '食神': '代表才华、创造、享受，生活品质，知识传授',
                '伤官': '代表创新、批判、变革，反传统，特立独行',
                '偏财': '代表意外收获、冒险、投机，非常规收入',
                '正财': '代表正常收入、储蓄、积累，理财能力',
                '七杀': '代表权威、竞争、挑战，勇气和决断力',
                '正官': '代表规则、权威、秩序，名誉地位，责任感',
                '偏印': '代表智慧、学习、非传统知识，创意和灵感',
                '正印': '代表学习、传统知识、信息，文化修养'
            };
            
            return descriptions[star] || star;
        }
        
        // 确定季节函数
        function determineSeason(month) {
            // ... existing code ...
        }

        // 获取纳音五行函数
        // Generate English version of month analysis
        function generateMonthAnalysisEn(yearGan, yearZhi, year) {
            const monthNames = ['First', 'Second', 'Third', 'Fourth', 'Fifth', 'Sixth', 'Seventh', 'Eighth', 'Ninth', 'Tenth', 'Eleventh', 'Twelfth'];
            
            // Calculate month's heavenly stems (simplified algorithm)
            const baseStem = {'甲':'丙', '乙':'戊', '丙':'庚', '丁':'壬', '戊':'甲', '己':'丙', '庚':'戊', '辛':'庚', '壬':'壬', '癸':'甲'}[yearGan] || '甲';
            const stems = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
            const branches = ['寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥', '子', '丑'];
            
            const baseIndex = stems.indexOf(baseStem);
            let html = '';
            
            for (let i = 0; i < 12; i++) {
                const stemIndex = (baseIndex + i) % 10;
                const stem = stems[stemIndex];
                const branch = branches[i];
                
                // Simplified month characteristics analysis
                let monthTip = '';
                if (i >= 2 && i <= 4) { // Spring
                    monthTip = 'Spring Vitality';
                } else if (i >= 5 && i <= 7) { // Summer
                    monthTip = 'Summer Prosperity';
                } else if (i >= 8 && i <= 10) { // Autumn
                    monthTip = 'Autumn Harvest';
                } else { // Winter
                    monthTip = 'Winter Storage';
                }
                
                html += `
                    <div class="flowyear-month-item">
                        <span class="month-name">${monthNames[i]} Month</span>
                        <span>${stem}${branch}</span>
                        <span>${monthTip}</span>
                    </div>
                `;
            }
            
            return html;
        }

        function getNayin(ganzhi) {
            const nayinMap = {
                '甲子':'海中金', '乙丑':'海中金', 
                '丙寅':'炉中火', '丁卯':'炉中火',
                '戊辰':'大林木', '己巳':'大林木',
                '庚午':'路旁土', '辛未':'路旁土',
                '壬申':'剑锋金', '癸酉':'剑锋金',
                '甲戌':'山头火', '乙亥':'山头火',
                '丙子':'涧下水', '丁丑':'涧下水',
                '戊寅':'城头土', '己卯':'城头土',
                '庚辰':'白蜡金', '辛巳':'白蜡金',
                '壬午':'杨柳木', '癸未':'杨柳木',
                '甲申':'泉中水', '乙酉':'泉中水',
                '丙戌':'屋上土', '丁亥':'屋上土',
                '戊子':'霹雳火', '己丑':'霹雳火',
                '庚寅':'松柏木', '辛卯':'松柏木',
                '壬辰':'长流水', '癸巳':'长流水',
                '甲午':'砂石金', '乙未':'砂石金',
                '丙申':'山下火', '丁酉':'山下火',
                '戊戌':'平地木', '己亥':'平地木',
                '庚子':'壁上土', '辛丑':'壁上土',
                '壬寅':'金薄金', '癸卯':'金薄金',
                '甲辰':'覆灯火', '乙巳':'覆灯火',
                '丙午':'天河水', '丁未':'天河水',
                '戊申':'大驿土', '己酉':'大驿土',
                '庚戌':'钗环金', '辛亥':'钗环金',
                '壬子':'桑柘木', '癸丑':'桑柘木',
                '甲寅':'大溪水', '乙卯':'大溪水',
                '丙辰':'沙中土', '丁巳':'沙中土',
                '戊午':'天上火', '己未':'天上火',
                '庚申':'石榴木', '辛酉':'石榴木',
                '壬戌':'大海水', '癸亥':'大海水'
            };
            
            return nayinMap[ganzhi] || '';
        }

        // 加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // 获取URL参数
                const urlParams = new URLSearchParams(window.location.search);
                const analysisId = urlParams.get('id');
                
                let analysisData, userData;
                
                // 尝试通过ID获取数据
                if (analysisId) {
                    const analysisKey = `bazi_analysis_${analysisId}`;
                    const userDataKey = `user_data_${analysisId}`;
                    
                    const savedAnalysis = localStorage.getItem(analysisKey);
                    const savedUserData = localStorage.getItem(userDataKey);
                    
                    if (savedAnalysis && savedUserData) {
                    analysisData = JSON.parse(savedAnalysis);
                    userData = JSON.parse(savedUserData);
                        console.log('通过ID加载数据成功');
                    }
                }
                
                // 如果通过ID没有找到数据，尝试使用通用键
                if (!analysisData || !userData) {
                    const savedAnalysis = localStorage.getItem('baziAnalysisData');
                    const savedUserData = localStorage.getItem('baziUserData');
                    
                    if (savedAnalysis && savedUserData) {
                    analysisData = JSON.parse(savedAnalysis);
                    userData = JSON.parse(savedUserData);
                        console.log('通过通用键加载数据成功');
                    }
                }
                
                // 如果仍未找到数据，显示错误
                if (!analysisData || !userData) {
                    console.error('无法加载分析数据');
                    return;
                }
                
                console.log('===== 数据调试信息 =====');
                console.log('用户数据:', userData);
                console.log('用户国家:', userData.country);
                console.log('用户省份:', userData.province);
                
                // 确保出生地信息正确显示
                if (userData.country && userData.province) {
                    const birthPlace = userData.country + ' ' + userData.province;
                    const birthPlaceElement = document.getElementById('birth-place');
                    if (birthPlaceElement) {
                        birthPlaceElement.textContent = birthPlace;
                        console.log('已更新出生地信息:', birthPlace);
                    } else {
                        console.error('找不到birth-place元素');
                    }
                } else {
                    console.warn('国家或省份信息不完整', userData.country, userData.province);
                }
                
                console.log('数据加载检查完成');
            } catch (error) {
                console.error('数据加载检查错误:', error);
            }
        });

        // ... existing code ...
        // 显示五行分析
        function showWuxingAnalysis(analysisData) {
            try {
                if (!analysisData || !analysisData.wuxing) {
                    console.error('五行数据不完整');
                    return;
                }
                
                // 获取用户数据（从localStorage）
                let userData = null;
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const analysisId = urlParams.get('id');
                    if (analysisId) {
                        const userDataKey = `user_data_${analysisId}`;
                        const savedUserData = localStorage.getItem(userDataKey);
                        if (savedUserData) {
                            userData = JSON.parse(savedUserData);
                        }
                    }
                    
                    // 如果通过ID没有找到，尝试读取常规存储的用户数据
                    if (!userData) {
                        const savedUserData = localStorage.getItem('baziUserData');
                        if (savedUserData) {
                            userData = JSON.parse(savedUserData);
                        }
                    }
                } catch (e) {
                    console.error('获取用户数据失败:', e);
                }
                
                // 五行元素ID映射
                const wuxingIds = {
                    '木': { value: 'wuxing-mu', progress: 'mu-progress' },
                    '火': { value: 'wuxing-huo', progress: 'huo-progress' },
                    '土': { value: 'wuxing-tu', progress: 'tu-progress' },
                    '金': { value: 'wuxing-jin', progress: 'jin-progress' },
                    '水': { value: 'wuxing-shui', progress: 'shui-progress' }
                };
                
                // 填充五行分布
                for (const element in wuxingIds) {
                    const percentage = analysisData.wuxing[element] || 0;
                    const valueElement = document.getElementById(wuxingIds[element].value);
                    const progressElement = document.getElementById(wuxingIds[element].progress);
                    
                    if (valueElement) {
                        valueElement.textContent = percentage + '%';
                    }
                    
                    if (progressElement) {
                        progressElement.style.width = percentage + '%';
                    }
                }
                
                // 确定最强和最弱的五行
                let entries = Object.entries(analysisData.wuxing).sort((a, b) => b[1] - a[1]);
                const strongestElement = entries[0][0];
                const weakestElement = entries[entries.length - 1][0];
                
                const strongElement = document.getElementById('strong-element');
                const weakElement = document.getElementById('weak-element');
                
                if (strongElement) {
                    strongElement.textContent = strongestElement;
                }
                
                if (weakElement) {
                    weakElement.textContent = weakestElement;
                }
                
                // 获取日主并设置
                const dayGan = analysisData.ganzhi?.day?.charAt(0);
                const dayMasterElement = document.getElementById('day-master');
                if (dayGan && dayMasterElement) {
                    dayMasterElement.textContent = dayGan;
                }
                
                // 生成个性化五行建议
                const adviceContainer = document.getElementById('personalized-advice');
                if (adviceContainer && dayGan) {
                    const ganWuxing = {
                        '甲': '木', '乙': '木',
                        '丙': '火', '丁': '火',
                        '戊': '土', '己': '土',
                        '庚': '金', '辛': '金',
                        '壬': '水', '癸': '水'
                    };
                    
                    const dayWuxing = ganWuxing[dayGan];
                    
                    // 简单五行关系
                    const relationships = {
                        '木': { '生': '火', '被生': '水', '克': '土', '被克': '金' },
                        '火': { '生': '土', '被生': '木', '克': '金', '被克': '水' },
                        '土': { '生': '金', '被生': '火', '克': '水', '被克': '木' },
                        '金': { '生': '水', '被生': '土', '克': '木', '被克': '火' },
                        '水': { '生': '木', '被生': '金', '克': '火', '被克': '土' }
                    };
                    
                    // 获取当前语言
                    const isEnglish = document.querySelector('[data-lang="en"]').style.display !== 'none';
                    
                    // 五行英文名称
                    const wuxingEnglishNames = {
                        '木': 'Wood',
                        '火': 'Fire',
                        '土': 'Earth',
                        '金': 'Metal',
                        '水': 'Water'
                    };
                    
                    let adviceHtml = '<ul>';
                    
                    // 根据日主五行和整体五行分布提供建议
                    const dayElementPercentage = analysisData.wuxing[dayWuxing] || 0;
                    
                    // 确定出生季节（简化方式）
                    let birthSeason = '春';  // 默认春季
                    try {
                        if (userData && userData.birthDate) {
                            const birthMonth = parseInt(userData.birthDate.split('-')[1]);
                            if (birthMonth >= 3 && birthMonth <= 5) {
                                birthSeason = '春';
                            } else if (birthMonth >= 6 && birthMonth <= 8) {
                                birthSeason = '夏';
                            } else if (birthMonth >= 9 && birthMonth <= 11) {
                                birthSeason = '秋';
                            } else {
                                birthSeason = '冬';
                            }
                        }
                        
                        // 设置出生季节
                        const birthSeasonElement = document.getElementById('birth-season');
                        if (birthSeasonElement) {
                            birthSeasonElement.textContent = birthSeason;
                        }
                    } catch (e) {
                        console.error('确定出生季节出错:', e);
                    }
                    
                    if (dayElementPercentage > 30) {
                        // 日主偏强
                        adviceHtml += `<p data-lang="en" style="display: none;"><strong>Day Master Status: </strong><span class="shensha-good">Strong</span>, your Day Master element (${wuxingEnglishNames[dayWuxing]}) is relatively strong in your BaZi chart.</p>`;
                        adviceHtml += `<p data-lang="zh"><strong>日主状态：</strong><span class="shensha-good">偏强</span>，您的日主五行(${dayWuxing})在八字中力量较强。</p>`;
                        adviceHtml += `<li data-lang="en" style="display: none;">You can appropriately supplement with elements that control your Day Master (${wuxingEnglishNames[dayWuxing]}): <span class="shensha-good">${wuxingEnglishNames[relationships[dayWuxing].被克]}</span>, which helps balance energy.</li>`;
                        adviceHtml += `<li data-lang="zh">可以适当补充克制日主(${dayWuxing})的五行：<span class="shensha-good">${relationships[dayWuxing].被克}</span>，有助于平衡能量。</li>`;
                        adviceHtml += `<li data-lang="en" style="display: none;">Avoid excessive use of elements that are the same as your Day Master (${wuxingEnglishNames[dayWuxing]}) or elements that generate your Day Master (${wuxingEnglishNames[relationships[dayWuxing].被生]}).</li>`;
                        adviceHtml += `<li data-lang="zh">避免过多使用与日主相同(${dayWuxing})的五行或生日主的五行(${relationships[dayWuxing].被生})。</li>`;
                    } else if (dayElementPercentage < 15) {
                        // 日主偏弱
                        adviceHtml += `<p data-lang="en" style="display: none;"><strong>Day Master Status: </strong><span class="shensha-bad">Weak</span>, your Day Master element (${wuxingEnglishNames[dayWuxing]}) is relatively weak in your BaZi chart.</p>`;
                        adviceHtml += `<p data-lang="zh"><strong>日主状态：</strong><span class="shensha-bad">偏弱</span>，您的日主五行(${dayWuxing})在八字中力量较弱。</p>`;
                        adviceHtml += `<li data-lang="en" style="display: none;">You can appropriately supplement with elements that are the same as your Day Master (${wuxingEnglishNames[dayWuxing]}) or elements that generate your Day Master: <span class="shensha-good">${wuxingEnglishNames[relationships[dayWuxing].被生]}</span>, which helps strengthen energy.</li>`;
                        adviceHtml += `<li data-lang="zh">可以适当补充与日主相同(${dayWuxing})的五行或生日主的五行：<span class="shensha-good">${relationships[dayWuxing].被生}</span>，有助于增强能量。</li>`;
                    }
                    
                    adviceHtml += `</ul>`;
                    adviceContainer.innerHTML = adviceHtml;
                }
            } catch (error) {
                console.error('生成个性化建议出错:', error);
                showError('生成个性化建议时出错: ' + error.message);
            }
        }

        // 语言切换功能
        function setupLanguageToggle() {
            try {
                console.log('初始化语言切换功能...');
                const languageBtn = document.getElementById('languageToggle');
                if (!languageBtn) {
                    console.error('找不到语言切换按钮');
                    return;
                }

                // 初始化界面翻译
                Object.keys(uiTranslations).forEach(key => {
                    const elements = document.querySelectorAll(`[data-translate="${key}"]`);
                    elements.forEach(element => {
                        element.textContent = uiTranslations[key]['zh'];
                    });
                });

                // 初始化性别翻译映射
                const genderTranslations = {
                    '男': 'Male',
                    '女': 'Female'
                };
                
                // 中英文生肖对照表
                const zodiacMap = {
                    '鼠': 'Rat',
                    '牛': 'Ox',
                    '虎': 'Tiger',
                    '兔': 'Rabbit',
                    '龙': 'Dragon',
                    '蛇': 'Snake',
                    '马': 'Horse',
                    '羊': 'Goat',
                    '猴': 'Monkey',
                    '鸡': 'Rooster',
                    '狗': 'Dog',
                    '猪': 'Pig'
                };
                
                // 默认为中文模式
                let isEnglish = false;
                
                languageBtn.addEventListener('click', function() {
                    // 切换模式
                    isEnglish = !isEnglish;
                    
                    // 更改按钮显示
                    const languageText = document.getElementById('languageText');
                    if (languageText) {
                        languageText.textContent = isEnglish ? '中文' : 'English';
                } else {
                        languageBtn.innerHTML = isEnglish ? 
                            '<i class="fas fa-language"></i> 中文' : 
                            '<i class="fas fa-language"></i> English';
                    }
                    
                    // 获取所有语言元素
                    const zhElements = document.querySelectorAll('[data-lang="zh"]');
                    const enElements = document.querySelectorAll('[data-lang="en"]');
                    
                    // 根据模式显示/隐藏元素
                    zhElements.forEach(el => {
                        el.style.display = isEnglish ? 'none' : '';
                    });
                    
                    enElements.forEach(el => {
                        el.style.display = isEnglish ? '' : 'none';
                    });
                    
                    // 更新特殊元素，如出生地点和性别
                    const birthPlaceElement = document.getElementById('birth-place');
                    if (birthPlaceElement) {
                        // 获取中英文地点信息
                        const zhPlace = birthPlaceElement.getAttribute('data-zh') || birthPlaceElement.textContent;
                        const enPlace = birthPlaceElement.getAttribute('data-en') || zhPlace;
                        
                        // 保存原始值
                        if (!birthPlaceElement.hasAttribute('data-zh')) {
                            birthPlaceElement.setAttribute('data-zh', zhPlace);
                        }
                        if (!birthPlaceElement.hasAttribute('data-en')) {
                            birthPlaceElement.setAttribute('data-en', enPlace);
                        }
                        
                        // 根据当前语言模式设置文本
                        birthPlaceElement.textContent = isEnglish ? enPlace : zhPlace;
                    }

                    // 更新性别显示
                    const genderElement = document.getElementById('user-gender');
                    if (genderElement) {
                        const zhGender = genderElement.textContent;
                        const enGender = genderTranslations[zhGender] || zhGender;
                        
                        if (!genderElement.hasAttribute('data-zh')) {
                            genderElement.setAttribute('data-zh', zhGender);
                        }
                        if (!genderElement.hasAttribute('data-en')) {
                            genderElement.setAttribute('data-en', enGender);
                        }
                        
                        genderElement.textContent = isEnglish ? enGender : zhGender;
                    }
                    
                    // 处理出生时间的显示
                    const birthTimeElement = document.getElementById('birth-time');
                    if (birthTimeElement) {
                        if (!birthTimeElement.hasAttribute('data-zh')) {
                            birthTimeElement.setAttribute('data-zh', birthTimeElement.textContent);
                            // 转换时间格式为英文
                            const timeText = birthTimeElement.textContent;
                            birthTimeElement.setAttribute('data-en', timeText);
                        }
                        birthTimeElement.textContent = isEnglish ? 
                            birthTimeElement.getAttribute('data-en') : 
                            birthTimeElement.getAttribute('data-zh');
                    }
                    
                    // 处理生肖的中英文转换
                    const shengxiaoElement = document.getElementById('shengxiao');
                    if (shengxiaoElement) {
                        // 如果是第一次切换，保存中文生肖
                        if (!shengxiaoElement.hasAttribute('data-zh')) {
                            shengxiaoElement.setAttribute('data-zh', shengxiaoElement.textContent);
                        }
                        
                        // 获取中文生肖
                        const zhZodiac = shengxiaoElement.getAttribute('data-zh');
                        
                        // 转换并显示
                        if (isEnglish && zhZodiac && zodiacMap[zhZodiac]) {
                            shengxiaoElement.textContent = zodiacMap[zhZodiac];
                        } else if (!isEnglish && zhZodiac) {
                            shengxiaoElement.textContent = zhZodiac;
                        }
                    }

                    // 处理日期的中英文转换
                    const solarDateElement = document.getElementById('solar-date');
                    const lunarDateElement = document.getElementById('lunar-date');

                    if (solarDateElement) {
                        if (!solarDateElement.hasAttribute('data-zh')) {
                            const originalText = solarDateElement.textContent.trim();
                            solarDateElement.setAttribute('data-zh', originalText);
                            // 转换日期格式为英文
                            const dateParts = originalText.split(' ');
                            if (dateParts.length >= 2) {
                                const dateStr = dateParts[0];
                                const timeStr = dateParts[1];
                                try {
                                    const date = new Date(dateStr);
                                    if (!isNaN(date.getTime())) {
                                        const options = { year: 'numeric', month: 'long', day: 'numeric' };
                                        const englishDate = date.toLocaleDateString('en-US', options);
                                        solarDateElement.setAttribute('data-en', `${englishDate} ${timeStr}`);
                                    }
                                } catch (error) {
                                    console.error('Error converting date:', error);
                                }
                            }
                        }
                        const targetAttr = isEnglish ? 'data-en' : 'data-zh';
                        if (solarDateElement.hasAttribute(targetAttr)) {
                            solarDateElement.textContent = solarDateElement.getAttribute(targetAttr);
                        }
                    }

                    if (lunarDateElement) {
                        if (!lunarDateElement.hasAttribute('data-zh')) {
                            lunarDateElement.setAttribute('data-zh', lunarDateElement.textContent);
                            // 转换农历日期为英文格式
                            const lunarText = lunarDateElement.textContent;
                            const englishText = lunarText
                                .replace('年', ' Year ')
                                .replace('月', ' Month ')
                                .replace('日', ' Day ')
                                .replace('时', ' Hour');
                            lunarDateElement.setAttribute('data-en', englishText);
                        }
                        lunarDateElement.textContent = isEnglish ? 
                            lunarDateElement.getAttribute('data-en') : 
                            lunarDateElement.getAttribute('data-zh');
                    }
                    
                    console.log('语言已切换为:', isEnglish ? '英文' : '中文');
                });
                
                console.log('语言切换功能初始化完成');
            } catch (error) {
                console.error('设置语言切换功能出错:', error);
                showError('设置语言切换功能时出错: ' + error.message);
            }
        }
        
        // 确保页面已加载完成
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // 获取URL参数
                const urlParams = new URLSearchParams(window.location.search);
                const analysisId = urlParams.get('id');
                
                let analysisData, userData;
                
                // 尝试通过ID获取数据
                if (analysisId) {
                    const analysisKey = `bazi_analysis_${analysisId}`;
                    const userDataKey = `user_data_${analysisId}`;
                    
                    const savedAnalysis = localStorage.getItem(analysisKey);
                    const savedUserData = localStorage.getItem(userDataKey);
                    
                    if (savedAnalysis && savedUserData) {
                        analysisData = JSON.parse(savedAnalysis);
                        userData = JSON.parse(savedUserData);
                        console.log('通过ID加载数据成功');
                    }
                }
                
                // 如果通过ID没有找到数据，尝试使用通用键
                if (!analysisData || !userData) {
                    const savedAnalysis = localStorage.getItem('baziAnalysisData');
                    const savedUserData = localStorage.getItem('baziUserData');
                    
                    if (savedAnalysis && savedUserData) {
                        analysisData = JSON.parse(savedAnalysis);
                        userData = JSON.parse(savedUserData);
                        console.log('通过通用键加载数据成功');
                    }
                }
                
                // 如果仍未找到数据，显示错误
                if (!analysisData || !userData) {
                    console.error('无法加载分析数据');
                    return;
                }
                
                console.log('===== 数据调试信息 =====');
                console.log('用户数据:', userData);
                console.log('用户国家:', userData.country);
                console.log('用户省份:', userData.province);
                
                // 确保出生地信息正确显示
                if (userData.country && userData.province) {
                    const birthPlace = userData.country + ' ' + userData.province;
                    const birthPlaceElement = document.getElementById('birth-place');
                    if (birthPlaceElement) {
                        birthPlaceElement.textContent = birthPlace;
                        console.log('已更新出生地信息:', birthPlace);
                    } else {
                        console.error('找不到birth-place元素');
                    }
                } else {
                    console.warn('国家或省份信息不完整', userData.country, userData.province);
                }
                
                console.log('数据加载检查完成');
            } catch (error) {
                console.error('数据加载检查错误:', error);
            }
        });

        // 定义界面翻译对象
        const uiTranslations = {
            'basicInfo': {
                'zh': '基本信息',
                'en': 'Basic Information'
            },
            'name': {
                'zh': '姓名',
                'en': 'Name'
            },
            'gender': {
                'zh': '性别',
                'en': 'Gender'
            },
            'birthPlace': {
                'zh': '出生地',
                'en': 'Birth Place'
            },
            'solarDate': {
                'zh': '阳历',
                'en': 'Solar Calendar'
            },
            'lunarDate': {
                'zh': '农历',
                'en': 'Lunar Calendar'
            },
            'zodiac': {
                'zh': '生肖',
                'en': 'Zodiac'
            },
            'unknownTimeNote': {
                'zh': '时辰不确定，使用午时（11:00-13:00）推算，结果仅供参考',
                'en': 'Birth time is uncertain, using 11:00-13:00 for calculation, results are for reference only'
            },
            'loading': {
                'zh': '加载中...',
                'en': 'Loading...'
            },
            'male': {
                'zh': '男',
                'en': 'Male'
            },
            'female': {
                'zh': '女',
                'en': 'Female'
            },
            
            // 五行属性翻译
            'wood': {
                'zh': '木',
                'en': 'Wood'
            },
            'fire': {
                'zh': '火',
                'en': 'Fire'
            },
            'earth': {
                'zh': '土',
                'en': 'Earth'
            },
            'metal': {
                'zh': '金',
                'en': 'Metal'
            },
            'water': {
                'zh': '水',
                'en': 'Water'
            }
        };

        // 全局语言切换函数
        window.toggleLanguage = function() {
            console.log('执行语言切换');
            const isCurrentlyEnglish = document.querySelector('[data-lang="en"]').style.display !== 'none';
            const newLanguage = isCurrentlyEnglish ? 'zh' : 'en';
            
            // 切换语言显示
            document.querySelectorAll('[data-lang="zh"], [data-lang="en"]').forEach(el => {
                if (el.getAttribute('data-lang') === newLanguage) {
                    el.style.display = '';
                } else {
                    el.style.display = 'none';
                }
            });
            
            // 更新按钮文本
            const languageText = document.getElementById('languageText');
            if (languageText) {
                languageText.textContent = isCurrentlyEnglish ? 'English' : '中文';
            }
            
            // 保存当前语言设置到localStorage
            localStorage.setItem('language', newLanguage);

            // 从localStorage获取分析数据并重新显示
            const analysisData = localStorage.getItem('analysisData');
            if (analysisData) {
                const analysis = JSON.parse(analysisData);
                displayAnalysis(analysis);
            }

            // 更新五行分析内容
            const elementAnalysisContainer = document.getElementById('element-analysis');
            if (elementAnalysisContainer) {
                const elements = ['Wood', 'Fire', 'Earth', 'Metal', 'Water'];
                elementAnalysisContainer.innerHTML = elements.map(element => generateElementAnalysis(element, analysis)).join('');
            }

            // 更新个性化建议
            const personalizedAdviceContainer = document.getElementById('personalized-advice');
            if (personalizedAdviceContainer) {
                const dayMasterElement = localStorage.getItem('dayMasterElement');
                const elementStrength = parseFloat(localStorage.getItem('elementStrength'));
                if (dayMasterElement && !isNaN(elementStrength)) {
                    personalizedAdviceContainer.innerHTML = generatePersonalizedAdvice(dayMasterElement, elementStrength, analysis);
                }
            }
            
            console.log('语言已切换为:', newLanguage);
        };

        // ... existing code ...
        // 获取当前语言设置
        function getCurrentLanguage() {
            return document.querySelector('[data-lang="en"]').style.display !== 'none' ? 'en' : 'zh';
        }

        // 生成五行分析内容
        function generateElementAnalysis(element, analysis) {
            const lang = getCurrentLanguage();
            const elementKey = element.toLowerCase();
            
            return `
                <div class="element-analysis">
                    <h3>${analysis[lang].elements[elementKey].name} ${analysis[lang].elements[elementKey].characteristics}</h3>
                    <p>${analysis[lang].elements[elementKey].description}</p>
                    
                    <h3>${analysis[lang].elements[elementKey].advantages.title}</h3>
                    <p>${analysis[lang].elements[elementKey].advantages.content}</p>
                    
                    <h3>${analysis[lang].elements[elementKey].suggestions.title}</h3>
                    <p>${analysis[lang].elements[elementKey].suggestions.content}</p>
                    
                    <h3>${analysis[lang].elements[elementKey].precautions.title}</h3>
                    <p>${analysis[lang].elements[elementKey].precautions.content}</p>
                    
                    <h3>${analysis[lang].elements[elementKey].health.title}</h3>
                    <p>${analysis[lang].elements[elementKey].health.content}</p>
                </div>
            `;
        }

        // 生成个性化五行平衡建议
        function generatePersonalizedAdvice(dayMasterElement, elementStrength, analysis) {
            const lang = getCurrentLanguage();
            const elementKey = dayMasterElement.toLowerCase();
            
            let status = '';
            if (elementStrength > 30) {
                status = analysis[lang].status.strong;
            } else if (elementStrength < 15) {
                status = analysis[lang].status.weak;
            } else {
                status = analysis[lang].status.balanced;
            }
            
            return `
                <div class="personalized-advice">
                    <h3>${analysis[lang].dayMaster.title}</h3>
                    <p>${status}，${analysis[lang].dayMaster.element}(${analysis[lang].elements[elementKey].name})${analysis[lang].dayMaster.strength}${elementStrength > 30 ? analysis[lang].dayMaster.strong : elementStrength < 15 ? analysis[lang].dayMaster.weak : analysis[lang].dayMaster.balanced}。</p>
                    
                    ${elementStrength > 30 ? `
                        <p>${analysis[lang].dayMaster.supplement}：${analysis[lang].elements[getControllingElement(elementKey)].name}，${analysis[lang].dayMaster.balance}。</p>
                        <p>${analysis[lang].dayMaster.avoid}。</p>
                    ` : elementStrength < 15 ? `
                        <p>${analysis[lang].dayMaster.supplement}：${analysis[lang].elements[elementKey].name} ${analysis[lang].dayMaster.or} ${analysis[lang].elements[getGeneratingElement(elementKey)].name}，${analysis[lang].dayMaster.enhance}。</p>
                    ` : ''}
                </div>
            `;
        }

        // 更新五行分析内容
        function updateElementAnalysis(analysis) {
            const elementAnalysisContainer = document.getElementById('element-analysis');
            if (elementAnalysisContainer) {
                // 生成所有五行的分析
                const elements = ['Wood', 'Fire', 'Earth', 'Metal', 'Water'];
                elementAnalysisContainer.innerHTML = elements.map(element => generateElementAnalysis(element, analysis)).join('');
            }
        }

        // 更新个性化建议
        function updatePersonalizedAdvice(dayMasterElement, elementStrength, analysis) {
            const personalizedAdviceContainer = document.getElementById('personalized-advice');
            if (personalizedAdviceContainer) {
                personalizedAdviceContainer.innerHTML = generatePersonalizedAdvice(dayMasterElement, elementStrength, analysis);
            }
        }

        // 修改displayAnalysis函数中的相关调用
        function displayAnalysis(analysis) {
            if (!analysis) return;
            const currentLang = getCurrentLanguage();
            const data = analysis[currentLang];
            
            // 确保data和basicInfo存在
            if (!data || !data.basicInfo) return;
            
            // 显示基本信息
            document.getElementById('name').textContent = data.basicInfo.name || '';
            document.getElementById('gender').textContent = data.basicInfo.gender || '';
            document.getElementById('birthPlace').textContent = data.basicInfo.birthPlace || '';
            document.getElementById('solarDate').textContent = data.basicInfo.solarDate || '';
            document.getElementById('lunarDate').textContent = data.basicInfo.lunarDate || '';
            document.getElementById('zodiac').textContent = data.basicInfo.zodiac || '';
            document.getElementById('birthTime').textContent = data.basicInfo.birthTime || '';
            
            // 显示八字分析
            if (data.baziAnalysis) {
                document.getElementById('dayMaster').textContent = data.baziAnalysis.dayMaster || '';
                document.getElementById('elementStrength').textContent = data.baziAnalysis.elementStrength || '';
            }
            
            // 更新五行分析内容
            const elementAnalysisContainer = document.getElementById('element-analysis');
            if (elementAnalysisContainer && data.elementAnalysis) {
                const elements = ['Wood', 'Fire', 'Earth', 'Metal', 'Water'];
                elementAnalysisContainer.innerHTML = elements.map(element => generateElementAnalysis(element, analysis)).join('');
            }
            
            // 更新个性化建议
            const personalizedAdviceContainer = document.getElementById('personalized-advice');
            if (personalizedAdviceContainer) {
                const dayMasterElement = data.baziAnalysis.dayMaster;
                const elementStrength = parseFloat(data.baziAnalysis.elementStrength);
                if (dayMasterElement && !isNaN(elementStrength)) {
                    personalizedAdviceContainer.innerHTML = generatePersonalizedAdvice(dayMasterElement, elementStrength, analysis);
                }
            }
        }

        // ... existing code ...
        function generateElementAnalysisStructure() {
            return {
                zh: {
                    elements: {
                        wood: {
                            name: '木',
                            nameEn: 'Wood',
                            characteristics: '特性',
                            characteristicsEn: 'Characteristics',
                            description: '木性温和，具有生长、向上、伸展的特性。代表春天、东方、绿色。',
                            descriptionEn: 'Wood is gentle and represents growth, upward movement, and expansion. Associated with spring, east, and green.',
                            advantages: {
                                title: '优势',
                                titleEn: 'Advantages',
                                content: '具有创造力、适应力强、善于规划、有领导才能。',
                                contentEn: 'Creative, adaptable, good at planning, leadership qualities.'
                            },
                            suggestions: {
                                title: '建议',
                                titleEn: 'Suggestions',
                                content: '适合从事创意、教育、环保等行业，多接触自然。',
                                contentEn: 'Suitable for creative, educational, and environmental industries. Stay connected with nature.'
                            },
                            precautions: {
                                title: '注意事项',
                                titleEn: 'Precautions',
                                content: '避免过于固执，注意情绪管理，保持灵活性。',
                                contentEn: 'Avoid being too stubborn, manage emotions, maintain flexibility.'
                            },
                            health: {
                                title: '健康重点',
                                titleEn: 'Health Focus',
                                content: '注意肝胆系统，保持运动习惯，调节作息。',
                                contentEn: 'Pay attention to liver and gallbladder system, maintain exercise habits, regulate rest.'
                            }
                        },
                        fire: {
                            name: '火',
                            characteristics: '特性',
                            description: '火性热烈，具有温暖、光明、活跃的特性。代表夏天、南方、红色。',
                            advantages: {
                                title: '优势',
                                content: '热情开朗、行动力强、善于表达、富有感染力。'
                            },
                            suggestions: {
                                title: '建议',
                                content: '适合从事销售、演艺、餐饮等行业，保持活力。'
                            },
                            precautions: {
                                title: '注意事项',
                                content: '避免冲动，注意情绪控制，保持耐心。'
                            },
                            health: {
                                title: '健康重点',
                                content: '注意心血管系统，保持充足睡眠，调节饮食。'
                            }
                        },
                        earth: {
                            name: '土',
                            characteristics: '特性',
                            description: '土性稳重，具有包容、承载、安定的特性。代表四季、中央、黄色。',
                            advantages: {
                                title: '优势',
                                content: '踏实稳重、责任心强、善于积累、注重实际。'
                            },
                            suggestions: {
                                title: '建议',
                                content: '适合从事房地产、农业、金融等行业，注重积累。'
                            },
                            precautions: {
                                title: '注意事项',
                                content: '避免过于保守，注意开拓创新，保持进取。'
                            },
                            health: {
                                title: '健康重点',
                                content: '注意消化系统，保持规律作息，适度运动。'
                            }
                        },
                        metal: {
                            name: '金',
                            characteristics: '特性',
                            description: '金性刚强，具有坚韧、果断、公正的特性。代表秋天、西方、白色。',
                            advantages: {
                                title: '优势',
                                content: '意志坚定、原则性强、善于决策、注重公平。'
                            },
                            suggestions: {
                                title: '建议',
                                content: '适合从事法律、珠宝、机械等行业，注重规范。'
                            },
                            precautions: {
                                title: '注意事项',
                                content: '避免过于固执，注意变通，保持开放。'
                            },
                            health: {
                                title: '健康重点',
                                content: '注意呼吸系统，保持良好心态，适度放松。'
                            }
                        },
                        water: {
                            name: '水',
                            characteristics: '特性',
                            description: '水性灵活，具有流动、适应、智慧的特性。代表冬天、北方、黑色。',
                            advantages: {
                                title: '优势',
                                content: '思维敏捷、适应力强、善于沟通、富有智慧。'
                            },
                            suggestions: {
                                title: '建议',
                                content: '适合从事科技、传媒、贸易等行业，保持创新。'
                            },
                            precautions: {
                                title: '注意事项',
                                content: '避免过于随性，注意坚持，保持稳定。'
                            },
                            health: {
                                title: '健康重点',
                                content: '注意泌尿系统，保持良好作息，调节情绪。'
                            }
                        }
                    },
                    status: {
                        strong: '较强',
                        strongEn: 'Strong',
                        weak: '较弱',
                        weakEn: 'Weak',
                        balanced: '平衡',
                        balancedEn: 'Balanced'
                    },
                    dayMaster: {
                        title: '日主状态',
                        titleEn: 'Day Master Status',
                        element: '日主五行',
                        elementEn: 'Day Master Element',
                        strength: '能量',
                        strengthEn: 'Energy',
                        supplement: '补充建议',
                        supplementEn: 'Supplementary Advice',
                        avoid: '需要避免',
                        avoidEn: 'Need to Avoid',
                        or: '或',
                        orEn: 'or',
                        balance: '有助于平衡能量',
                        balanceEn: 'Helps Balance Energy',
                        enhance: '有助于增强能量',
                        enhanceEn: 'Helps Enhance Energy'
                    }
                },
                en: {
                    elements: {
                        wood: {
                            name: 'Wood',
                            characteristics: 'Characteristics',
                            description: 'Wood is gentle and represents growth, upward movement, and expansion. Associated with spring, east, and green.',
                            advantages: {
                                title: 'Advantages',
                                content: 'Creative, adaptable, good at planning, leadership qualities.'
                            },
                            suggestions: {
                                title: 'Suggestions',
                                content: 'Suitable for creative, educational, and environmental industries. Stay connected with nature.'
                            },
                            precautions: {
                                title: 'Precautions',
                                content: 'Avoid being too stubborn, manage emotions, maintain flexibility.'
                            },
                            health: {
                                title: 'Health Focus',
                                content: 'Pay attention to liver and gallbladder system, maintain exercise habits, regulate sleep.'
                            }
                        },
                        fire: {
                            name: 'Fire',
                            characteristics: 'Characteristics',
                            description: 'Fire is passionate and represents warmth, light, and activity. Associated with summer, south, and red.',
                            advantages: {
                                title: 'Advantages',
                                content: 'Enthusiastic, action-oriented, good at expression, charismatic.'
                            },
                            suggestions: {
                                title: 'Suggestions',
                                content: 'Suitable for sales, entertainment, and food industries. Maintain vitality.'
                            },
                            precautions: {
                                title: 'Precautions',
                                content: 'Avoid impulsiveness, control emotions, maintain patience.'
                            },
                            health: {
                                title: 'Health Focus',
                                content: 'Pay attention to cardiovascular system, maintain adequate sleep, regulate diet.'
                            }
                        },
                        earth: {
                            name: 'Earth',
                            characteristics: 'Characteristics',
                            description: 'Earth is stable and represents containment, support, and stability. Associated with all seasons, center, and yellow.',
                            advantages: {
                                title: 'Advantages',
                                content: 'Steady, responsible, good at accumulation, practical.'
                            },
                            suggestions: {
                                title: 'Suggestions',
                                content: 'Suitable for real estate, agriculture, and finance industries. Focus on accumulation.'
                            },
                            precautions: {
                                title: 'Precautions',
                                content: 'Avoid being too conservative, maintain innovation, stay progressive.'
                            },
                            health: {
                                title: 'Health Focus',
                                content: 'Pay attention to digestive system, maintain regular schedule, moderate exercise.'
                            }
                        },
                        metal: {
                            name: 'Metal',
                            characteristics: 'Characteristics',
                            description: 'Metal is strong and represents determination, decisiveness, and justice. Associated with autumn, west, and white.',
                            advantages: {
                                title: 'Advantages',
                                content: 'Strong will, principled, good at decision-making, fair-minded.'
                            },
                            suggestions: {
                                title: 'Suggestions',
                                content: 'Suitable for legal, jewelry, and mechanical industries. Focus on standards.'
                            },
                            precautions: {
                                title: 'Precautions',
                                content: 'Avoid being too rigid, maintain flexibility, stay open-minded.'
                            },
                            health: {
                                title: 'Health Focus',
                                content: 'Pay attention to respiratory system, maintain good mindset, moderate relaxation.'
                            }
                        },
                        water: {
                            name: 'Water',
                            characteristics: 'Characteristics',
                            description: 'Water is flexible and represents flow, adaptation, and wisdom. Associated with winter, north, and black.',
                            advantages: {
                                title: 'Advantages',
                                content: 'Quick thinking, adaptable, good at communication, wise.'
                            },
                            suggestions: {
                                title: 'Suggestions',
                                content: 'Suitable for technology, media, and trade industries. Maintain innovation.'
                            },
                            precautions: {
                                title: 'Precautions',
                                content: 'Avoid being too casual, maintain persistence, stay stable.'
                            },
                            health: {
                                title: 'Health Focus',
                                content: 'Pay attention to urinary system, maintain good schedule, regulate emotions.'
                            }
                        }
                    },
                    status: {
                        strong: 'Strong',
                        weak: 'Weak',
                        balanced: 'Balanced'
                    },
                    dayMaster: {
                        title: 'Day Master Status',
                        element: 'Day Master Element',
                        strength: 'Energy',
                        supplement: 'Supplement Suggestion',
                        avoid: 'Need to Avoid',
                        or: 'or',
                        balance: 'helps balance energy',
                        enhance: 'helps enhance energy'
                    }
                }
            };
        }

        // ... existing code ...
        // 生成分析结果
        function generateAnalysis(data) {
            const elementAnalysis = generateElementAnalysisStructure();
            
            const analysis = {
                zh: {
                    basicInfo: {
                        name: data.name,
                        gender: data.gender === 'male' ? '男' : '女',
                        birthPlace: data.birthPlace,
                        solarDate: data.solarDate,
                        lunarDate: data.lunarDate,
                        zodiac: data.zodiac,
                        birthTime: data.birthTime || '未知'
                    },
                    baziAnalysis: {
                        dayMaster: data.dayMaster,
                        elementStrength: data.elementStrength,
                        // ... 其他中文内容
                    },
                    ...elementAnalysis.zh
                },
                en: {
                    basicInfo: {
                        name: data.name,
                        gender: data.gender === 'male' ? 'Male' : 'Female',
                        birthPlace: data.birthPlace,
                        solarDate: data.solarDate,
                        lunarDate: data.lunarDate,
                        zodiac: data.zodiac,
                        birthTime: data.birthTime || 'Unknown'
                    },
                    baziAnalysis: {
                        dayMaster: data.dayMaster,
                        elementStrength: data.elementStrength,
                        // ... 其他英文内容
                    },
                    ...elementAnalysis.en
                }
            };
            return analysis;
        }

        // ... existing code ...
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 从localStorage获取分析数据
            const analysisData = localStorage.getItem('baziAnalysisData');
            if (analysisData) {
                const analysis = JSON.parse(analysisData);
                displayAnalysis(analysis);
            }
        });
    </script>
</body>
</html>